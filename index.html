<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FitLife Tracker | Diet + Workout</title>
    <meta name="description" content="Track your diet, workouts, water intake, and fitness goals with FitLife Tracker - your unified health companion.">

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="apple-touch-icon" href="favicon.svg">

    <!-- Open Graph / Social Media Sharing -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="FitLife Tracker | Diet + Workout">
    <meta property="og:description" content="Track your diet, workouts, water intake, and fitness goals with FitLife Tracker.">
    <meta property="og:image" content="https://codesoft.co.in/fitlife/favicon.svg">
    <meta property="og:url" content="https://codesoft.co.in/fitlife/">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="FitLife Tracker | Diet + Workout">
    <meta name="twitter:description" content="Track your diet, workouts, water intake, and fitness goals.">
    <meta name="twitter:image" content="https://codesoft.co.in/fitlife/favicon.svg">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'display': ['Playfair Display', 'serif'],
                        'sans': ['DM Sans', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        .glass-effect {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .card-hover { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 24px rgba(59, 130, 246, 0.12);
        }
        .macro-ring {
            transition: stroke-dashoffset 0.5s ease;
        }
        .streak-fire { animation: fireFlicker 0.5s ease-in-out infinite alternate; }
        @keyframes fireFlicker {
            0% { transform: scale(1) rotate(-3deg); }
            100% { transform: scale(1.1) rotate(3deg); }
        }
        .tab-active {
            background: linear-gradient(135deg, #3B82F6 0%, #6366F1 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
        }
        .workout-gradient {
            background: linear-gradient(135deg, #F97316 0%, #EA580C 100%);
        }
        .food-item:hover { background: #f0f9ff; }
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3B82F6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .pulse-dot {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .water-fill { transition: height 0.5s cubic-bezier(0.4, 0, 0.2, 1); }

        /* Water Wave Animation */
        .water-container {
            position: relative;
            overflow: hidden;
            border-radius: 1rem;
            background: linear-gradient(to right, #ecfeff, #eff6ff);
            min-height: 70px;
        }
        .water-waves {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 0%;
            transition: height 0.5s ease-out;
            overflow: hidden;
        }
        .water-waves svg {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 200%;
            height: 100%;
            min-height: 70px;
        }
        .wave-back {
            animation: waveMove 3s linear infinite;
            fill: rgba(6, 182, 212, 0.3);
        }
        .wave-front {
            animation: waveMove 2s linear infinite reverse;
            fill: rgba(56, 189, 248, 0.4);
        }
        @keyframes waveMove {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); }
        }
        .water-waves.animating .wave-back,
        .water-waves.animating .wave-front {
            animation-duration: 0.5s;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 via-sky-50 to-indigo-50 min-h-screen p-4 md:p-6 font-sans">

    <!-- Connection Status Banner -->
    <div id="connectionBanner" class="hidden fixed top-0 left-0 right-0 bg-amber-500 text-white text-center py-2 text-sm z-50">
        <span class="pulse-dot inline-block w-2 h-2 bg-white rounded-full mr-2"></span>
        Connecting to server...
    </div>

    <div class="max-w-7xl mx-auto">

        <!-- Header -->
        <header class="mb-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <svg width="40" height="40" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" class="drop-shadow-lg">
                        <circle cx="32" cy="32" r="30" fill="#2563EB" />
                        <rect x="14" y="22" width="8" height="20" rx="2" fill="white" />
                        <rect x="42" y="22" width="8" height="20" rx="2" fill="white" />
                        <rect x="18" y="30" width="28" height="4" rx="1" fill="white" />
                        <path d="M32 32 Q 40 20, 44 28 T 32 40 Q 24 40, 24 32 T 32 32" fill="#F76A1E" />
                    </svg>
                    <h1 class="font-display text-2xl md:text-3xl font-bold text-blue-800">FitLife Tracker</h1>
                </div>
                <div class="flex items-center gap-2">
                    <!-- Streak Badge -->
                    <div class="bg-gradient-to-r from-orange-500 to-red-500 text-white px-3 py-1.5 rounded-full shadow-lg shadow-orange-500/30 flex items-center gap-1.5" id="streakBadge">
                        <span class="text-base streak-fire">üî•</span>
                        <span class="font-bold text-sm" id="streakCount">0</span>
                    </div>
                    <!-- Settings Button -->
                    <button onclick="openGoalsModal()" class="w-10 h-10 rounded-full bg-slate-100 hover:bg-slate-200 flex items-center justify-center transition-all edit-only" title="Settings">
                        <svg class="w-5 h-5 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </header>

        <!-- Motivation Banner -->
        <div id="motivationBanner" class="rounded-3xl overflow-hidden shadow-xl mb-6 relative">
            <img id="motiveImage" src="images/push.webp" alt="Motivation" class="w-full h-auto">
            <!-- Workout badge top-right -->
            <div class="absolute top-3 right-3">
                <div class="px-3 py-1.5 rounded-full text-xs font-semibold bg-black/40 backdrop-blur-sm text-white" id="motiveWorkout">
                    üí™ Push + Core
                </div>
            </div>
        </div>

        <!-- Macro Tracker Widget -->
        <div class="bg-white rounded-3xl p-5 shadow-sm mb-6" id="macroWidget">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h2 class="font-display text-lg font-semibold text-slate-800">üìä Today's Progress</h2>
                    <div class="text-sm text-slate-400" id="todayDate">Loading...</div>
                </div>
                <div class="flex items-center gap-4">
                    <div class="text-sm font-medium text-orange-500" id="caloriesBurnt" title="Calories burnt from workout">
                        üî• <span id="burntCalories">0</span> burnt
                    </div>
                    <div class="text-sm font-medium">
                        <span class="text-rose-500" id="totalCalories">0</span>
                        <span class="text-slate-400">/</span>
                        <span class="text-slate-600" id="goalCalories">1300</span>
                        <span class="text-slate-400">kcal</span>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-3 md:grid-cols-5 gap-3">
                <!-- Protein -->
                <div class="text-center">
                    <div class="relative inline-block">
                        <svg class="w-16 h-16 md:w-20 md:h-20 transform -rotate-90">
                            <circle cx="50%" cy="50%" r="35%" stroke="#f1f5f9" stroke-width="6" fill="none"/>
                            <circle id="proteinRing" cx="50%" cy="50%" r="35%" stroke="#f59e0b" stroke-width="6" fill="none"
                                    stroke-dasharray="220" stroke-dashoffset="220" stroke-linecap="round" class="macro-ring"/>
                        </svg>
                        <div class="absolute inset-0 flex items-center justify-center">
                            <span class="text-xl md:text-2xl">ü•©</span>
                        </div>
                    </div>
                    <div class="mt-1">
                        <div class="font-bold text-amber-600 text-sm"><span id="proteinCurrent">0</span>g</div>
                        <div class="text-xs text-slate-400">/ <span id="proteinGoal">80</span>g</div>
                    </div>
                </div>

                <!-- Carbs -->
                <div class="text-center">
                    <div class="relative inline-block">
                        <svg class="w-16 h-16 md:w-20 md:h-20 transform -rotate-90">
                            <circle cx="50%" cy="50%" r="35%" stroke="#f1f5f9" stroke-width="6" fill="none"/>
                            <circle id="carbsRing" cx="50%" cy="50%" r="35%" stroke="#3b82f6" stroke-width="6" fill="none"
                                    stroke-dasharray="220" stroke-dashoffset="220" stroke-linecap="round" class="macro-ring"/>
                        </svg>
                        <div class="absolute inset-0 flex items-center justify-center">
                            <span class="text-xl md:text-2xl">üçö</span>
                        </div>
                    </div>
                    <div class="mt-1">
                        <div class="font-bold text-blue-600 text-sm"><span id="carbsCurrent">0</span>g</div>
                        <div class="text-xs text-slate-400">/ <span id="carbsGoal">180</span>g</div>
                    </div>
                </div>

                <!-- Fat -->
                <div class="text-center">
                    <div class="relative inline-block">
                        <svg class="w-16 h-16 md:w-20 md:h-20 transform -rotate-90">
                            <circle cx="50%" cy="50%" r="35%" stroke="#f1f5f9" stroke-width="6" fill="none"/>
                            <circle id="fatRing" cx="50%" cy="50%" r="35%" stroke="#ec4899" stroke-width="6" fill="none"
                                    stroke-dasharray="220" stroke-dashoffset="220" stroke-linecap="round" class="macro-ring"/>
                        </svg>
                        <div class="absolute inset-0 flex items-center justify-center">
                            <span class="text-xl md:text-2xl">üßà</span>
                        </div>
                    </div>
                    <div class="mt-1">
                        <div class="font-bold text-pink-500 text-sm"><span id="fatCurrent">0</span>g</div>
                        <div class="text-xs text-slate-400">/ <span id="fatGoal">45</span>g</div>
                    </div>
                </div>

                <!-- Fiber -->
                <div class="text-center">
                    <div class="relative inline-block">
                        <svg class="w-16 h-16 md:w-20 md:h-20 transform -rotate-90">
                            <circle cx="50%" cy="50%" r="35%" stroke="#f1f5f9" stroke-width="6" fill="none"/>
                            <circle id="fiberRing" cx="50%" cy="50%" r="35%" stroke="#10b981" stroke-width="6" fill="none"
                                    stroke-dasharray="220" stroke-dashoffset="220" stroke-linecap="round" class="macro-ring"/>
                        </svg>
                        <div class="absolute inset-0 flex items-center justify-center">
                            <span class="text-xl md:text-2xl">ü•¨</span>
                        </div>
                    </div>
                    <div class="mt-1">
                        <div class="font-bold text-emerald-500 text-sm"><span id="fiberCurrent">0</span>g</div>
                        <div class="text-xs text-slate-400">/ <span id="fiberGoal">25</span>g</div>
                    </div>
                </div>

                <!-- Water -->
                <div class="text-center">
                    <div class="relative inline-block">
                        <svg class="w-16 h-16 md:w-20 md:h-20 transform -rotate-90">
                            <circle cx="50%" cy="50%" r="35%" stroke="#f1f5f9" stroke-width="6" fill="none"/>
                            <circle id="waterRing" cx="50%" cy="50%" r="35%" stroke="#06b6d4" stroke-width="6" fill="none"
                                    stroke-dasharray="220" stroke-dashoffset="220" stroke-linecap="round" class="macro-ring"/>
                        </svg>
                        <div class="absolute inset-0 flex items-center justify-center">
                            <span class="text-xl md:text-2xl">üíß</span>
                        </div>
                    </div>
                    <div class="mt-1">
                        <div class="font-bold text-cyan-600 text-sm"><span id="waterCurrentMl">0</span>ml</div>
                        <div class="text-xs text-slate-400">/ 2000ml</div>
                    </div>
                </div>
            </div>

            <!-- Calorie Progress Bar -->
            <div class="mt-4">
                <div class="h-3 bg-slate-100 rounded-full overflow-hidden">
                    <div id="calorieBar" class="h-full bg-gradient-to-r from-rose-400 to-rose-500 rounded-full transition-all duration-500" style="width: 0%"></div>
                </div>
                <div class="flex justify-between text-xs text-slate-400 mt-1">
                    <span>0</span>
                    <span id="caloriePercent">0% of daily goal</span>
                    <span id="goalCaloriesLabel">1300</span>
                </div>
            </div>

            <!-- Macro Advisor -->
            <div id="macroAdvisorSection" class="mt-4 pt-4 border-t border-slate-100">
                <div class="flex items-center gap-2 mb-2">
                    <span class="text-base">üß†</span>
                    <span class="font-semibold text-slate-700 text-sm">Macro Advisor</span>
                </div>
                <div id="macroAdvisorContent" class="text-sm text-slate-600">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>

        <!-- Week Navigation -->
        <div class="bg-white rounded-2xl p-4 shadow-sm mb-6">
            <div class="flex items-center justify-between mb-4">
                <button onclick="changeWeek(-1)" class="p-2 hover:bg-slate-100 rounded-lg transition-all">
                    <svg class="w-5 h-5 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                </button>
                <div class="text-center">
                    <div class="text-sm text-slate-400">Week of</div>
                    <div class="font-semibold text-slate-700" id="weekRangeDisplay">Loading...</div>
                </div>
                <button onclick="changeWeek(1)" class="p-2 hover:bg-slate-100 rounded-lg transition-all">
                    <svg class="w-5 h-5 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                </button>
            </div>

            <!-- Day Navigation -->
            <div class="grid grid-cols-7 gap-2" id="dayNav">
                <!-- Populated dynamically -->
            </div>
        </div>

        <!-- Water Tracker - With Wave Animation -->
        <div class="water-container rounded-2xl shadow-sm mb-6 border border-cyan-100" id="waterTrackerSection">
            <!-- Animated Water Waves -->
            <div class="water-waves" id="waterWaves">
                <svg viewBox="0 0 1200 70" preserveAspectRatio="none">
                    <!-- Back wave (slower, lighter) -->
                    <path class="wave-back" d="M0,35 C150,70 350,0 600,35 C850,70 1050,0 1200,35 L1200,70 L0,70 Z M1200,35 C1350,70 1550,0 1800,35 C2050,70 2250,0 2400,35 L2400,70 L1200,70 Z"/>
                    <!-- Front wave (faster, darker) -->
                    <path class="wave-front" d="M0,40 C200,10 400,60 600,40 C800,20 1000,55 1200,40 L1200,70 L0,70 Z M1200,40 C1400,10 1600,60 1800,40 C2000,20 2200,55 2400,40 L2400,70 L1200,70 Z"/>
                </svg>
            </div>

            <!-- Content (above the waves) -->
            <div class="relative z-10 p-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <span class="text-2xl">üíß</span>
                        <div>
                            <div class="font-semibold text-slate-800">Water Intake</div>
                            <div class="text-xs text-slate-500">Each tap = 250ml (1 glass)</div>
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <button onclick="adjustWater(-1)" class="w-10 h-10 rounded-full bg-white/80 backdrop-blur shadow-sm border border-slate-200 text-slate-600 hover:bg-red-50 hover:border-red-200 hover:text-red-500 transition-all font-bold text-xl flex items-center justify-center edit-only">
                            ‚àí
                        </button>
                        <div class="text-center min-w-[80px]">
                            <div class="text-2xl font-bold text-cyan-600" id="waterDisplay">0</div>
                            <div class="text-xs text-slate-400">/ 2000 ml</div>
                        </div>
                        <button onclick="adjustWater(1)" class="w-10 h-10 rounded-full bg-white/80 backdrop-blur shadow-sm border border-slate-200 text-slate-600 hover:bg-green-50 hover:border-green-200 hover:text-green-500 transition-all font-bold text-xl flex items-center justify-center edit-only">
                            +
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Tabs -->
        <div class="flex gap-2 mb-4 items-center justify-center">
            <button onclick="switchTab('progress')" class="tab-btn px-6 py-2.5 rounded-xl font-semibold text-sm transition-all tab-active" data-tab="progress">
                üìä Progress
            </button>
            <button onclick="switchTab('diet')" class="tab-btn px-6 py-2.5 rounded-xl font-semibold text-sm transition-all bg-white text-slate-600 hover:bg-slate-50" data-tab="diet">
                ü•ó Diet
            </button>
            <button onclick="switchTab('workout')" class="tab-btn px-6 py-2.5 rounded-xl font-semibold text-sm transition-all bg-white text-slate-600 hover:bg-slate-50" data-tab="workout">
                üí™ Workout
            </button>
            <!-- Edit Mode Lock Icon -->
            <button id="editModeToggle" onclick="toggleEditMode()" class="w-10 h-10 rounded-xl flex items-center justify-center transition-all bg-slate-100 hover:bg-slate-200 text-slate-500" title="Toggle Edit Mode">
                <svg id="editModeLockIcon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                </svg>
            </button>
        </div>

        <!-- Tab Content -->
        <div id="tabContent">
            <!-- Content loaded dynamically -->
        </div>

        <!-- Footer -->
        <footer class="text-center mt-8 text-slate-400 text-sm">
        </footer>
    </div>

    <!-- Food Search Modal -->
    <div id="foodModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-3xl w-full max-w-lg max-h-[85vh] shadow-2xl flex flex-col">
            <!-- Header with Tabs -->
            <div class="p-4 border-b border-slate-100">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="font-display text-xl font-semibold text-slate-800">üçΩÔ∏è Add Food</h3>
                    <button onclick="closeFoodModal()" class="p-2 hover:bg-slate-100 rounded-lg">
                        <svg class="w-5 h-5 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                <!-- Modal Tabs -->
                <div class="flex gap-2">
                    <button onclick="switchFoodModalTab('search')" class="food-modal-tab flex-1 py-2 rounded-xl text-sm font-semibold transition-all bg-blue-500 text-white" data-tab="search">
                        üîç Search Foods
                    </button>
                    <button onclick="switchFoodModalTab('combos')" class="food-modal-tab flex-1 py-2 rounded-xl text-sm font-semibold transition-all bg-slate-100 text-slate-600" data-tab="combos">
                        ‚ö° Quick Combos
                    </button>
                </div>
            </div>

            <!-- Search Tab Content -->
            <div id="searchTabContent" class="flex-1 flex flex-col overflow-hidden">
                <div class="px-4 pt-3 pb-2">
                    <div class="relative">
                        <input type="text" id="foodSearch" placeholder="Search foods... (e.g., chapati, chicken, dal)"
                               class="w-full px-4 py-3 pl-10 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500"
                               oninput="searchFoods(this.value)">
                        <svg class="w-5 h-5 text-slate-400 absolute left-3 top-1/2 -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    </div>
                    <div class="flex gap-2 mt-2 flex-wrap">
                        <button onclick="filterByCategory('all')" class="category-btn px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-700">All</button>
                        <button onclick="filterByCategory('Protein')" class="category-btn px-3 py-1 rounded-full text-xs font-medium bg-slate-100 text-slate-600">ü•© Protein</button>
                        <button onclick="filterByCategory('Grains')" class="category-btn px-3 py-1 rounded-full text-xs font-medium bg-slate-100 text-slate-600">üçö Grains</button>
                        <button onclick="filterByCategory('Vegetables')" class="category-btn px-3 py-1 rounded-full text-xs font-medium bg-slate-100 text-slate-600">ü•¨ Veggies</button>
                        <button onclick="filterByCategory('Dairy')" class="category-btn px-3 py-1 rounded-full text-xs font-medium bg-slate-100 text-slate-600">ü•õ Dairy</button>
                        <button onclick="filterByCategory('Fruits')" class="category-btn px-3 py-1 rounded-full text-xs font-medium bg-slate-100 text-slate-600">üçé Fruits</button>
                    </div>
                </div>
                <div class="flex-1 overflow-y-auto p-4" id="foodSearchResults">
                    <div class="text-center text-slate-400 py-8">
                        <div class="loading-spinner mx-auto mb-3"></div>
                        Loading foods...
                    </div>
                </div>
            </div>

            <!-- Combos Tab Content -->
            <div id="combosTabContent" class="flex-1 flex flex-col overflow-hidden hidden">
                <div class="px-4 pt-3 pb-2 border-b border-slate-100">
                    <!-- Category Tabs -->
                    <div class="flex gap-1 overflow-x-auto pb-1" id="comboTabs">
                        <button onclick="filterCombos('all')" class="combo-tab px-3 py-1.5 text-xs font-medium rounded-lg bg-blue-500 text-white" data-category="all">All</button>
                        <button onclick="filterCombos('breakfast')" class="combo-tab px-3 py-1.5 text-xs font-medium rounded-lg bg-slate-100 text-slate-600" data-category="breakfast">üåÖ Breakfast</button>
                        <button onclick="filterCombos('lunch')" class="combo-tab px-3 py-1.5 text-xs font-medium rounded-lg bg-slate-100 text-slate-600" data-category="lunch">üçõ Lunch</button>
                        <button onclick="filterCombos('dinner')" class="combo-tab px-3 py-1.5 text-xs font-medium rounded-lg bg-slate-100 text-slate-600" data-category="dinner">üåô Dinner</button>
                        <button onclick="filterCombos('snacks')" class="combo-tab px-3 py-1.5 text-xs font-medium rounded-lg bg-slate-100 text-slate-600" data-category="snacks">üçø Snacks</button>
                        <button onclick="filterCombos('cheat')" class="combo-tab px-3 py-1.5 text-xs font-medium rounded-lg bg-slate-100 text-slate-600" data-category="cheat">üçï Cheat</button>
                    </div>
                    <!-- Create Combo Button -->
                    <button onclick="openCreateComboModal()" class="w-full mt-2 py-2 bg-gradient-to-r from-emerald-500 to-teal-500 text-white rounded-xl font-semibold text-sm hover:from-emerald-600 hover:to-teal-600 transition-all shadow-md shadow-emerald-500/20 flex items-center justify-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                        Create New Combo
                    </button>
                </div>
                <div class="flex-1 overflow-y-auto p-4" id="quickCombos">
                    <!-- Populated dynamically -->
                </div>
            </div>

            <div class="p-4 border-t border-slate-100 bg-slate-50 rounded-b-3xl">
                <button onclick="openCustomFoodModal()" class="w-full py-3 bg-white border-2 border-dashed border-slate-300 text-slate-600 rounded-xl font-semibold hover:border-blue-400 hover:text-blue-600 transition-all">
                    + Add Custom Food
                </button>
            </div>
        </div>
    </div>

    <!-- Quantity Modal -->
    <div id="quantityModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-3xl p-6 w-full max-w-sm shadow-2xl">
            <h3 class="font-display text-xl font-semibold text-slate-800 mb-2" id="quantityFoodName">Food Name</h3>
            <p class="text-slate-500 text-sm mb-4" id="quantityFoodMacros">Per serving: 100 kcal</p>

            <div class="mb-4">
                <label class="block text-sm text-slate-500 mb-2">Quantity</label>
                <div class="flex items-center gap-3">
                    <button onclick="adjustQuantity(-0.5)" class="w-10 h-10 rounded-lg bg-slate-100 hover:bg-slate-200 font-bold text-lg">-</button>
                    <input type="number" id="quantityInput" step="0.5" min="0.5" value="1"
                           class="flex-1 px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl text-lg font-semibold text-center focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button onclick="adjustQuantity(0.5)" class="w-10 h-10 rounded-lg bg-slate-100 hover:bg-slate-200 font-bold text-lg">+</button>
                </div>
                <div class="text-center text-sm text-slate-400 mt-2" id="quantityUnit">servings</div>
            </div>

            <div class="bg-slate-50 rounded-xl p-3 mb-4">
                <div class="text-sm text-slate-500 mb-1">Total Macros</div>
                <div class="grid grid-cols-5 gap-2 text-center text-xs">
                    <div><div class="font-bold text-rose-500" id="qCal">0</div><div class="text-slate-400">kcal</div></div>
                    <div><div class="font-bold text-amber-600" id="qProtein">0</div><div class="text-slate-400">protein</div></div>
                    <div><div class="font-bold text-blue-600" id="qCarbs">0</div><div class="text-slate-400">carbs</div></div>
                    <div><div class="font-bold text-pink-500" id="qFat">0</div><div class="text-slate-400">fat</div></div>
                    <div><div class="font-bold text-emerald-500" id="qFiber">0</div><div class="text-slate-400">fiber</div></div>
                </div>
            </div>

            <div class="flex gap-3">
                <button onclick="closeQuantityModal()" class="flex-1 py-3 bg-slate-100 hover:bg-slate-200 text-slate-600 rounded-xl font-semibold transition-all">Cancel</button>
                <button onclick="confirmAddFood()" class="flex-1 py-3 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-xl font-semibold transition-all shadow-lg shadow-blue-500/30">Add</button>
            </div>
        </div>
    </div>

    <!-- Custom Food Modal -->
    <div id="customFoodModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-3xl p-6 w-full max-w-sm shadow-2xl max-h-[90vh] overflow-y-auto">
            <h3 class="font-display text-xl font-semibold text-slate-800 mb-4">‚ûï Add Custom Food</h3>

            <div class="space-y-3">
                <div>
                    <label class="block text-sm text-slate-500 mb-1">Food Name *</label>
                    <input type="text" id="customName" class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., Homemade Khichdi">
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-sm text-slate-500 mb-1">Calories *</label>
                        <input type="number" id="customCalories" class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="150">
                    </div>
                    <div>
                        <label class="block text-sm text-slate-500 mb-1">Protein (g)</label>
                        <input type="number" id="customProtein" class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="8">
                    </div>
                </div>
                <div class="grid grid-cols-3 gap-3">
                    <div>
                        <label class="block text-sm text-slate-500 mb-1">Carbs (g)</label>
                        <input type="number" id="customCarbs" class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="20">
                    </div>
                    <div>
                        <label class="block text-sm text-slate-500 mb-1">Fat (g)</label>
                        <input type="number" id="customFat" class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="5">
                    </div>
                    <div>
                        <label class="block text-sm text-slate-500 mb-1">Fiber (g)</label>
                        <input type="number" id="customFiber" class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="3">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-sm text-slate-500 mb-1">Serving Size</label>
                        <input type="number" id="customServing" value="1" class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm text-slate-500 mb-1">Unit</label>
                        <select id="customUnit" class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="serving">serving</option>
                            <option value="pc">pc</option>
                            <option value="g">g</option>
                            <option value="ml">ml</option>
                            <option value="katori">katori</option>
                            <option value="tbsp">tbsp</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="flex gap-3 mt-6">
                <button onclick="closeCustomFoodModal()" class="flex-1 py-3 bg-slate-100 hover:bg-slate-200 text-slate-600 rounded-xl font-semibold transition-all">Cancel</button>
                <button onclick="saveCustomFood()" class="flex-1 py-3 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-xl font-semibold transition-all shadow-lg shadow-blue-500/30">Save & Add</button>
            </div>
        </div>
    </div>

    <!-- Create Combo Modal -->
    <div id="createComboModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-3xl w-full max-w-lg max-h-[90vh] shadow-2xl flex flex-col">
            <!-- Header -->
            <div class="p-4 border-b border-slate-100">
                <div class="flex items-center justify-between">
                    <h3 id="comboModalTitle" class="font-display text-xl font-semibold text-slate-800">Create New Combo</h3>
                    <button onclick="closeCreateComboModal()" class="p-2 hover:bg-slate-100 rounded-lg">
                        <svg class="w-5 h-5 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
            </div>

            <!-- Content -->
            <div class="flex-1 overflow-y-auto p-4 space-y-4">
                <!-- Combo Name & Emoji -->
                <div class="flex gap-3">
                    <div class="flex-1">
                        <label class="block text-sm text-slate-500 mb-1">Combo Name *</label>
                        <input type="text" id="comboName" class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500" placeholder="e.g., Power Breakfast">
                    </div>
                    <div>
                        <label class="block text-sm text-slate-500 mb-1">Emoji</label>
                        <div class="relative">
                            <button onclick="toggleEmojiPicker()" id="selectedEmoji" class="w-12 h-10 bg-slate-50 border border-slate-200 rounded-lg text-xl hover:bg-slate-100 transition-all">üçΩÔ∏è</button>
                            <div id="emojiPicker" class="hidden absolute top-12 right-0 bg-white border border-slate-200 rounded-xl shadow-xl p-2 grid grid-cols-6 gap-1 z-10">
                                <button onclick="selectComboEmoji('üçΩÔ∏è')" class="p-1.5 hover:bg-slate-100 rounded text-lg">üçΩÔ∏è</button>
                                <button onclick="selectComboEmoji('ü•ó')" class="p-1.5 hover:bg-slate-100 rounded text-lg">ü•ó</button>
                                <button onclick="selectComboEmoji('üçõ')" class="p-1.5 hover:bg-slate-100 rounded text-lg">üçõ</button>
                                <button onclick="selectComboEmoji('ü•£')" class="p-1.5 hover:bg-slate-100 rounded text-lg">ü•£</button>
                                <button onclick="selectComboEmoji('üç≥')" class="p-1.5 hover:bg-slate-100 rounded text-lg">üç≥</button>
                                <button onclick="selectComboEmoji('ü•™')" class="p-1.5 hover:bg-slate-100 rounded text-lg">ü•™</button>
                                <button onclick="selectComboEmoji('üçó')" class="p-1.5 hover:bg-slate-100 rounded text-lg">üçó</button>
                                <button onclick="selectComboEmoji('ü•©')" class="p-1.5 hover:bg-slate-100 rounded text-lg">ü•©</button>
                                <button onclick="selectComboEmoji('üçï')" class="p-1.5 hover:bg-slate-100 rounded text-lg">üçï</button>
                                <button onclick="selectComboEmoji('üçî')" class="p-1.5 hover:bg-slate-100 rounded text-lg">üçî</button>
                                <button onclick="selectComboEmoji('ü•õ')" class="p-1.5 hover:bg-slate-100 rounded text-lg">ü•õ</button>
                                <button onclick="selectComboEmoji('ü•§')" class="p-1.5 hover:bg-slate-100 rounded text-lg">ü•§</button>
                                <button onclick="selectComboEmoji('üßÄ')" class="p-1.5 hover:bg-slate-100 rounded text-lg">üßÄ</button>
                                <button onclick="selectComboEmoji('ü•ö')" class="p-1.5 hover:bg-slate-100 rounded text-lg">ü•ö</button>
                                <button onclick="selectComboEmoji('üçû')" class="p-1.5 hover:bg-slate-100 rounded text-lg">üçû</button>
                                <button onclick="selectComboEmoji('ü•ô')" class="p-1.5 hover:bg-slate-100 rounded text-lg">ü•ô</button>
                                <button onclick="selectComboEmoji('üåÆ')" class="p-1.5 hover:bg-slate-100 rounded text-lg">üåÆ</button>
                                <button onclick="selectComboEmoji('üçú')" class="p-1.5 hover:bg-slate-100 rounded text-lg">üçú</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Category & Tag -->
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-sm text-slate-500 mb-1">Category *</label>
                        <select id="comboCategory" class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500">
                            <option value="breakfast">üåÖ Breakfast</option>
                            <option value="lunch">üçõ Lunch</option>
                            <option value="dinner">üåô Dinner</option>
                            <option value="snacks">üçø Snacks</option>
                            <option value="cheat">üçï Cheat</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm text-slate-500 mb-1">Tag (optional)</label>
                        <select id="comboTag" class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500">
                            <option value="">None</option>
                            <option value="Default">Default</option>
                            <option value="High">High Protein</option>
                            <option value="Highest">Highest Protein</option>
                            <option value="Light">Light</option>
                            <option value="Max Protein">Max Protein</option>
                            <option value="Veg">Veg</option>
                            <option value="Cheat">Cheat</option>
                        </select>
                    </div>
                </div>

                <!-- Add Foods Section -->
                <div class="border border-slate-200 rounded-xl overflow-hidden">
                    <div class="bg-slate-50 px-3 py-2 border-b border-slate-200">
                        <div class="relative">
                            <input type="text" id="comboFoodSearch" placeholder="Search foods to add..."
                                   class="w-full px-3 py-2 pl-9 bg-white border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500 text-sm"
                                   oninput="searchFoodsForCombo(this.value)">
                            <svg class="w-4 h-4 text-slate-400 absolute left-3 top-1/2 -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                        </div>
                    </div>
                    <div id="comboFoodResults" class="max-h-32 overflow-y-auto">
                        <div class="text-center text-slate-400 py-4 text-sm">Search for foods to add</div>
                    </div>
                </div>

                <!-- Added Foods List -->
                <div>
                    <div class="flex items-center justify-between mb-2">
                        <label class="block text-sm font-medium text-slate-700">Foods in Combo</label>
                        <span id="comboItemCount" class="text-xs text-slate-400">0 items</span>
                    </div>
                    <div id="comboFoodsList" class="space-y-2 min-h-[60px] max-h-40 overflow-y-auto">
                        <div class="text-center text-slate-400 py-4 text-sm border-2 border-dashed border-slate-200 rounded-xl">
                            Add foods using search above
                        </div>
                    </div>
                </div>

                <!-- Totals Preview -->
                <div class="bg-gradient-to-r from-emerald-50 to-teal-50 rounded-xl p-3 border border-emerald-200">
                    <div class="text-sm font-medium text-emerald-800 mb-2">Combo Totals</div>
                    <div class="grid grid-cols-5 gap-2 text-center text-xs">
                        <div><div class="font-bold text-rose-500" id="comboTotalCal">0</div><div class="text-slate-400">kcal</div></div>
                        <div><div class="font-bold text-amber-600" id="comboTotalProtein">0g</div><div class="text-slate-400">protein</div></div>
                        <div><div class="font-bold text-blue-600" id="comboTotalCarbs">0g</div><div class="text-slate-400">carbs</div></div>
                        <div><div class="font-bold text-pink-500" id="comboTotalFat">0g</div><div class="text-slate-400">fat</div></div>
                        <div><div class="font-bold text-emerald-600" id="comboTotalFiber">0g</div><div class="text-slate-400">fiber</div></div>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="p-4 border-t border-slate-100 flex gap-3">
                <button onclick="closeCreateComboModal()" class="flex-1 py-3 bg-slate-100 hover:bg-slate-200 text-slate-600 rounded-xl font-semibold transition-all">Cancel</button>
                <button onclick="saveNewCombo()" class="flex-1 py-3 bg-gradient-to-r from-emerald-500 to-teal-500 text-white rounded-xl font-semibold transition-all shadow-lg shadow-emerald-500/30 hover:from-emerald-600 hover:to-teal-600">Save Combo</button>
            </div>
        </div>
    </div>

    <!-- Edit Meal Item Modal -->
    <div id="editMealModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-3xl p-6 w-full max-w-sm shadow-2xl">
            <h3 class="font-display text-xl font-semibold text-slate-800 mb-4">‚úèÔ∏è Edit Meal Item</h3>
            <div class="mb-4">
                <div id="editMealFoodName" class="font-semibold text-slate-700 mb-2"></div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-sm text-slate-500 mb-1">Quantity</label>
                        <input type="number" id="editMealQuantity" step="0.5" min="0.5" max="50"
                               class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-xl text-center font-semibold focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm text-slate-500 mb-1">Unit</label>
                        <input type="text" id="editMealUnit"
                               class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-xl text-center focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
            </div>
            <div class="bg-slate-50 rounded-xl p-3 mb-4">
                <div class="text-xs text-slate-500 mb-2">Updated Macros (per unit)</div>
                <div class="grid grid-cols-5 gap-2 text-center text-xs">
                    <div><div class="font-bold text-rose-500" id="editMealCal">0</div><div class="text-slate-400">kcal</div></div>
                    <div><div class="font-bold text-amber-600" id="editMealProtein">0</div><div class="text-slate-400">P</div></div>
                    <div><div class="font-bold text-blue-500" id="editMealCarbs">0</div><div class="text-slate-400">C</div></div>
                    <div><div class="font-bold text-orange-500" id="editMealFat">0</div><div class="text-slate-400">F</div></div>
                    <div><div class="font-bold text-green-600" id="editMealFiber">0</div><div class="text-slate-400">Fi</div></div>
                </div>
            </div>
            <div class="flex gap-3">
                <button onclick="closeEditMealModal()" class="flex-1 py-3 bg-slate-100 hover:bg-slate-200 text-slate-600 rounded-xl font-semibold transition-all">Cancel</button>
                <button onclick="saveMealEdit()" class="flex-1 py-3 bg-gradient-to-r from-blue-500 to-indigo-500 text-white rounded-xl font-semibold transition-all shadow-lg">Save</button>
            </div>
        </div>
    </div>

    <!-- Weight Modal -->
    <div id="weightModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-3xl p-6 w-full max-w-sm shadow-2xl">
            <h3 class="font-display text-xl font-semibold text-slate-800 mb-4">‚öñÔ∏è Log Weight</h3>
            <div class="mb-4">
                <label class="block text-sm text-slate-500 mb-2">Weight (kg)</label>
                <input type="number" id="weightInput" step="0.1" min="40" max="150"
                       class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl text-lg font-semibold text-center focus:outline-none focus:ring-2 focus:ring-blue-500"
                       placeholder="67.0">
            </div>
            <div class="mb-4">
                <label class="block text-sm text-slate-500 mb-2">Date</label>
                <input type="date" id="weightDate"
                       class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div class="flex gap-3">
                <button onclick="closeWeightModal()" class="flex-1 py-3 bg-slate-100 hover:bg-slate-200 text-slate-600 rounded-xl font-semibold transition-all">Cancel</button>
                <button onclick="saveWeight()" class="flex-1 py-3 bg-gradient-to-r from-emerald-500 to-teal-500 text-white rounded-xl font-semibold transition-all shadow-lg">Save</button>
            </div>
        </div>
    </div>

    <!-- PR Log Modal -->
    <div id="prModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-3xl p-6 w-full max-w-sm shadow-2xl">
            <h3 class="font-display text-xl font-semibold text-slate-800 mb-2">üèÜ Log Your PR</h3>
            <p class="text-slate-500 text-sm mb-4" id="prExerciseName">Push-ups</p>
            <div class="mb-4">
                <label class="block text-sm text-slate-500 mb-2" id="prLabel">Time (seconds)</label>
                <input type="number" id="prInput" step="1" min="1"
                       class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl text-lg font-semibold text-center focus:outline-none focus:ring-2 focus:ring-orange-500"
                       placeholder="300">
            </div>
            <div class="flex gap-3">
                <button onclick="closePrModal()" class="flex-1 py-3 bg-slate-100 hover:bg-slate-200 text-slate-600 rounded-xl font-semibold transition-all">Cancel</button>
                <button onclick="savePr()" class="flex-1 py-3 bg-gradient-to-r from-orange-500 to-red-500 text-white rounded-xl font-semibold transition-all shadow-lg shadow-orange-500/30">Save PR</button>
            </div>
        </div>
    </div>

    <!-- Goals Modal -->
    <div id="goalsModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-3xl p-6 w-full max-w-sm shadow-2xl">
            <h3 class="font-display text-xl font-semibold text-slate-800 mb-4">üéØ Daily Goals</h3>

            <div class="space-y-3">
                <div>
                    <label class="block text-sm text-slate-500 mb-1">Calories (kcal)</label>
                    <input type="number" id="goalCaloriesInput" class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="1300">
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-sm text-slate-500 mb-1">Protein (g)</label>
                        <input type="number" id="goalProteinInput" class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="80">
                    </div>
                    <div>
                        <label class="block text-sm text-slate-500 mb-1">Carbs (g)</label>
                        <input type="number" id="goalCarbsInput" class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="180">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-sm text-slate-500 mb-1">Fat (g)</label>
                        <input type="number" id="goalFatInput" class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="45">
                    </div>
                    <div>
                        <label class="block text-sm text-slate-500 mb-1">Fiber (g)</label>
                        <input type="number" id="goalFiberInput" class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="25">
                    </div>
                </div>
                <div>
                    <label class="block text-sm text-slate-500 mb-1">Target Weight (kg)</label>
                    <input type="number" id="goalWeightInput" step="0.1" class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="65">
                </div>
            </div>

            <div class="flex gap-3 mt-6">
                <button onclick="closeGoalsModal()" class="flex-1 py-3 bg-slate-100 hover:bg-slate-200 text-slate-600 rounded-xl font-semibold transition-all">Cancel</button>
                <button onclick="saveGoals()" class="flex-1 py-3 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-xl font-semibold transition-all shadow-lg shadow-blue-500/30">Save</button>
            </div>
        </div>
    </div>

    <!-- Password Modal (Edit Mode) -->
    <div id="passwordModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-3xl p-6 w-full max-w-sm shadow-2xl">
            <h3 class="font-display text-xl font-semibold text-slate-800 mb-2">üîê Enter Edit Password</h3>
            <p class="text-slate-500 text-sm mb-4">Enter the password to unlock editing mode</p>
            <form onsubmit="event.preventDefault(); verifyEditPassword();">
                <div class="mb-4">
                    <input type="password" id="editPasswordInput" autocomplete="current-password"
                           class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl text-lg text-center focus:outline-none focus:ring-2 focus:ring-blue-500"
                           placeholder="Password">
                </div>
                <p id="passwordError" class="text-red-500 text-sm mb-3 hidden">Incorrect password. Please try again.</p>
                <div class="flex gap-3">
                    <button type="button" onclick="closePasswordModal()" class="flex-1 py-3 bg-slate-100 hover:bg-slate-200 text-slate-600 rounded-xl font-semibold transition-all">Cancel</button>
                    <button type="submit" class="flex-1 py-3 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-xl font-semibold transition-all shadow-lg shadow-blue-500/30">Unlock</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div id="changePasswordModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-3xl p-6 w-full max-w-sm shadow-2xl">
            <h3 class="font-display text-xl font-semibold text-slate-800 mb-2">üîë Change Password</h3>
            <p class="text-slate-500 text-sm mb-4">Update your edit mode password</p>
            <div class="space-y-3">
                <div>
                    <label class="block text-sm text-slate-500 mb-1">Current Password</label>
                    <input type="password" id="currentPasswordInput"
                           class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500"
                           placeholder="Enter current password">
                </div>
                <div>
                    <label class="block text-sm text-slate-500 mb-1">New Password</label>
                    <input type="password" id="newPasswordInput"
                           class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500"
                           placeholder="Enter new password">
                </div>
                <div>
                    <label class="block text-sm text-slate-500 mb-1">Confirm New Password</label>
                    <input type="password" id="confirmPasswordInput"
                           class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500"
                           placeholder="Confirm new password">
                </div>
            </div>
            <p id="changePasswordError" class="text-red-500 text-sm mt-3 hidden">Error message</p>
            <p id="changePasswordSuccess" class="text-green-500 text-sm mt-3 hidden">Password changed successfully!</p>
            <div class="flex gap-3 mt-4">
                <button onclick="closeChangePasswordModal()" class="flex-1 py-3 bg-slate-100 hover:bg-slate-200 text-slate-600 rounded-xl font-semibold transition-all">Cancel</button>
                <button onclick="changePassword()" class="flex-1 py-3 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-xl font-semibold transition-all shadow-lg shadow-blue-500/30">Update</button>
            </div>
        </div>
    </div>

    <!-- Workout Editor Modal -->
    <div id="workoutEditorModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden items-center justify-center p-4 overflow-y-auto">
        <div class="bg-white rounded-3xl p-6 w-full max-w-2xl shadow-2xl my-4">
            <div class="flex items-center justify-between mb-4">
                <h3 class="font-display text-xl font-semibold text-slate-800" id="workoutEditorTitle">‚úèÔ∏è Edit Workout</h3>
                <button onclick="closeWorkoutEditor()" class="text-slate-400 hover:text-slate-600 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>

            <!-- Exercise List -->
            <div id="exerciseEditorList" class="space-y-2 max-h-96 overflow-y-auto mb-4">
                <!-- Exercises will be rendered here -->
            </div>

            <!-- Add Exercise Buttons -->
            <div class="flex gap-3 mb-4">
                <button onclick="addNewExercise()" class="flex-1 py-3 bg-slate-100 hover:bg-slate-200 text-slate-600 rounded-xl font-semibold transition-all flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                    Add Custom
                </button>
                <button onclick="openExerciseLibrary()" class="flex-1 py-3 bg-gradient-to-r from-blue-500 to-indigo-500 hover:from-blue-600 hover:to-indigo-600 text-white rounded-xl font-semibold transition-all flex items-center justify-center gap-2 shadow-lg shadow-blue-500/30">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path></svg>
                    Browse Library
                </button>
            </div>

            <div class="flex gap-3">
                <button onclick="closeWorkoutEditor()" class="flex-1 py-3 bg-slate-100 hover:bg-slate-200 text-slate-600 rounded-xl font-semibold transition-all">Cancel</button>
                <button onclick="saveWorkoutChanges()" class="flex-1 py-3 bg-gradient-to-r from-orange-500 to-red-500 text-white rounded-xl font-semibold transition-all shadow-lg shadow-orange-500/30">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Exercise Edit Modal -->
    <div id="exerciseEditModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-[60] hidden items-center justify-center p-4 overflow-y-auto">
        <div class="bg-white rounded-3xl p-6 w-full max-w-md shadow-2xl">
            <h3 class="font-display text-xl font-semibold text-slate-800 mb-4" id="exerciseEditTitle">Edit Exercise</h3>

            <div class="space-y-3">
                <div>
                    <label class="block text-sm text-slate-500 mb-1">Exercise Name *</label>
                    <input type="text" id="exerciseNameInput"
                           class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-orange-500"
                           placeholder="e.g., Push-ups">
                </div>
                <!-- Exercise Type Toggle -->
                <div>
                    <label class="block text-sm text-slate-500 mb-2">Exercise Type</label>
                    <div class="flex gap-2">
                        <button type="button" id="typeStrengthBtn" onclick="setExerciseType('strength')"
                                class="flex-1 py-2 px-3 rounded-xl text-sm font-semibold transition-all bg-orange-500 text-white">
                            Strength
                        </button>
                        <button type="button" id="typeCardioBtn" onclick="setExerciseType('cardio')"
                                class="flex-1 py-2 px-3 rounded-xl text-sm font-semibold transition-all bg-slate-100 text-slate-600 hover:bg-slate-200">
                            Cardio
                        </button>
                    </div>
                </div>
                <!-- Strength Fields (Sets/Reps) -->
                <div id="strengthFields" class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-sm text-slate-500 mb-1">Sets</label>
                        <input type="text" id="exerciseSetsInput"
                               class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-orange-500"
                               placeholder="3">
                    </div>
                    <div>
                        <label class="block text-sm text-slate-500 mb-1">Reps</label>
                        <input type="text" id="exerciseRepsInput"
                               class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-orange-500"
                               placeholder="10-15">
                    </div>
                </div>
                <!-- Cardio Fields (Duration/Distance) -->
                <div id="cardioFields" class="hidden grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-sm text-slate-500 mb-1">Duration</label>
                        <input type="text" id="exerciseDurationInput"
                               class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-orange-500"
                               placeholder="20 min">
                    </div>
                    <div>
                        <label class="block text-sm text-slate-500 mb-1">Distance (optional)</label>
                        <input type="text" id="exerciseDistanceInput"
                               class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-orange-500"
                               placeholder="2 km">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div id="restFieldContainer">
                        <label class="block text-sm text-slate-500 mb-1">Rest</label>
                        <input type="text" id="exerciseRestInput"
                               class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-orange-500"
                               placeholder="30s">
                    </div>
                    <div>
                        <label class="block text-sm text-slate-500 mb-1">Calories</label>
                        <input type="number" id="exerciseCaloriesInput"
                               class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-orange-500"
                               placeholder="50">
                    </div>
                </div>
                <div>
                    <label class="block text-sm text-slate-500 mb-1">Notes</label>
                    <textarea id="exerciseNotesInput" rows="2"
                              class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-orange-500 resize-none"
                              placeholder="Tips or instructions"></textarea>
                </div>
                <div class="flex flex-wrap gap-3">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="exerciseIsChallengeInput" class="w-4 h-4 accent-orange-500">
                        <span class="text-sm text-slate-600">Challenge Exercise</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="exerciseIsRestInput" class="w-4 h-4 accent-orange-500">
                        <span class="text-sm text-slate-600">Rest Period</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="exerciseIsOptionalInput" class="w-4 h-4 accent-orange-500">
                        <span class="text-sm text-slate-600">Optional</span>
                    </label>
                </div>
                <div id="prTypeSection" class="hidden">
                    <label class="block text-sm text-slate-500 mb-1">PR Type</label>
                    <select id="exercisePrTypeInput"
                            class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-orange-500">
                        <option value="time">Time (seconds)</option>
                        <option value="reps">Reps</option>
                    </select>
                </div>
            </div>

            <div class="flex gap-3 mt-6">
                <button onclick="closeExerciseEditModal()" class="flex-1 py-3 bg-slate-100 hover:bg-slate-200 text-slate-600 rounded-xl font-semibold transition-all">Cancel</button>
                <button onclick="saveExerciseEdit()" class="flex-1 py-3 bg-gradient-to-r from-orange-500 to-red-500 text-white rounded-xl font-semibold transition-all shadow-lg shadow-orange-500/30">Save</button>
            </div>
        </div>
    </div>

    <!-- Exercise Library Browser Modal -->
    <div id="exerciseLibraryModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-[60] hidden items-center justify-center p-4 overflow-y-auto">
        <div class="bg-white rounded-3xl p-6 w-full max-w-2xl shadow-2xl my-4">
            <div class="flex items-center justify-between mb-4">
                <h3 class="font-display text-xl font-semibold text-slate-800">Exercise Library</h3>
                <button onclick="closeExerciseLibrary()" class="text-slate-400 hover:text-slate-600 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>

            <!-- Search and Filter -->
            <div class="flex gap-3 mb-4">
                <div class="flex-1 relative">
                    <input type="text" id="librarySearchInput"
                           class="w-full px-4 py-3 pl-10 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500"
                           placeholder="Search exercises..."
                           oninput="searchExerciseLibrary()">
                    <svg class="w-5 h-5 text-slate-400 absolute left-3 top-1/2 -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                </div>
                <select id="libraryCategoryFilter"
                        class="px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500"
                        onchange="filterExerciseLibrary()">
                    <option value="all">All Categories</option>
                </select>
            </div>

            <!-- Exercise List -->
            <div id="exerciseLibraryList" class="space-y-2 max-h-96 overflow-y-auto">
                <div class="text-center py-8 text-slate-400">
                    <p>Loading exercises...</p>
                </div>
            </div>

            <div class="flex gap-3 mt-4">
                <button onclick="closeExerciseLibrary()" class="flex-1 py-3 bg-slate-100 hover:bg-slate-200 text-slate-600 rounded-xl font-semibold transition-all">Close</button>
            </div>
        </div>
    </div>

    <!-- Exercise Detail Modal -->
    <div id="exerciseDetailModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-[70] hidden items-center justify-center p-4 overflow-y-auto">
        <div class="bg-white rounded-3xl p-6 w-full max-w-md shadow-2xl">
            <h3 class="font-display text-xl font-semibold text-slate-800 mb-2" id="exerciseDetailName">Exercise Name</h3>
            <div class="flex flex-wrap gap-2 mb-4">
                <span id="exerciseDetailCategory" class="text-xs px-2 py-1 bg-blue-100 text-blue-600 rounded-full">Category</span>
                <span id="exerciseDetailDifficulty" class="text-xs px-2 py-1 bg-purple-100 text-purple-600 rounded-full">Difficulty</span>
                <span id="exerciseDetailType" class="text-xs px-2 py-1 bg-green-100 text-green-600 rounded-full">Type</span>
            </div>

            <div class="space-y-3 mb-4">
                <div class="bg-slate-50 rounded-xl p-3">
                    <p class="text-xs text-slate-500 mb-1">Target Muscles</p>
                    <p class="text-sm font-medium text-slate-700" id="exerciseDetailMuscles">Primary muscles</p>
                    <p class="text-xs text-slate-500" id="exerciseDetailSecondary">Secondary muscles</p>
                </div>
                <div class="bg-slate-50 rounded-xl p-3">
                    <p class="text-xs text-slate-500 mb-1">Equipment</p>
                    <p class="text-sm font-medium text-slate-700" id="exerciseDetailEquipment">Equipment</p>
                </div>
                <div class="grid grid-cols-3 gap-2">
                    <div class="bg-orange-50 rounded-xl p-3 text-center">
                        <p class="text-xs text-orange-500 mb-1">Sets</p>
                        <p class="text-lg font-bold text-orange-600" id="exerciseDetailSets">3</p>
                    </div>
                    <div class="bg-blue-50 rounded-xl p-3 text-center">
                        <p class="text-xs text-blue-500 mb-1">Reps</p>
                        <p class="text-lg font-bold text-blue-600" id="exerciseDetailReps">10-12</p>
                    </div>
                    <div class="bg-green-50 rounded-xl p-3 text-center">
                        <p class="text-xs text-green-500 mb-1">Rest</p>
                        <p class="text-lg font-bold text-green-600" id="exerciseDetailRest">60s</p>
                    </div>
                </div>
                <div class="bg-slate-50 rounded-xl p-3">
                    <p class="text-xs text-slate-500 mb-1">Instructions</p>
                    <p class="text-sm text-slate-700" id="exerciseDetailInstructions">Instructions here</p>
                </div>
                <div class="bg-amber-50 rounded-xl p-3">
                    <p class="text-xs text-amber-500 mb-1">Tips</p>
                    <p class="text-sm text-amber-700" id="exerciseDetailTips">Tips here</p>
                </div>
            </div>

            <div class="flex gap-3">
                <button onclick="closeExerciseDetail()" class="flex-1 py-3 bg-slate-100 hover:bg-slate-200 text-slate-600 rounded-xl font-semibold transition-all">Back</button>
                <button onclick="addExerciseFromLibrary()" class="flex-1 py-3 bg-gradient-to-r from-green-500 to-emerald-500 text-white rounded-xl font-semibold transition-all shadow-lg shadow-green-500/30">Add to Workout</button>
            </div>
        </div>
    </div>

    <script>
        // ==================== CONFIGURATION ====================
        // MySQL Backend API URL
        const API_URL = 'https://codesoft.co.in/fitlife/api.php';

        // ==================== TOAST NOTIFICATIONS ====================
        function showToast(message, type = 'info') {
            // Remove existing toast if any
            const existingToast = document.getElementById('toastNotification');
            if (existingToast) {
                existingToast.remove();
            }

            // Color schemes for different types
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                info: 'bg-blue-500',
                warning: 'bg-yellow-500'
            };

            const toast = document.createElement('div');
            toast.id = 'toastNotification';
            toast.className = `fixed bottom-20 left-1/2 -translate-x-1/2 ${colors[type] || colors.info} text-white px-6 py-3 rounded-xl shadow-lg z-[100] transition-all duration-300 opacity-0 transform translate-y-4`;
            toast.textContent = message;

            document.body.appendChild(toast);

            // Animate in
            requestAnimationFrame(() => {
                toast.classList.remove('opacity-0', 'translate-y-4');
            });

            // Auto remove after 3 seconds
            setTimeout(() => {
                toast.classList.add('opacity-0', 'translate-y-4');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // ==================== STATE ====================
        let selectedDate = new Date().toISOString().split('T')[0];
        let currentWeekStart = getMonday(new Date());
        let currentDayIndex = (new Date().getDay() + 6) % 7; // 0=Mon, 6=Sun
        let currentTab = 'progress';

        // Edit Mode State
        let isEditMode = localStorage.getItem('fitlife_edit_mode') === 'true';
        // Use sessionStorage for edit token (cleared on browser close) for better security
        // Also check expiration (4 hours max)
        let editToken = null;
        const storedToken = sessionStorage.getItem('fitlife_edit_token');
        const tokenExpiry = sessionStorage.getItem('fitlife_edit_token_expiry');
        if (storedToken && tokenExpiry && Date.now() < parseInt(tokenExpiry)) {
            editToken = storedToken;
        } else {
            // Clear expired token
            sessionStorage.removeItem('fitlife_edit_token');
            sessionStorage.removeItem('fitlife_edit_token_expiry');
        }

        // Database-backed workout data (loaded from server)
        let dbWorkoutSchedule = null;
        let dbWorkoutDetails = null;

        // Get Monday of a given week
        function getMonday(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            return new Date(d.setDate(diff));
        }
        let foodDatabase = [];
        let currentMealType = 'breakfast';
        let selectedFood = null;

        // Workout-specific Images (High Quality WebP) - Desktop and Mobile versions
        const isMobile = window.innerWidth <= 768;
        const imgPath = isMobile ? 'images/mobile/' : 'images/';
        const imgSuffix = isMobile ? '-mobile.webp' : '.webp';

        const workoutImages = {
            push: { url: `${imgPath}push${imgSuffix}`, alt: 'Push day - Chest and Triceps' },
            pull: { url: `${imgPath}pull${imgSuffix}`, alt: 'Pull day - Back and Biceps' },
            legs: { url: `${imgPath}legs${imgSuffix}`, alt: 'Legs day - Squats and Lunges' },
            upper: { url: `${imgPath}upper${imgSuffix}`, alt: 'Upper body workout' },
            rest: { url: `${imgPath}rest${imgSuffix}`, alt: 'Rest and recovery - Saturday' },
            rest2: { url: `${imgPath}rest2${imgSuffix}`, alt: 'Rest and recovery - Sunday' },
            cardio: { url: `${imgPath}cardio2${imgSuffix}`, alt: 'Cardio and running' }
        };

        // Daily Quotes
        const dailyQuotes = [
            { text: '"The only bad workout is the one that didn\'t happen."', author: '‚Äî Unknown' },
            { text: '"Take care of your body. It\'s the only place you have to live."', author: '‚Äî Jim Rohn' },
            { text: '"Discipline is choosing between what you want now and what you want most."', author: '‚Äî Abraham Lincoln' },
            { text: '"Your body can stand almost anything. It\'s your mind you have to convince."', author: '‚Äî Unknown' },
            { text: '"Success is the sum of small efforts repeated day in and day out."', author: '‚Äî Robert Collier' },
            { text: '"The pain you feel today will be the strength you feel tomorrow."', author: '‚Äî Unknown' },
            { text: '"You don\'t have to be great to start, but you have to start to be great."', author: '‚Äî Zig Ziglar' }
        ];

        // Saved Meal Combos (Quick Add) - with categories and tags
        const defaultMealCombos = [
            // ==================== BREAKFAST ====================
            {
                id: 1, name: 'Nut Milk + 2 Eggs', emoji: 'ü•õ', category: 'breakfast', tag: 'Default',
                items: [
                    { foodName: 'Milk (full fat)', quantity: 1, unit: '200ml', calories: 120, protein: 6, carbs: 10, fat: 6, fiber: 0 },
                    { foodName: 'Walnuts', quantity: 2, unit: 'pcs', calories: 52, protein: 1, carbs: 1, fat: 5, fiber: 0.5 },
                    { foodName: 'Almonds', quantity: 5, unit: 'pcs', calories: 35, protein: 1.5, carbs: 1, fat: 3, fiber: 0.5 },
                    { foodName: 'Dates', quantity: 1, unit: 'pc', calories: 20, protein: 0, carbs: 5, fat: 0, fiber: 0.5 },
                    { foodName: 'Raisins', quantity: 5, unit: 'pcs', calories: 15, protein: 0, carbs: 4, fat: 0, fiber: 0.3 },
                    { foodName: 'Pistachios', quantity: 5, unit: 'pcs', calories: 14, protein: 0.5, carbs: 0.5, fat: 1, fiber: 0.2 },
                    { foodName: 'Pumpkin Seeds', quantity: 1, unit: 'tbsp', calories: 45, protein: 2, carbs: 1, fat: 4, fiber: 0.5 },
                    { foodName: 'Whole Eggs', quantity: 2, unit: 'pcs', calories: 140, protein: 12, carbs: 1, fat: 10, fiber: 0 }
                ],
                totalCalories: 441, totalProtein: 23
            },
            {
                id: 2, name: 'Poha + Peanuts + Curd', emoji: 'üçö', category: 'breakfast', tag: null,
                items: [
                    { foodName: 'Poha', quantity: 1, unit: 'katori', calories: 180, protein: 4, carbs: 35, fat: 3, fiber: 1 },
                    { foodName: 'Peanuts', quantity: 20, unit: 'g', calories: 110, protein: 5, carbs: 4, fat: 9, fiber: 1.5 },
                    { foodName: 'Curd', quantity: 100, unit: 'g', calories: 50, protein: 3, carbs: 4, fat: 3, fiber: 0 }
                ],
                totalCalories: 340, totalProtein: 12
            },
            {
                id: 3, name: 'Idli (3) + Sambar + Chutney', emoji: 'ü´ì', category: 'breakfast', tag: null,
                items: [
                    { foodName: 'Idli', quantity: 3, unit: 'pcs', calories: 180, protein: 6, carbs: 36, fat: 1.5, fiber: 1.5 },
                    { foodName: 'Sambar', quantity: 1, unit: 'katori', calories: 100, protein: 3, carbs: 12, fat: 3, fiber: 3 },
                    { foodName: 'Coconut Chutney', quantity: 2, unit: 'tbsp', calories: 40, protein: 1, carbs: 2, fat: 3, fiber: 0.5 }
                ],
                totalCalories: 320, totalProtein: 10
            },
            {
                id: 4, name: 'Masala Dosa + Sambar', emoji: 'ü•û', category: 'breakfast', tag: null,
                items: [
                    { foodName: 'Masala Dosa', quantity: 1, unit: 'pc', calories: 280, protein: 7, carbs: 40, fat: 10, fiber: 2 },
                    { foodName: 'Sambar', quantity: 1, unit: 'katori', calories: 100, protein: 3, carbs: 12, fat: 3, fiber: 3 }
                ],
                totalCalories: 380, totalProtein: 10
            },
            {
                id: 5, name: 'Veg Cheese Toast', emoji: 'üßÄ', category: 'breakfast', tag: null,
                items: [
                    { foodName: 'Bread (whole wheat)', quantity: 2, unit: 'slices', calories: 160, protein: 6, carbs: 28, fat: 2, fiber: 4 },
                    { foodName: 'Cheese', quantity: 30, unit: 'g', calories: 120, protein: 7, carbs: 1, fat: 10, fiber: 0 },
                    { foodName: 'Mixed Vegetables', quantity: 50, unit: 'g', calories: 20, protein: 1, carbs: 4, fat: 0, fiber: 1 },
                    { foodName: 'Butter', quantity: 1, unit: 'tsp', calories: 100, protein: 0, carbs: 0, fat: 11, fiber: 0 }
                ],
                totalCalories: 400, totalProtein: 14
            },
            {
                id: 6, name: 'Aloo Paratha + Curd', emoji: 'ü´ì', category: 'breakfast', tag: null,
                items: [
                    { foodName: 'Aloo Paratha', quantity: 1, unit: 'pc', calories: 280, protein: 6, carbs: 40, fat: 12, fiber: 3 },
                    { foodName: 'Curd', quantity: 100, unit: 'g', calories: 100, protein: 4, carbs: 8, fat: 6, fiber: 0 }
                ],
                totalCalories: 380, totalProtein: 10
            },

            // ==================== LUNCH ====================
            {
                id: 7, name: 'Rice + Moong Dal + Chole + Curd', emoji: 'üçõ', category: 'lunch', tag: 'High',
                items: [
                    { foodName: 'Rice (cooked)', quantity: 75, unit: 'g', calories: 90, protein: 2, carbs: 20, fat: 0.5, fiber: 0.5 },
                    { foodName: 'Moong Dal', quantity: 1, unit: 'katori', calories: 120, protein: 8, carbs: 18, fat: 0.5, fiber: 3 },
                    { foodName: 'Chole', quantity: 1, unit: 'katori', calories: 150, protein: 9, carbs: 26, fat: 3, fiber: 7 },
                    { foodName: 'Curd', quantity: 100, unit: 'g', calories: 60, protein: 3, carbs: 4, fat: 3, fiber: 0 },
                    { foodName: 'Salad', quantity: 1, unit: 'serving', calories: 25, protein: 1, carbs: 5, fat: 0, fiber: 2 }
                ],
                totalCalories: 445, totalProtein: 23
            },
            {
                id: 8, name: 'Rice + Chana Dal + Paneer Bhurji + Curd', emoji: 'üßÄ', category: 'lunch', tag: 'Highest',
                items: [
                    { foodName: 'Rice (cooked)', quantity: 75, unit: 'g', calories: 90, protein: 2, carbs: 20, fat: 0.5, fiber: 0.5 },
                    { foodName: 'Chana Dal', quantity: 1, unit: 'katori', calories: 120, protein: 8, carbs: 18, fat: 1, fiber: 4 },
                    { foodName: 'Paneer Bhurji', quantity: 75, unit: 'g', calories: 200, protein: 14, carbs: 4, fat: 15, fiber: 0.5 },
                    { foodName: 'Curd', quantity: 100, unit: 'g', calories: 60, protein: 3, carbs: 4, fat: 3, fiber: 0 },
                    { foodName: 'Salad', quantity: 1, unit: 'serving', calories: 25, protein: 1, carbs: 5, fat: 0, fiber: 2 }
                ],
                totalCalories: 495, totalProtein: 28
            },
            {
                id: 9, name: 'Rice + Toor Dal + Cabbage + Egg + Curd', emoji: 'ü•ö', category: 'lunch', tag: null,
                items: [
                    { foodName: 'Rice (cooked)', quantity: 75, unit: 'g', calories: 90, protein: 2, carbs: 20, fat: 0.5, fiber: 0.5 },
                    { foodName: 'Toor Dal', quantity: 1, unit: 'katori', calories: 120, protein: 8, carbs: 18, fat: 0.5, fiber: 3 },
                    { foodName: 'Cabbage Sabzi', quantity: 1, unit: 'katori', calories: 60, protein: 2, carbs: 8, fat: 3, fiber: 2 },
                    { foodName: 'Boiled Egg', quantity: 1, unit: 'pc', calories: 78, protein: 6, carbs: 0.5, fat: 5, fiber: 0 },
                    { foodName: 'Curd', quantity: 100, unit: 'g', calories: 60, protein: 3, carbs: 4, fat: 3, fiber: 0 },
                    { foodName: 'Salad', quantity: 1, unit: 'serving', calories: 25, protein: 1, carbs: 5, fat: 0, fiber: 2 }
                ],
                totalCalories: 433, totalProtein: 22
            },
            {
                id: 10, name: 'Rice + Masoor Dal + Suran + Curd', emoji: 'üçõ', category: 'lunch', tag: 'Light',
                items: [
                    { foodName: 'Rice (cooked)', quantity: 75, unit: 'g', calories: 90, protein: 2, carbs: 20, fat: 0.5, fiber: 0.5 },
                    { foodName: 'Masoor Dal', quantity: 1, unit: 'katori', calories: 120, protein: 8, carbs: 18, fat: 0.5, fiber: 3 },
                    { foodName: 'Suran (Yam) dry', quantity: 1, unit: 'katori', calories: 100, protein: 2, carbs: 20, fat: 2, fiber: 3 },
                    { foodName: 'Curd', quantity: 100, unit: 'g', calories: 60, protein: 3, carbs: 4, fat: 3, fiber: 0 },
                    { foodName: 'Salad', quantity: 1, unit: 'serving', calories: 25, protein: 1, carbs: 5, fat: 0, fiber: 2 }
                ],
                totalCalories: 395, totalProtein: 16
            },
            {
                id: 11, name: 'Rice + Rajma + Curd', emoji: 'ü´ò', category: 'lunch', tag: 'High',
                items: [
                    { foodName: 'Rice (cooked)', quantity: 75, unit: 'g', calories: 90, protein: 2, carbs: 20, fat: 0.5, fiber: 0.5 },
                    { foodName: 'Rajma', quantity: 1, unit: 'katori', calories: 170, protein: 10, carbs: 28, fat: 1, fiber: 6 },
                    { foodName: 'Curd', quantity: 100, unit: 'g', calories: 60, protein: 3, carbs: 4, fat: 3, fiber: 0 },
                    { foodName: 'Salad', quantity: 1, unit: 'serving', calories: 25, protein: 1, carbs: 5, fat: 0, fiber: 2 },
                    { foodName: 'Onion Raita', quantity: 50, unit: 'g', calories: 100, protein: 7, carbs: 6, fat: 5, fiber: 1 }
                ],
                totalCalories: 445, totalProtein: 23
            },
            {
                id: 12, name: 'Rice + Dal + Palak Paneer + Curd', emoji: 'ü•¨', category: 'lunch', tag: 'High',
                items: [
                    { foodName: 'Rice (cooked)', quantity: 75, unit: 'g', calories: 90, protein: 2, carbs: 20, fat: 0.5, fiber: 0.5 },
                    { foodName: 'Dal', quantity: 1, unit: 'katori', calories: 120, protein: 8, carbs: 18, fat: 0.5, fiber: 3 },
                    { foodName: 'Palak Paneer', quantity: 75, unit: 'g', calories: 220, protein: 12, carbs: 8, fat: 16, fiber: 2 },
                    { foodName: 'Curd', quantity: 100, unit: 'g', calories: 60, protein: 3, carbs: 4, fat: 3, fiber: 0 },
                    { foodName: 'Salad', quantity: 1, unit: 'serving', calories: 25, protein: 1, carbs: 5, fat: 0, fiber: 2 }
                ],
                totalCalories: 515, totalProtein: 26
            },

            // ==================== DINNER ====================
            {
                id: 13, name: '2 Chapati + Paneer Bhurji + Salad', emoji: 'üßÄ', category: 'dinner', tag: null,
                items: [
                    { foodName: 'Chapati', quantity: 2, unit: 'pcs', calories: 195, protein: 7, carbs: 30, fat: 5, fiber: 4 },
                    { foodName: 'Paneer Bhurji', quantity: 100, unit: 'g', calories: 265, protein: 18, carbs: 5, fat: 20, fiber: 1 },
                    { foodName: 'Salad', quantity: 1, unit: 'serving', calories: 25, protein: 1, carbs: 5, fat: 0, fiber: 2 }
                ],
                totalCalories: 485, totalProtein: 26
            },
            {
                id: 14, name: '2 Chapati + Egg Bhurji + Salad', emoji: 'ü•ö', category: 'dinner', tag: null,
                items: [
                    { foodName: 'Chapati', quantity: 2, unit: 'pcs', calories: 195, protein: 7, carbs: 30, fat: 5, fiber: 4 },
                    { foodName: 'Egg Bhurji (2 eggs)', quantity: 2, unit: 'eggs', calories: 180, protein: 14, carbs: 2, fat: 12, fiber: 0 },
                    { foodName: 'Salad', quantity: 1, unit: 'serving', calories: 25, protein: 1, carbs: 5, fat: 0, fiber: 2 }
                ],
                totalCalories: 400, totalProtein: 22
            },
            {
                id: 15, name: '2 Chapati + Chole + Raita', emoji: 'ü´ì', category: 'dinner', tag: 'Veg',
                items: [
                    { foodName: 'Chapati', quantity: 2, unit: 'pcs', calories: 195, protein: 7, carbs: 30, fat: 5, fiber: 4 },
                    { foodName: 'Chole (dry)', quantity: 1, unit: 'katori', calories: 150, protein: 9, carbs: 26, fat: 3, fiber: 7 },
                    { foodName: 'Raita', quantity: 100, unit: 'g', calories: 50, protein: 2, carbs: 4, fat: 3, fiber: 0 }
                ],
                totalCalories: 395, totalProtein: 18
            },
            {
                id: 16, name: '2 Chapati + Chicken Curry + Salad', emoji: 'üçó', category: 'dinner', tag: null,
                items: [
                    { foodName: 'Chapati', quantity: 2, unit: 'pcs', calories: 195, protein: 7, carbs: 30, fat: 5, fiber: 4 },
                    { foodName: 'Chicken Curry', quantity: 100, unit: 'g', calories: 200, protein: 25, carbs: 4, fat: 10, fiber: 1 },
                    { foodName: 'Salad', quantity: 1, unit: 'serving', calories: 25, protein: 1, carbs: 5, fat: 0, fiber: 2 }
                ],
                totalCalories: 420, totalProtein: 33
            },
            {
                id: 17, name: '2 Chapati + Grilled Chicken + Salad', emoji: 'üçó', category: 'dinner', tag: 'Max Protein',
                items: [
                    { foodName: 'Chapati', quantity: 2, unit: 'pcs', calories: 195, protein: 7, carbs: 30, fat: 5, fiber: 4 },
                    { foodName: 'Grilled Chicken', quantity: 120, unit: 'g', calories: 185, protein: 35, carbs: 0, fat: 4, fiber: 0 },
                    { foodName: 'Salad', quantity: 1, unit: 'serving', calories: 25, protein: 1, carbs: 5, fat: 0, fiber: 2 }
                ],
                totalCalories: 405, totalProtein: 43
            },
            {
                id: 18, name: '2 Chapati + Fish Curry + Salad', emoji: 'üêü', category: 'dinner', tag: null,
                items: [
                    { foodName: 'Chapati', quantity: 2, unit: 'pcs', calories: 195, protein: 7, carbs: 30, fat: 5, fiber: 4 },
                    { foodName: 'Fish Curry', quantity: 100, unit: 'g', calories: 180, protein: 22, carbs: 4, fat: 8, fiber: 1 },
                    { foodName: 'Salad', quantity: 1, unit: 'serving', calories: 25, protein: 1, carbs: 5, fat: 0, fiber: 2 }
                ],
                totalCalories: 400, totalProtein: 30
            },
            {
                id: 19, name: '2 Chapati + Palak Paneer + Salad', emoji: 'ü•¨', category: 'dinner', tag: 'Veg',
                items: [
                    { foodName: 'Chapati', quantity: 2, unit: 'pcs', calories: 195, protein: 7, carbs: 30, fat: 5, fiber: 4 },
                    { foodName: 'Palak Paneer', quantity: 75, unit: 'g', calories: 220, protein: 12, carbs: 8, fat: 16, fiber: 2 },
                    { foodName: 'Salad', quantity: 1, unit: 'serving', calories: 25, protein: 1, carbs: 5, fat: 0, fiber: 2 }
                ],
                totalCalories: 440, totalProtein: 20
            },
            {
                id: 20, name: '1.5 Chapati + Grilled Fish + Salad', emoji: 'üêü', category: 'dinner', tag: 'Light',
                items: [
                    { foodName: 'Chapati', quantity: 1.5, unit: 'pcs', calories: 145, protein: 5, carbs: 22, fat: 4, fiber: 3 },
                    { foodName: 'Grilled Fish', quantity: 120, unit: 'g', calories: 150, protein: 28, carbs: 0, fat: 3, fiber: 0 },
                    { foodName: 'Salad', quantity: 1, unit: 'serving', calories: 25, protein: 1, carbs: 5, fat: 0, fiber: 2 }
                ],
                totalCalories: 320, totalProtein: 34
            },

            // ==================== SNACKS/POST-WORKOUT ====================
            {
                id: 21, name: 'Protein Shake', emoji: 'ü•§', category: 'snacks', tag: null,
                items: [
                    { foodName: 'Protein Powder (whey)', quantity: 1, unit: 'scoop', calories: 130, protein: 24, carbs: 3, fat: 2, fiber: 0 }
                ],
                totalCalories: 130, totalProtein: 24
            },

            // ==================== CHEAT MEALS ====================
            {
                id: 22, name: 'Pizza (2 slices) + Salad', emoji: 'üçï', category: 'cheat', tag: 'Cheat', damageLevel: 'low',
                items: [
                    { foodName: 'Pizza', quantity: 2, unit: 'slices', calories: 500, protein: 20, carbs: 60, fat: 20, fiber: 3 },
                    { foodName: 'Salad', quantity: 1, unit: 'serving', calories: 50, protein: 2, carbs: 8, fat: 1, fiber: 3 }
                ],
                totalCalories: 550, totalProtein: 22
            },
            {
                id: 23, name: 'Butter Chicken + 1 Naan', emoji: 'üçó', category: 'cheat', tag: 'Cheat', damageLevel: 'medium',
                items: [
                    { foodName: 'Butter Chicken', quantity: 150, unit: 'g', calories: 400, protein: 28, carbs: 10, fat: 28, fiber: 2 },
                    { foodName: 'Naan', quantity: 1, unit: 'pc', calories: 300, protein: 8, carbs: 50, fat: 8, fiber: 2 }
                ],
                totalCalories: 700, totalProtein: 36
            },
            {
                id: 24, name: 'Biryani (1 plate)', emoji: 'üçõ', category: 'cheat', tag: 'Cheat', damageLevel: 'medium',
                items: [
                    { foodName: 'Chicken Biryani', quantity: 1, unit: 'plate', calories: 650, protein: 30, carbs: 70, fat: 25, fiber: 3 }
                ],
                totalCalories: 650, totalProtein: 30
            },
            {
                id: 25, name: 'Burger + Small Fries', emoji: 'üçî', category: 'cheat', tag: 'Cheat', damageLevel: 'medium',
                items: [
                    { foodName: 'Burger', quantity: 1, unit: 'pc', calories: 500, protein: 25, carbs: 40, fat: 28, fiber: 2 },
                    { foodName: 'French Fries (small)', quantity: 1, unit: 'serving', calories: 250, protein: 3, carbs: 35, fat: 12, fiber: 3 }
                ],
                totalCalories: 750, totalProtein: 28
            },
            {
                id: 26, name: 'Chole Bhature', emoji: 'ü´ì', category: 'cheat', tag: 'Cheat', damageLevel: 'low',
                items: [
                    { foodName: 'Chole', quantity: 1, unit: 'katori', calories: 200, protein: 10, carbs: 30, fat: 5, fiber: 8 },
                    { foodName: 'Bhatura', quantity: 1, unit: 'pc', calories: 350, protein: 6, carbs: 45, fat: 16, fiber: 2 }
                ],
                totalCalories: 550, totalProtein: 16
            },
            {
                id: 27, name: 'Pav Bhaji (2 pav)', emoji: 'üçû', category: 'cheat', tag: 'Cheat', damageLevel: 'low',
                items: [
                    { foodName: 'Bhaji', quantity: 1, unit: 'serving', calories: 250, protein: 8, carbs: 30, fat: 12, fiber: 6 },
                    { foodName: 'Pav (buttered)', quantity: 2, unit: 'pcs', calories: 300, protein: 6, carbs: 50, fat: 8, fiber: 2 }
                ],
                totalCalories: 550, totalProtein: 14
            }
        ];

        let savedMealCombos = JSON.parse(localStorage.getItem('fitlife_meal_combos')) || [...defaultMealCombos];

        let goals = { calories: 1450, protein: 105, carbs: 140, fat: 50, fiber: 28, targetWeight: 65 };
        let dailyTotals = { calories: 0, protein: 0, carbs: 0, fat: 0, fiber: 0 };
        let dailyMeals = { breakfast: [], lunch: [], dinner: [], snacks: [], preworkout: [], postworkout: [] };
        let weightHistory = [];
        let isOffline = false;
        let pendingSyncs = JSON.parse(localStorage.getItem('fitlife_pending_syncs')) || [];

        // Exercise tracking state - initialized empty, loaded from database
        let exerciseChecks = {};
        let prLog = {};
        // Daily PR attempts (stores today's logged time/reps for each exercise, keyed by date-exerciseName)
        let dailyPrAttempts = JSON.parse(localStorage.getItem('fitlife_daily_pr_attempts')) || {};
        let currentPrExercise = null;

        // Day type state (normal, light, cheat) - initialized empty, loaded from database
        let dayTypes = {};

        async function setDayType(type) {
            if (!isEditMode) {
                showToast('Unlock edit mode to change day type', 'info');
                return;
            }

            // DATABASE-FIRST: Save to server first
            const result = await apiPost('setDayType', { date: selectedDate, type: type });

            if (result.success) {
                // Success - update local state
                dayTypes[selectedDate] = type;
                // Update UI
                renderDayNav();
                renderTabContent();
            } else {
                showApiStatus('error', result.error || 'Failed to change day type');
                console.error('Day Type API Error:', result);
            }
        }

        function getDayTypeLabel(type) {
            const labels = {
                normal: 'Normal',
                light: 'ü•ó Light Day',
                cheat: 'üçï Cheat Day'
            };
            return labels[type] || 'Normal';
        }

        // Weekly Workout Schedule - Mon-Fri workouts, Sat-Sun rest
        // Index 0 = Monday, 6 = Sunday
        const weeklyWorkoutSchedule = {
            0: { type: 'push', name: 'Push + Core', emoji: 'üí™', color: 'orange' },    // Monday
            1: { type: 'pull', name: 'Pull', emoji: 'üèãÔ∏è', color: 'blue' },             // Tuesday
            2: { type: 'legs', name: 'Legs', emoji: 'ü¶µ', color: 'purple' },           // Wednesday
            3: { type: 'upper', name: 'Upper Var.', emoji: 'üîÑ', color: 'teal' },      // Thursday
            4: { type: 'cardio', name: 'Light Cardio', emoji: 'üèÉ', color: 'green' },  // Friday
            5: { type: 'rest', name: 'Rest', emoji: 'üò¥', color: 'gray' },             // Saturday
            6: { type: 'rest', name: 'Rest', emoji: 'üò¥', color: 'gray' }              // Sunday
        };

        // Get workout for any date based on day of week
        function getWorkoutForDate(dateStr) {
            const date = new Date(dateStr + 'T00:00:00');
            const dayOfWeek = date.getDay(); // 0 = Sunday, 1 = Monday, etc.
            // Convert JS day (0=Sun) to our schedule (0=Mon)
            const scheduleIndex = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
            return weeklyWorkoutSchedule[scheduleIndex];
        }

        // Legacy compatibility - generates workoutSchedule for current week view
        function getWorkoutSchedule() {
            const schedule = {};
            for (let i = 0; i < 7; i++) {
                const date = new Date(currentWeekStart);
                date.setDate(date.getDate() + i);
                const dateKey = date.toISOString().split('T')[0];
                schedule[i] = getWorkoutForDate(dateKey);
            }
            return schedule;
        }
        const workoutSchedule = getWorkoutSchedule();

        // Workout Details (with PR tracking for challenges)
        // Using let so it can be updated from database
        let workoutDetails = {
            push: {
                title: 'Push + Core Day',
                subtitle: 'Chest, Shoulders, Triceps + Core',
                color: 'orange',
                totalCalories: 250, // Approx calories for full workout
                exercises: [
                    { name: 'Push-ups', sets: '100 total', reps: 'For time', rest: '‚Äî', notes: 'Your challenge ‚Äî beat the clock!', isChallenge: true, prType: 'time', prUnit: 'seconds', calories: 100 },
                    { name: 'Rest & Recover', sets: '‚Äî', reps: '3-5 min', rest: '‚Äî', notes: 'Let heart rate settle', isRest: true, calories: 0 },
                    { name: 'Plank', sets: '3', reps: '30-45s', rest: '30s', notes: 'Core ‚Äî keep body straight', calories: 40 },
                    { name: 'Dead Bug', sets: '3', reps: '10 each side', rest: '30s', notes: 'Core stability ‚Äî slow & controlled', calories: 35 },
                    { name: 'Mountain Climbers', sets: '3', reps: '20 reps', rest: '30s', notes: 'Core + cardio finish', calories: 75 }
                ]
            },
            pull: {
                title: 'Pull Day',
                subtitle: 'Back, Biceps, Rear Delts',
                color: 'blue',
                totalCalories: 220,
                exercises: [
                    { name: 'Pull-ups', sets: '30 total', reps: 'For time', rest: '‚Äî', notes: 'Your challenge ‚Äî beat the clock!', isChallenge: true, prType: 'time', prUnit: 'seconds', calories: 80 },
                    { name: 'Rest & Recover', sets: '‚Äî', reps: '2-3 min', rest: '‚Äî', notes: 'Shake out arms', isRest: true, calories: 0 },
                    { name: 'Seated Band Rows', sets: '3', reps: '15-20', rest: '45s', notes: 'Sit on floor, loop band around feet, pull to belly', calories: 35 },
                    { name: 'Bent-Over Band Rows', sets: '3', reps: '12-15', rest: '45s', notes: 'Stand on band, hinge forward, row to chest', calories: 40 },
                    { name: 'Band Face Pulls', sets: '3', reps: '15-20', rest: '30s', notes: 'Pull band to face level, squeeze rear delts', calories: 30 },
                    { name: 'Band Bicep Curls', sets: '3', reps: '15', rest: '30s', notes: 'Stand on band, curl with control', calories: 25 },
                    { name: 'Superman Hold', sets: '3', reps: '20s', rest: '30s', notes: 'Lower back ‚Äî squeeze glutes', calories: 35 }
                ]
            },
            legs: {
                title: 'Legs Day',
                subtitle: 'Quads, Glutes, Hamstrings, Calves',
                color: 'purple',
                totalCalories: 300,
                exercises: [
                    { name: 'Squats', sets: 'Max reps', reps: 'in 60s', rest: '‚Äî', notes: 'Your challenge ‚Äî beat the count!', isChallenge: true, prType: 'reps', prUnit: 'reps', calories: 60 },
                    { name: 'Jump Squats', sets: '3', reps: '20', rest: '45s', notes: 'Explosive ‚Äî land soft', calories: 70 },
                    { name: 'Lunges', sets: '3', reps: '10 each leg', rest: '45s', notes: 'Keep torso upright', calories: 50 },
                    { name: 'Hip Thrusts', sets: '3', reps: '20', rest: '45s', notes: 'Squeeze glutes at top', calories: 40 },
                    { name: 'Single-Leg RDL', sets: '3', reps: '10 each', rest: '45s', notes: 'Hamstring focus ‚Äî balance', calories: 40 },
                    { name: 'Calf Raises', sets: '3', reps: '20', rest: '30s', notes: 'Slow, full range of motion', calories: 40 }
                ]
            },
            upper: {
                title: 'Upper Body Variations',
                subtitle: 'Light/Moderate ‚Äî Build Capacity',
                color: 'teal',
                totalCalories: 180,
                exercises: [
                    { name: 'Pike Push-ups', sets: '3', reps: '8-12', rest: '60s', notes: 'Shoulders ‚Äî stop 2-3 reps before failure', calories: 40 },
                    { name: 'Diamond Push-ups', sets: '3', reps: '10-15', rest: '60s', notes: 'Triceps ‚Äî NOT to failure', calories: 40 },
                    { name: 'Wide Push-ups', sets: '2', reps: '15', rest: '45s', notes: 'Chest stretch ‚Äî easy effort', calories: 30 },
                    { name: 'Tricep Dips', sets: '3', reps: '12', rest: '45s', notes: 'Chair dips ‚Äî control the descent', calories: 40 },
                    { name: 'Shoulder Taps', sets: '3', reps: '10 each', rest: '30s', notes: 'Plank position ‚Äî minimize hip sway', calories: 30 }
                ]
            },
            rest: {
                title: 'Rest Day',
                subtitle: 'Recovery & Light Activity',
                color: 'gray',
                totalCalories: 100,
                exercises: [
                    { name: 'Light Walking', sets: '‚Äî', reps: '15-20 min', rest: '‚Äî', notes: 'Optional ‚Äî active recovery', isOptional: true, calories: 60 },
                    { name: 'Stretching', sets: '‚Äî', reps: '10 min', rest: '‚Äî', notes: 'Focus on tight areas', isOptional: true, calories: 25 },
                    { name: 'Foam Rolling', sets: '‚Äî', reps: '5-10 min', rest: '‚Äî', notes: 'If available', isOptional: true, calories: 15 }
                ]
            },
            cardio: {
                title: 'Light Cardio Day',
                subtitle: 'Walking, Skipping & Active Recovery',
                color: 'green',
                totalCalories: 200,
                exercises: [
                    { name: 'Brisk Walking', sets: '‚Äî', reps: '20-30 min', rest: '‚Äî', notes: 'Outdoor walk ‚Äî keep good pace', calories: 100 },
                    { name: 'Jump Rope / Skipping', sets: '3', reps: '2-3 min', rest: '1 min', notes: 'Light effort ‚Äî don\'t push hard', calories: 60 },
                    { name: 'Stretching', sets: '‚Äî', reps: '10 min', rest: '‚Äî', notes: 'Focus on legs and hips', calories: 25 },
                    { name: 'Deep Breathing', sets: '‚Äî', reps: '5 min', rest: '‚Äî', notes: 'Relax & recover', isOptional: true, calories: 15 }
                ]
            }
        };

        // Load workout data from database and update workoutDetails
        async function loadWorkoutData() {
            try {
                const result = await apiPost('getAllWorkouts', {});
                if (result.success && result.workoutDetails) {
                    // Update each workout type with data from database
                    for (const [type, data] of Object.entries(result.workoutDetails)) {
                        if (workoutDetails[type]) {
                            // Map database format to frontend format
                            workoutDetails[type].exercises = data.exercises.map(ex => ({
                                name: ex.name,
                                sets: ex.sets,
                                reps: ex.reps,
                                rest: ex.rest,
                                notes: ex.notes,
                                calories: ex.calories || 0,
                                isChallenge: ex.isChallenge,
                                prType: ex.prType,
                                prUnit: ex.prUnit,
                                isRest: ex.isRest,
                                isOptional: ex.isOptional
                            }));
                            workoutDetails[type].totalCalories = data.totalCalories || 0;
                        }
                    }
                    console.log('Workout data loaded from database');
                }
            } catch (error) {
                console.error('Error loading workout data:', error);
                // Keep using default hardcoded data on error
            }
        }

        // XSS Prevention - Escape HTML entities in user data
        function escapeHtml(str) {
            if (str === null || str === undefined) return '';
            const div = document.createElement('div');
            div.textContent = String(str);
            return div.innerHTML;
        }

        // Helper function to format time
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // Get all challenge exercises from all workout types
        function getAllChallengeExercises() {
            const challenges = [];
            const colors = ['orange', 'blue', 'purple', 'emerald', 'pink', 'cyan'];
            let colorIndex = 0;

            for (const [type, data] of Object.entries(workoutDetails)) {
                if (data.exercises) {
                    data.exercises.forEach(ex => {
                        if (ex.isChallenge) {
                            challenges.push({
                                name: ex.name,
                                reps: ex.reps,
                                prType: ex.prType,
                                color: colors[colorIndex % colors.length]
                            });
                            colorIndex++;
                        }
                    });
                }
            }
            return challenges;
        }

        // Calculate calories burnt based on completed exercises
        function calculateCaloriesBurnt() {
            const workout = getWorkoutForDate(selectedDate);
            const workoutData = workoutDetails[workout.type];

            let totalBurnt = 0;
            workoutData.exercises.forEach((ex, index) => {
                if (exerciseChecks[`${selectedDate}-${index}`] && ex.calories) {
                    totalBurnt += ex.calories;
                }
            });

            return totalBurnt;
        }

        // ==================== API CALLS ====================
        // HTTP status code error messages
        function getHttpErrorMessage(status) {
            const messages = {
                400: 'Invalid request data',
                401: 'Authentication required',
                403: 'Access denied',
                404: 'Resource not found',
                422: 'Validation failed',
                429: 'Too many requests - please slow down',
                500: 'Server error - please try again',
                502: 'Server temporarily unavailable',
                503: 'Service unavailable - maintenance in progress'
            };
            return messages[status] || `Request failed (${status})`;
        }

        async function apiGet(action, params = {}) {
            const url = new URL(API_URL);
            url.searchParams.append('action', action);
            Object.entries(params).forEach(([key, value]) => {
                if (value !== undefined && value !== null) {
                    url.searchParams.append(key, value);
                }
            });

            const controller = new AbortController();
            const timeout = setTimeout(() => controller.abort(), 10000); // 10 second timeout for GET

            try {
                const response = await fetch(url.toString(), {
                    method: 'GET',
                    redirect: 'follow',
                    signal: controller.signal
                });
                clearTimeout(timeout);

                const text = await response.text();
                let data;
                try {
                    data = JSON.parse(text);
                } catch {
                    console.error('Invalid JSON response:', text);
                    return { success: false, error: 'Invalid response from server', status: response.status };
                }

                // Handle HTTP errors
                if (!response.ok) {
                    console.error(`API GET Error (${response.status}):`, data);
                    if (response.status === 503) {
                        setOfflineMode(true);
                    }
                    return {
                        success: false,
                        error: data.error || getHttpErrorMessage(response.status),
                        details: data.details || null,
                        status: response.status
                    };
                }

                // Success - ensure success flag is set
                if (typeof data.success === 'undefined') {
                    data.success = true;
                }
                return data;

            } catch (error) {
                clearTimeout(timeout);
                if (error.name === 'AbortError') {
                    console.warn('API GET request timed out');
                    return { success: false, error: 'Request timed out', status: 408 };
                }
                console.error('API GET Error:', error);
                setOfflineMode(true);
                return { success: false, error: error.message, status: 0 };
            }
        }

        async function apiPost(action, data) {
            const controller = new AbortController();
            const timeout = setTimeout(() => controller.abort(), 8000); // 8 second timeout

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    redirect: 'follow',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ action, ...data }),
                    signal: controller.signal
                });
                clearTimeout(timeout);

                const text = await response.text();
                let result;
                try {
                    result = JSON.parse(text);
                } catch {
                    console.error('Invalid JSON response:', text);
                    return { success: false, error: 'Invalid response from server', status: response.status };
                }

                // Handle HTTP errors
                if (!response.ok) {
                    console.error(`API POST Error (${response.status}):`, result);
                    if (response.status === 503) {
                        setOfflineMode(true);
                    }
                    return {
                        success: false,
                        error: result.error || getHttpErrorMessage(response.status),
                        details: result.details || null,
                        status: response.status
                    };
                }

                // Success - ensure success flag is set
                if (typeof result.success === 'undefined') {
                    result.success = true;
                }
                return result;

            } catch (error) {
                clearTimeout(timeout);
                if (error.name === 'AbortError') {
                    console.warn('API POST request timed out');
                    return { success: false, error: 'Request timed out', status: 408 };
                }
                console.error('API POST Error:', error);
                setOfflineMode(true);
                return { success: false, error: error.message, status: 0 };
            }
        }

        function setOfflineMode(offline) {
            isOffline = offline;
            const banner = document.getElementById('connectionBanner');
            if (offline) {
                banner.classList.remove('hidden');
                banner.classList.add('flex');
                banner.innerHTML = '<span class="pulse-dot inline-block w-2 h-2 bg-white rounded-full mr-2"></span> Offline Mode - Changes saved locally';
                banner.classList.remove('bg-amber-500');
                banner.classList.add('bg-red-500');
            } else {
                banner.classList.add('hidden');
            }
        }

        // ==================== DATA LOADING ====================
        async function loadFoodDatabase() {
            // Try cache first for instant load
            const cached = localStorage.getItem('fitlife_foods_cache');
            if (cached) {
                foodDatabase = JSON.parse(cached);
                console.log('Loaded foods from cache');
            } else {
                // Use embedded fallback while loading
                foodDatabase = getEmbeddedFoodData();
            }

            // Fetch from database in background and update cache
            const result = await apiGet('getAllFoods');
            if (result.success && result.foods && result.foods.length > 0) {
                foodDatabase = result.foods;
                localStorage.setItem('fitlife_foods_cache', JSON.stringify(result.foods));
            }
        }

        async function loadDailyData() {
            // Always load localStorage first
            const cached = localStorage.getItem(`fitlife_meals_${selectedDate}`);
            let localMeals = null;
            let localTotals = null;

            if (cached) {
                const data = JSON.parse(cached);
                localMeals = data.meals;
                localTotals = data.totals;
            }

            const result = await apiGet('getDaily', { date: selectedDate });

            if (result.success && result.meals) {
                // Count items in server data
                const serverMealCount = Object.values(result.meals).reduce((sum, arr) => sum + (arr?.length || 0), 0);
                const localMealCount = localMeals ? Object.values(localMeals).reduce((sum, arr) => sum + (arr?.length || 0), 0) : 0;

                // Use server data only if it has more or equal items (server is more complete)
                // Otherwise keep local data (it might have unsync'd meals)
                if (serverMealCount >= localMealCount) {
                    dailyMeals = result.meals;
                    dailyTotals = result.totals || { calories: 0, protein: 0, carbs: 0, fat: 0, fiber: 0 };
                    // Update localStorage with server data
                    localStorage.setItem(`fitlife_meals_${selectedDate}`, JSON.stringify({
                        meals: dailyMeals,
                        totals: dailyTotals
                    }));
                } else {
                    // Local has more data, keep it and try to sync missing items
                    dailyMeals = localMeals;
                    dailyTotals = localTotals;
                    console.log('Keeping local data - has more meals than server');
                }
            } else if (localMeals) {
                // API failed, use localStorage
                dailyMeals = localMeals;
                dailyTotals = localTotals;
            } else {
                // No data anywhere, initialize empty
                dailyMeals = { breakfast: [], lunch: [], dinner: [], snacks: [], preworkout: [], postworkout: [] };
                dailyTotals = { calories: 0, protein: 0, carbs: 0, fat: 0, fiber: 0 };
            }

            updateMacroDisplay();
        }

        async function loadGoals() {
            // Load from cache first for instant display
            const cached = localStorage.getItem('fitlife_goals');
            if (cached) {
                goals = JSON.parse(cached);
            }
            updateGoalsDisplay();

            // Fetch from database and update cache
            const result = await apiGet('getGoals');
            if (result.success && result.goals) {
                goals = result.goals;
                localStorage.setItem('fitlife_goals', JSON.stringify(goals));
                updateGoalsDisplay();
            }
        }

        async function loadWeightHistory() {
            const result = await apiGet('getWeightHistory');
            if (result.success && result.history) {
                weightHistory = result.history;
            } else {
                const cached = localStorage.getItem('fitlife_weight');
                if (cached) weightHistory = JSON.parse(cached);
            }
            updateWeightDisplay();
        }

        // ==================== DISPLAY UPDATES ====================
        function updateMacroDisplay() {
            // Update numbers
            document.getElementById('totalCalories').textContent = Math.round(dailyTotals.calories);
            document.getElementById('goalCalories').textContent = goals.calories;
            document.getElementById('goalCaloriesLabel').textContent = goals.calories;

            // Calculate and update calories burnt from workout
            const caloriesBurnt = calculateCaloriesBurnt();
            document.getElementById('burntCalories').textContent = caloriesBurnt;

            document.getElementById('proteinCurrent').textContent = Math.round(dailyTotals.protein);
            document.getElementById('proteinGoal').textContent = goals.protein;

            document.getElementById('carbsCurrent').textContent = Math.round(dailyTotals.carbs);
            document.getElementById('carbsGoal').textContent = goals.carbs;

            document.getElementById('fatCurrent').textContent = Math.round(dailyTotals.fat);
            document.getElementById('fatGoal').textContent = goals.fat;

            document.getElementById('fiberCurrent').textContent = Math.round(dailyTotals.fiber);
            document.getElementById('fiberGoal').textContent = goals.fiber;

            // Update rings (circumference = 2 * PI * 35 ‚âà 220)
            const circumference = 220;

            const proteinPercent = Math.min(dailyTotals.protein / goals.protein, 1);
            document.getElementById('proteinRing').style.strokeDashoffset = circumference * (1 - proteinPercent);

            const carbsPercent = Math.min(dailyTotals.carbs / goals.carbs, 1);
            document.getElementById('carbsRing').style.strokeDashoffset = circumference * (1 - carbsPercent);

            const fatPercent = Math.min(dailyTotals.fat / goals.fat, 1);
            document.getElementById('fatRing').style.strokeDashoffset = circumference * (1 - fatPercent);

            const fiberPercent = Math.min(dailyTotals.fiber / goals.fiber, 1);
            document.getElementById('fiberRing').style.strokeDashoffset = circumference * (1 - fiberPercent);

            // Update calorie bar
            const caloriePercent = Math.min((dailyTotals.calories / goals.calories) * 100, 100);
            document.getElementById('calorieBar').style.width = caloriePercent + '%';
            document.getElementById('caloriePercent').textContent = Math.round(caloriePercent) + '% of daily goal';

            // Change bar color if over
            if (dailyTotals.calories > goals.calories) {
                document.getElementById('calorieBar').classList.remove('from-rose-400', 'to-rose-500');
                document.getElementById('calorieBar').classList.add('from-red-500', 'to-red-600');
            } else {
                document.getElementById('calorieBar').classList.remove('from-red-500', 'to-red-600');
                document.getElementById('calorieBar').classList.add('from-rose-400', 'to-rose-500');
            }

            // Update Macro Advisor in Today's Progress
            updateMacroAdvisor();
        }

        function updateMacroAdvisor() {
            const advisorContent = document.getElementById('macroAdvisorContent');
            if (!advisorContent) return;

            // Generate the advice HTML
            advisorContent.innerHTML = generateMacroAdvice();
        }

        function generateMacroAdvice() {
            const consumed = {
                calories: dailyTotals.calories || 0,
                protein: dailyTotals.protein || 0,
                carbs: dailyTotals.carbs || 0,
                fat: dailyTotals.fat || 0,
                fiber: dailyTotals.fiber || 0
            };

            const remaining = {
                calories: Math.max(0, goals.calories - consumed.calories),
                protein: Math.max(0, goals.protein - consumed.protein),
                carbs: Math.max(0, goals.carbs - consumed.carbs),
                fat: Math.max(0, goals.fat - consumed.fat),
                fiber: Math.max(0, goals.fiber - consumed.fiber)
            };

            const pct = {
                calories: Math.round((consumed.calories / goals.calories) * 100) || 0,
                protein: Math.round((consumed.protein / goals.protein) * 100) || 0,
                carbs: Math.round((consumed.carbs / goals.carbs) * 100) || 0,
                fat: Math.round((consumed.fat / goals.fat) * 100) || 0,
                fiber: Math.round((consumed.fiber / goals.fiber) * 100) || 0
            };

            const advice = [];
            const mealsRemaining = getMealsRemaining();

            if (remaining.calories <= 0) {
                advice.push({ type: 'warning', icon: '‚ö†Ô∏è', text: `Calorie limit reached. Light snacks only.` });
            } else if (mealsRemaining.length > 0) {
                const perMeal = {
                    calories: Math.round(remaining.calories / mealsRemaining.length),
                    protein: Math.round(remaining.protein / mealsRemaining.length)
                };

                if (remaining.protein > 20 && pct.protein < 80) {
                    advice.push({ type: 'protein', icon: 'ü•©', text: `Need ${Math.round(remaining.protein)}g more protein (~${perMeal.protein}g/meal).` });
                }

                if (pct.fat > 100) {
                    advice.push({ type: 'warning', icon: 'üõë', text: `Fat exceeded by ${Math.round(consumed.fat - goals.fat)}g.` });
                }

                if (pct.fiber < 60) {
                    advice.push({ type: 'fiber', icon: 'ü•ó', text: `Add more fiber (veggies, dal, salad).` });
                }

                if (mealsRemaining.length > 0 && remaining.calories > 100) {
                    const nextMeal = mealsRemaining[0];
                    advice.push({ type: 'suggestion', icon: 'üí°', text: `${nextMeal}: ~${perMeal.calories} kcal, ${perMeal.protein}g protein.` });
                }
            }

            if (advice.length === 0) {
                if (pct.calories >= 90 && pct.protein >= 90) {
                    advice.push({ type: 'success', icon: 'üéØ', text: 'Great job! You\'re hitting your targets.' });
                } else {
                    advice.push({ type: 'info', icon: 'üìù', text: 'Log meals to get personalized advice.' });
                }
            }

            return advice.map(a => `
                <div class="flex items-start gap-2 py-1">
                    <span class="flex-shrink-0">${a.icon}</span>
                    <span class="${a.type === 'warning' ? 'text-red-600' : a.type === 'success' ? 'text-green-600' : 'text-slate-600'}">${a.text}</span>
                </div>
            `).join('');
        }

        function updateGoalsDisplay() {
            document.getElementById('goalCalories').textContent = goals.calories;
            document.getElementById('proteinGoal').textContent = goals.protein;
            document.getElementById('carbsGoal').textContent = goals.carbs;
            document.getElementById('fatGoal').textContent = goals.fat;
            document.getElementById('fiberGoal').textContent = goals.fiber;

            if (weightHistory.length > 0) {
                const currentWeight = weightHistory[weightHistory.length - 1].weight;
                const goalBadgeEl = document.getElementById('goalBadge');
                if (goalBadgeEl) {
                    goalBadgeEl.textContent = `${currentWeight} ‚Üí ${goals.targetWeight} kg`;
                }
            }
        }

        function updateWeightDisplay() {
            if (weightHistory.length > 0) {
                const latest = weightHistory[weightHistory.length - 1];
                const headerWeightEl = document.getElementById('headerWeight');
                if (headerWeightEl) {
                    headerWeightEl.textContent = latest.weight + ' kg';
                }
            }
        }

        // ==================== DATE & WEEK NAVIGATION ====================
        function formatDateDisplay(dateStr) {
            const date = new Date(dateStr + 'T00:00:00');
            const options = { weekday: 'long', month: 'long', day: 'numeric' };
            return date.toLocaleDateString('en-US', options);
        }

        function formatDateShort(date) {
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        function getDateKey(dayIndex) {
            const date = new Date(currentWeekStart);
            date.setDate(date.getDate() + dayIndex);
            return date.toISOString().split('T')[0];
        }

        function isToday(date) {
            const today = new Date();
            return date.toDateString() === today.toDateString();
        }

        function changeWeek(direction) {
            currentWeekStart.setDate(currentWeekStart.getDate() + (direction * 7));
            currentDayIndex = 0;
            selectedDate = getDateKey(0);
            updateWeekDisplay();
            loadDailyData().then(() => {
                renderTabContent();
                loadWater();
            });
        }

        function selectDay(dayIndex) {
            currentDayIndex = dayIndex;
            selectedDate = getDateKey(dayIndex);
            renderDayNav();
            updateMotivationBanner();
            loadDailyData().then(() => {
                renderTabContent();
                loadWater();
            });
        }

        function goToToday() {
            currentWeekStart = getMonday(new Date());
            currentDayIndex = (new Date().getDay() + 6) % 7;
            selectedDate = new Date().toISOString().split('T')[0];
            updateWeekDisplay();
            loadDailyData().then(() => {
                renderTabContent();
                loadWater();
            });
        }

        function updateWeekDisplay() {
            const weekEnd = new Date(currentWeekStart);
            weekEnd.setDate(weekEnd.getDate() + 6);
            document.getElementById('weekRangeDisplay').textContent =
                `${formatDateShort(currentWeekStart)} - ${formatDateShort(weekEnd)}`;
            renderDayNav();
            updateMotivationBanner();
        }

        function updateMotivationBanner() {
            const date = new Date(selectedDate + 'T00:00:00');
            const dayOfWeek = (date.getDay() + 6) % 7; // 0=Mon for day name display
            const workout = getWorkoutForDate(selectedDate);

            document.getElementById('motiveWorkout').textContent = `${workout.emoji} ${workout.name}`;
            document.getElementById('motiveWorkout').className = `px-3 py-1.5 rounded-full text-xs font-semibold text-white ${workout.type === 'rest' ? 'bg-slate-500/50' : 'bg-black/40'} backdrop-blur-sm`;

            // Use workout-type specific image (use rest2 for Sunday)
            let workoutImg;
            if (workout.type === 'rest') {
                // dayOfWeek: 5 = Saturday, 6 = Sunday
                workoutImg = dayOfWeek === 6 ? workoutImages.rest2 : workoutImages.rest;
            } else {
                workoutImg = workoutImages[workout.type] || workoutImages.rest;
            }
            document.getElementById('motiveImage').src = workoutImg.url;
            document.getElementById('motiveImage').alt = workoutImg.alt;
        }

        function renderDayNav() {
            const nav = document.getElementById('dayNav');
            const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];

            nav.innerHTML = days.map((day, index) => {
                const date = new Date(currentWeekStart);
                date.setDate(date.getDate() + index);
                const dateKey = date.toISOString().split('T')[0];
                const isTodayDate = isToday(date);
                const isSelected = index === currentDayIndex;
                const w = getWorkoutForDate(dateKey);
                const dayType = dayTypes[dateKey] || 'normal';

                const colorClasses = {
                    orange: 'bg-orange-100 text-orange-700 border-orange-200',
                    blue: 'bg-blue-100 text-blue-700 border-blue-200',
                    purple: 'bg-purple-100 text-purple-700 border-purple-200',
                    teal: 'bg-teal-100 text-teal-700 border-teal-200',
                    green: 'bg-green-100 text-green-700 border-green-200',
                    gray: 'bg-slate-100 text-slate-500 border-slate-200'
                };

                // Special colors for day types
                const dayTypeColors = {
                    cheat: 'bg-red-100 text-red-700 border-red-300',
                    light: 'bg-green-100 text-green-700 border-green-300'
                };

                let classes = 'p-2 rounded-xl font-semibold transition-all flex flex-col items-center cursor-pointer border-2 ';

                if (isSelected) {
                    classes += 'ring-2 ring-blue-500 ring-offset-2 ';
                }

                // Use day type color if set, otherwise workout color
                if (dayType !== 'normal' && dayTypeColors[dayType]) {
                    classes += dayTypeColors[dayType] + ' ';
                } else {
                    classes += colorClasses[w.color] + ' ';
                }

                if (isTodayDate) {
                    classes += 'ring-2 ring-amber-400 ring-offset-1 ';
                }

                // Day type indicator
                const dayTypeIcon = dayType === 'cheat' ? 'üçï' : dayType === 'light' ? 'ü•ó' : '';

                return `
                    <button class="${classes}" onclick="selectDay(${index})">
                        <span class="text-xs opacity-70">${day}</span>
                        <span class="text-lg font-bold">${date.getDate()}</span>
                        <span class="text-xs">${dayTypeIcon || w.emoji}</span>
                    </button>
                `;
            }).join('');
        }

        // ==================== TAB SWITCHING ====================
        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('tab-active');
                btn.classList.add('bg-white', 'text-slate-600');
                if (btn.dataset.tab === tab) {
                    btn.classList.add('tab-active');
                    btn.classList.remove('bg-white', 'text-slate-600');
                }
            });
            renderTabContent();
        }

        // ==================== TAB RENDERING ====================
        async function renderTabContent() {
            const container = document.getElementById('tabContent');
            if (currentTab === 'diet') {
                container.innerHTML = renderDietTab();
            } else if (currentTab === 'workout') {
                container.innerHTML = renderWorkoutTab();
            } else if (currentTab === 'progress') {
                // Fetch fresh weekly stats from database before rendering
                await fetchWeeklyStats();
                container.innerHTML = renderProgressTab();
            }
            // Re-apply edit mode visibility to newly rendered elements
            updateEditModeUI();
        }

        function renderDietTab() {
            const currentDayType = dayTypes[selectedDate] || 'normal';

            return `
                <!-- Day Type Toggle -->
                <div class="bg-white rounded-2xl p-3 shadow-sm mb-4 edit-only">
                    <div class="flex items-center justify-between">
                        <span class="text-sm font-medium text-slate-600">Day Type:</span>
                        <div class="flex gap-2">
                            <button onclick="setDayType('normal')" class="px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${currentDayType === 'normal' ? 'bg-blue-500 text-white' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}">
                                Normal
                            </button>
                            <button onclick="setDayType('light')" class="px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${currentDayType === 'light' ? 'bg-green-500 text-white' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}">
                                ü•ó Light
                            </button>
                            <button onclick="setDayType('cheat')" class="px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${currentDayType === 'cheat' ? 'bg-red-500 text-white' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}">
                                üçï Cheat
                            </button>
                        </div>
                    </div>
                    ${currentDayType === 'cheat' ? '<p class="text-xs text-red-500 mt-2 text-center">Cheat day! Enjoy responsibly - aim for under 2000 kcal total</p>' : ''}
                    ${currentDayType === 'light' ? '<p class="text-xs text-green-600 mt-2 text-center">Light day - reduced intake to balance your week</p>' : ''}
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Main Meals Column -->
                    <div class="lg:col-span-2 space-y-4">
                        ${renderMealSection('breakfast', 'üåÖ Breakfast', dailyMeals.breakfast || [])}
                        ${renderMealSection('lunch', 'üçõ Lunch', dailyMeals.lunch || [])}
                        ${renderMealSection('dinner', 'üåô Dinner', dailyMeals.dinner || [])}
                    </div>

                    <!-- Side Column -->
                    <div class="space-y-4">
                        ${renderMealSection('snacks', 'üçé Snacks', dailyMeals.snacks || [], true)}
                        ${renderMealSection('preworkout', '‚ö° Pre-Workout', dailyMeals.preworkout || [], true)}
                        ${renderMealSection('postworkout', 'üí™ Post-Workout', dailyMeals.postworkout || [], true)}
                    </div>
                </div>
            `;
        }

        function renderMealSection(mealType, title, items, isCompact = false) {
            const subtotal = items.reduce((acc, item) => ({
                calories: acc.calories + (item.calories || 0),
                protein: acc.protein + (item.protein || 0),
                carbs: acc.carbs + (item.carbs || 0),
                fat: acc.fat + (item.fat || 0),
                fiber: acc.fiber + (item.fiber || 0)
            }), { calories: 0, protein: 0, carbs: 0, fat: 0, fiber: 0 });

            // Meal type colors and gradients
            const mealStyles = {
                breakfast: { gradient: 'from-amber-500 to-orange-500', bg: 'bg-amber-50', border: 'border-amber-200', text: 'text-amber-700' },
                lunch: { gradient: 'from-emerald-500 to-teal-500', bg: 'bg-emerald-50', border: 'border-emerald-200', text: 'text-emerald-700' },
                dinner: { gradient: 'from-violet-500 to-purple-500', bg: 'bg-violet-50', border: 'border-violet-200', text: 'text-violet-700' },
                snacks: { gradient: 'from-pink-500 to-rose-500', bg: 'bg-pink-50', border: 'border-pink-200', text: 'text-pink-700' },
                preworkout: { gradient: 'from-cyan-500 to-teal-500', bg: 'bg-cyan-50', border: 'border-cyan-200', text: 'text-cyan-700' },
                postworkout: { gradient: 'from-blue-500 to-indigo-500', bg: 'bg-blue-50', border: 'border-blue-200', text: 'text-blue-700' }
            };
            const style = mealStyles[mealType] || mealStyles.breakfast;

            return `
                <div class="bg-white rounded-2xl overflow-hidden shadow-sm border border-slate-100">
                    <!-- Header with gradient -->
                    <div class="bg-gradient-to-r ${style.gradient} px-5 py-3 flex items-center justify-between">
                        <h3 class="font-semibold text-white ${isCompact ? 'text-sm' : 'text-base'}">${title}</h3>
                        <button onclick="openFoodModal('${mealType}')" class="bg-white/20 hover:bg-white/30 text-white text-sm font-medium flex items-center gap-1.5 px-3 py-1.5 rounded-lg transition-all edit-only">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                            Add
                        </button>
                    </div>

                    <div class="${isCompact ? 'p-3' : 'p-4'}">
                        ${items.length === 0 ? `
                            <div class="text-center py-6 ${style.bg} rounded-xl border-2 border-dashed ${style.border}">
                                <div class="text-3xl mb-2">${mealType === 'breakfast' ? 'üç≥' : mealType === 'lunch' ? 'ü•ó' : mealType === 'dinner' ? 'üçΩÔ∏è' : mealType === 'snacks' ? 'üçé' : mealType === 'preworkout' ? '‚ö°' : 'üí™'}</div>
                                <p class="text-slate-500 text-sm">No items yet</p>
                                <p class="text-slate-400 text-xs mt-1">Tap + Add to log food</p>
                            </div>
                        ` : `
                            <div class="space-y-2">
                                ${items.map((item, index) => `
                                    <div class="group relative flex items-start gap-3 p-3 rounded-xl ${style.bg} border ${style.border} hover:shadow-md transition-all">
                                        <!-- Calorie badge -->
                                        <div class="absolute -top-2 -right-2 bg-gradient-to-r ${style.gradient} text-white text-xs font-bold px-2 py-0.5 rounded-full shadow-lg">
                                            ${Math.round(item.calories)}
                                        </div>

                                        <!-- Food info -->
                                        <div class="flex-1 min-w-0 pr-6">
                                            <div class="font-semibold text-slate-800 text-sm leading-tight">${item.foodName}</div>
                                            <div class="text-xs text-slate-500 mt-0.5">${item.quantity} ${item.unit}</div>

                                            <!-- Macro pills -->
                                            <div class="flex flex-wrap gap-1.5 mt-2">
                                                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-amber-100 text-amber-700">
                                                    ${Math.round(item.protein)}g P
                                                </span>
                                                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-blue-100 text-blue-700">
                                                    ${Math.round(item.carbs)}g C
                                                </span>
                                                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-orange-100 text-orange-700">
                                                    ${Math.round(item.fat)}g F
                                                </span>
                                                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-green-100 text-green-700">
                                                    ${Math.round(item.fiber)}g Fi
                                                </span>
                                            </div>
                                        </div>

                                        <!-- Action buttons -->
                                        <div class="flex flex-col gap-1 md:opacity-0 md:group-hover:opacity-100 transition-opacity edit-only">
                                            <button onclick="editMealItem('${mealType}', ${index})" class="p-1.5 bg-white rounded-lg shadow-sm text-slate-400 hover:text-blue-500 hover:shadow-md transition-all" title="Edit">
                                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                                            </button>
                                            <button onclick="deleteFood('${mealType}', ${index})" class="p-1.5 bg-white rounded-lg shadow-sm text-slate-400 hover:text-red-500 hover:shadow-md transition-all" title="Delete">
                                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                            </button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>

                            <!-- Subtotal row - left aligned -->
                            <div class="mt-3 pt-3 border-t border-slate-200">
                                <div class="flex items-center gap-3 flex-wrap">
                                    <span class="text-slate-500 text-sm font-medium">Subtotal:</span>
                                    <span class="font-bold text-slate-700">${Math.round(subtotal.calories)} <span class="text-xs font-normal text-slate-400">kcal</span></span>
                                    <div class="flex gap-2 text-xs">
                                        <span class="px-2 py-0.5 rounded-full bg-amber-50 text-amber-600 font-medium">${Math.round(subtotal.protein)}P</span>
                                        <span class="px-2 py-0.5 rounded-full bg-blue-50 text-blue-600 font-medium">${Math.round(subtotal.carbs)}C</span>
                                        <span class="px-2 py-0.5 rounded-full bg-orange-50 text-orange-600 font-medium">${Math.round(subtotal.fat)}F</span>
                                        <span class="px-2 py-0.5 rounded-full bg-green-50 text-green-600 font-medium">${Math.round(subtotal.fiber)}Fi</span>
                                    </div>
                                </div>
                            </div>
                        `}
                    </div>
                </div>
            `;
        }

        // Intelligent Macro Analyzer
        function renderMacroAnalysis() {
            // Calculate totals consumed so far
            const consumed = {
                calories: dailyTotals.calories || 0,
                protein: dailyTotals.protein || 0,
                carbs: dailyTotals.carbs || 0,
                fat: dailyTotals.fat || 0,
                fiber: dailyTotals.fiber || 0
            };

            // Calculate remaining
            const remaining = {
                calories: Math.max(0, goals.calories - consumed.calories),
                protein: Math.max(0, goals.protein - consumed.protein),
                carbs: Math.max(0, goals.carbs - consumed.carbs),
                fat: Math.max(0, goals.fat - consumed.fat),
                fiber: Math.max(0, goals.fiber - consumed.fiber)
            };

            // Calculate percentages
            const pct = {
                calories: Math.round((consumed.calories / goals.calories) * 100),
                protein: Math.round((consumed.protein / goals.protein) * 100),
                carbs: Math.round((consumed.carbs / goals.carbs) * 100),
                fat: Math.round((consumed.fat / goals.fat) * 100),
                fiber: Math.round((consumed.fiber / goals.fiber) * 100)
            };

            // Determine status for each macro
            const getStatus = (pct, macro) => {
                if (pct >= 100) return { icon: '‚úÖ', color: 'text-green-600', bg: 'bg-green-100', msg: 'Goal reached!' };
                if (pct >= 80) return { icon: 'üëç', color: 'text-blue-600', bg: 'bg-blue-100', msg: 'Almost there' };
                if (pct >= 50) return { icon: 'üìä', color: 'text-amber-600', bg: 'bg-amber-100', msg: 'On track' };
                return { icon: '‚ö†Ô∏è', color: 'text-slate-500', bg: 'bg-slate-100', msg: 'Needs attention' };
            };

            // Generate smart advice based on what's remaining
            const advice = [];
            const mealsRemaining = getMealsRemaining();

            if (remaining.calories <= 0) {
                advice.push({ type: 'warning', icon: '‚ö†Ô∏è', text: `You've hit your calorie limit (${Math.round(consumed.calories)} kcal). Consider light snacks only.` });
            } else if (mealsRemaining.length > 0) {
                // Distribute remaining across meals
                const perMeal = {
                    calories: Math.round(remaining.calories / mealsRemaining.length),
                    protein: Math.round(remaining.protein / mealsRemaining.length),
                    carbs: Math.round(remaining.carbs / mealsRemaining.length),
                    fat: Math.round(remaining.fat / mealsRemaining.length)
                };

                if (remaining.protein > 20 && pct.protein < 80) {
                    advice.push({ type: 'protein', icon: 'ü•©', text: `Need ${Math.round(remaining.protein)}g more protein. Aim for ~${perMeal.protein}g per remaining meal.` });
                }

                if (pct.protein >= 100 && pct.carbs < 70) {
                    advice.push({ type: 'carbs', icon: 'üçö', text: `Protein goal met! You can have ${Math.round(remaining.carbs)}g carbs (rice, roti, fruits).` });
                }

                if (pct.fat > 100) {
                    advice.push({ type: 'warning', icon: 'üõë', text: `Fat exceeded by ${Math.round(consumed.fat - goals.fat)}g. Go easy on oils and fried foods.` });
                } else if (pct.fat < 50 && remaining.calories > 200) {
                    advice.push({ type: 'fat', icon: 'ü•ú', text: `Room for ${Math.round(remaining.fat)}g healthy fats (nuts, ghee, avocado).` });
                }

                if (pct.fiber < 60) {
                    advice.push({ type: 'fiber', icon: 'ü•ó', text: `Low fiber (${Math.round(consumed.fiber)}g). Add veggies, dal, or salad.` });
                }

                // Suggest meal composition
                if (mealsRemaining.length > 0 && remaining.calories > 100) {
                    const nextMeal = mealsRemaining[0];
                    advice.push({
                        type: 'suggestion',
                        icon: 'üí°',
                        text: `For ${nextMeal}: ~${perMeal.calories} kcal with ${perMeal.protein}g protein.`
                    });
                }
            }

            // If no specific advice, show general status
            if (advice.length === 0) {
                if (pct.calories >= 90 && pct.protein >= 90) {
                    advice.push({ type: 'success', icon: 'üéØ', text: 'Great job! You\'re hitting your targets today.' });
                } else {
                    advice.push({ type: 'info', icon: 'üìù', text: 'Start logging meals to get personalized advice.' });
                }
            }

            // Build HTML - Focus on actionable advice only (no progress bars - those are in Today's Progress widget)
            return `
                <div class="space-y-2">
                    ${advice.map(a => `
                        <div class="flex items-start gap-2 text-sm p-2 rounded-lg ${a.type === 'warning' ? 'bg-red-50' : a.type === 'success' ? 'bg-green-50' : 'bg-white/50'}">
                            <span class="flex-shrink-0 text-base">${a.icon}</span>
                            <span class="${a.type === 'warning' ? 'text-red-700' : a.type === 'success' ? 'text-green-700' : 'text-indigo-700'}">${a.text}</span>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function getMealsRemaining() {
            const hour = new Date().getHours();
            const meals = [];

            // Check which meals haven't been logged and are still upcoming
            if (hour < 10 && (!dailyMeals.breakfast || dailyMeals.breakfast.length === 0)) meals.push('breakfast');
            if (hour < 14 && (!dailyMeals.lunch || dailyMeals.lunch.length === 0)) meals.push('lunch');
            if (hour < 20 && (!dailyMeals.dinner || dailyMeals.dinner.length === 0)) meals.push('dinner');

            // If current day is not today, return all unlogged meals
            const today = new Date().toISOString().split('T')[0];
            if (selectedDate !== today) {
                const allMeals = [];
                if (!dailyMeals.breakfast || dailyMeals.breakfast.length === 0) allMeals.push('breakfast');
                if (!dailyMeals.lunch || dailyMeals.lunch.length === 0) allMeals.push('lunch');
                if (!dailyMeals.dinner || dailyMeals.dinner.length === 0) allMeals.push('dinner');
                return allMeals;
            }

            return meals;
        }

        function renderWorkoutTab() {
            const dayOfWeek = new Date(selectedDate + 'T00:00:00').getDay();
            const adjustedDay = dayOfWeek === 0 ? 6 : dayOfWeek - 1; // Convert to Mon=0 for week display
            const workout = getWorkoutForDate(selectedDate);
            const workoutData = workoutDetails[workout.type];

            // Get PRs for challenge exercises

            // Count completed exercises
            const exerciseCount = workoutData.exercises.filter(e => !e.isRest && !e.isOptional).length;
            let exercisesCompleted = 0;
            workoutData.exercises.forEach((ex, i) => {
                if (!ex.isRest && !ex.isOptional && exerciseChecks[`${selectedDate}-${i}`]) {
                    exercisesCompleted++;
                }
            });

            return `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2">
                        <div class="bg-white rounded-3xl p-6 shadow-sm ${workout.type === 'rest' ? 'bg-slate-50' : ''}">
                            <div class="flex items-center justify-between mb-6 pb-4 border-b border-slate-100">
                                <div>
                                    <h2 class="font-display text-2xl font-semibold text-slate-800">${workout.emoji} ${workoutData.title}</h2>
                                    <p class="text-slate-500 text-sm mt-1">${workoutData.subtitle}</p>
                                </div>
                                <div class="flex items-center gap-3">
                                    <button onclick="openWorkoutEditor()" class="px-3 py-1.5 bg-slate-100 hover:bg-slate-200 text-slate-600 rounded-lg text-sm font-medium transition-all edit-only flex items-center gap-1">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                                        Edit
                                    </button>
                                    <div class="text-right">
                                        ${workout.type !== 'rest' ? `
                                            <div class="text-sm font-semibold text-orange-600 bg-orange-50 px-3 py-1 rounded-full">${exercisesCompleted}/${exerciseCount} done</div>
                                            <div class="text-xs text-slate-500 mt-1">üî• ${calculateCaloriesBurnt()} / ${workoutData.totalCalories} kcal</div>
                                        ` : `
                                            <div class="text-sm text-slate-400">Rest Day</div>
                                        `}
                                    </div>
                                </div>
                            </div>

                            <div class="space-y-3">
                                ${workoutData.exercises.map((ex, index) => {
                                    const isChecked = exerciseChecks[`${selectedDate}-${index}`];
                                    const pr = prLog[ex.name];
                                    const todayAttempt = dailyPrAttempts[`${selectedDate}-${ex.name}`];

                                    if (ex.isRest) {
                                        return `
                                            <div class="p-4 rounded-xl bg-amber-50 border-2 border-amber-200 text-center">
                                                <span class="text-amber-600 font-semibold">‚è∏Ô∏è ${ex.reps} ‚Äî ${ex.notes}</span>
                                            </div>
                                        `;
                                    }

                                    return `
                                        <div class="p-4 rounded-2xl border-2 transition-all ${isChecked ? 'bg-emerald-50 border-emerald-300' : ex.isOptional ? 'bg-slate-50/50 border-dashed border-slate-200' : 'bg-slate-50 border-transparent hover:border-orange-200'} ${ex.isChallenge && !isChecked ? 'ring-2 ring-orange-300 ring-offset-2' : ''}">
                                            <div class="flex gap-4">
                                                <div class="flex-shrink-0 mt-1 cursor-pointer" onclick="toggleExercise('${selectedDate}', ${index})">
                                                    <div class="w-7 h-7 rounded-lg border-2 flex items-center justify-center transition-all ${isChecked ? 'bg-emerald-500 border-emerald-500' : 'border-slate-300 bg-white hover:border-orange-400'}">
                                                        ${isChecked ? '<svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>' : ''}
                                                    </div>
                                                </div>
                                                <div class="flex-1">
                                                    <div class="flex items-center gap-2 mb-1">
                                                        <span class="font-semibold text-slate-800 ${isChecked ? 'line-through opacity-60' : ''}">${ex.name}</span>
                                                        ${ex.isChallenge ? '<span class="text-xs font-semibold text-orange-600 bg-orange-100 px-2 py-0.5 rounded-full">üèÜ CHALLENGE</span>' : ''}
                                                        ${ex.isOptional ? '<span class="text-xs text-slate-400">(Optional)</span>' : ''}
                                                    </div>
                                                    <div class="flex items-center gap-4 text-sm text-slate-500 mb-2 flex-wrap">
                                                        <span><strong>Sets:</strong> ${ex.sets}</span>
                                                        <span><strong>Reps:</strong> ${ex.reps}</span>
                                                        ${ex.rest !== '‚Äî' ? `<span><strong>Rest:</strong> ${ex.rest}</span>` : ''}
                                                        ${ex.calories ? `<span class="text-orange-500"><strong>üî•</strong> ${ex.calories} kcal</span>` : ''}
                                                    </div>
                                                    <div class="text-sm text-slate-600 bg-slate-100 px-3 py-1.5 rounded-lg inline-block">${ex.notes}</div>

                                                    ${ex.isChallenge ? `
                                                        <div class="mt-3 flex items-center gap-3 flex-wrap">
                                                            <button onclick="openPrModal('${ex.name}', '${ex.prType}', '${ex.prUnit}')" class="px-4 py-2 bg-gradient-to-r from-orange-500 to-red-500 text-white rounded-lg font-semibold text-sm shadow-lg shadow-orange-500/30 hover:shadow-xl transition-all edit-only">
                                                                üìù Log ${ex.prType === 'time' ? 'Time' : 'Reps'}
                                                            </button>
                                                            ${todayAttempt ? `
                                                                <div class="text-sm flex items-center gap-2">
                                                                    <span class="text-slate-400">Today:</span>
                                                                    <span class="font-bold text-blue-600">${ex.prType === 'time' ? formatTime(todayAttempt.value) : todayAttempt.value + ' reps'}</span>
                                                                </div>
                                                            ` : ''}
                                                            ${pr ? `
                                                                <div class="text-sm flex items-center gap-2">
                                                                    <span class="text-slate-400">Best:</span>
                                                                    <span class="font-bold text-orange-600">${ex.prType === 'time' ? formatTime(pr.value) : pr.value + ' reps'}</span>
                                                                    <span class="text-xs text-slate-400">(${pr.date})</span>
                                                                    <button onclick="openPrModal('${ex.name}', '${ex.prType}', '${ex.prUnit}', true)" class="p-1 text-slate-400 hover:text-blue-500 transition-colors edit-only" title="Edit PR">
                                                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                                                                    </button>
                                                                </div>
                                                            ` : ''}
                                                        </div>
                                                    ` : ''}
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>

                    <div class="space-y-5">
                        <!-- PR Records -->
                        <div class="bg-gradient-to-br from-orange-500 to-red-500 rounded-3xl p-5 text-white shadow-xl">
                            <h3 class="font-display text-lg font-semibold mb-4">üèÜ Personal Records</h3>
                            <div class="space-y-3">
                                ${(() => {
                                    const challenges = getAllChallengeExercises();
                                    if (challenges.length === 0) {
                                        return '<div class="text-center py-4 text-white/80">No challenge exercises yet</div>';
                                    }
                                    return challenges.map(ch => {
                                        const pr = prLog[ch.name];
                                        return `
                                            <div class="bg-white/20 rounded-xl p-3">
                                                <div class="text-sm opacity-80">${ch.name} (${ch.reps})</div>
                                                <div class="text-xl font-bold">${pr ? (ch.prType === 'time' ? formatTime(pr.value) : pr.value + ' reps') : '‚Äî'}</div>
                                                ${pr ? `<div class="text-xs opacity-70">${pr.date}</div>` : ''}
                                            </div>
                                        `;
                                    }).join('');
                                })()}
                            </div>
                        </div>

                        <!-- Weekly Schedule -->
                        <div class="bg-white rounded-2xl p-5 shadow-sm">
                            <h3 class="font-display text-lg font-semibold text-slate-800 mb-4">üìÖ This Week</h3>
                            <div class="space-y-2">
                                ${[0,1,2,3,4,5,6].map(day => {
                                    const weekDate = new Date(currentWeekStart);
                                    weekDate.setDate(weekDate.getDate() + day);
                                    const dateKey = weekDate.toISOString().split('T')[0];
                                    const w = getWorkoutForDate(dateKey);
                                    return `
                                    <div class="flex items-center justify-between p-2 rounded-lg ${day === adjustedDay ? 'bg-blue-50' : ''}">
                                        <span class="text-sm ${day === adjustedDay ? 'font-semibold text-blue-700' : 'text-slate-600'}">${['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'][day]}</span>
                                        <span class="text-sm font-medium text-slate-700">${w.emoji} ${w.name}</span>
                                    </div>
                                `}).join('')}
                            </div>
                        </div>

                        <!-- Tips -->
                        <div class="bg-orange-50 rounded-2xl p-4">
                            <h3 class="font-semibold text-orange-800 mb-2">üí° Pro Tips</h3>
                            <div class="text-sm text-orange-700 space-y-1">
                                <p>‚Ä¢ Warm up 5 min before workout</p>
                                <p>‚Ä¢ Rest 45-60s between sets</p>
                                <p>‚Ä¢ Focus on form over speed</p>
                                <p>‚Ä¢ Hydrate during workout</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // ==================== PROGRESS TAB ====================
        function renderProgressTab() {
            // Get weight history data - weightHistory is an array of {date, weight} objects
            const sortedWeights = [...(weightHistory || [])]
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 14); // Last 14 entries

            const latestWeight = sortedWeights.length > 0 ? sortedWeights[0].weight : null;
            const oldestWeight = sortedWeights.length > 1 ? sortedWeights[sortedWeights.length - 1].weight : latestWeight;
            const weightChange = latestWeight && oldestWeight ? (latestWeight - oldestWeight).toFixed(1) : 0;
            const weightTrend = parseFloat(weightChange) < 0 ? 'down' : parseFloat(weightChange) > 0 ? 'up' : 'same';

            // Use the global currentStreak which is loaded from database
            const streak = currentStreak;

            // Get weekly stats
            const weekStats = getWeeklyStats();

            // Calculate workout completion
            const workoutCompletion = calculateWorkoutCompletion();

            return `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Main Stats Column -->
                    <div class="lg:col-span-2 space-y-5">
                        <!-- Weight Progress Card -->
                        <div class="bg-white rounded-3xl p-6 shadow-sm">
                            <div class="flex items-center justify-between mb-4">
                                <h2 class="font-display text-xl font-semibold text-slate-800">‚öñÔ∏è Weight Progress</h2>
                                <button onclick="openWeightModal()" class="px-4 py-2 bg-emerald-500 text-white rounded-xl text-sm font-semibold hover:bg-emerald-600 transition-colors edit-only">
                                    + Log Weight
                                </button>
                            </div>

                            <div class="grid grid-cols-3 gap-4 mb-6">
                                <div class="bg-slate-50 rounded-2xl p-4 text-center">
                                    <div class="text-sm text-slate-500 mb-1">Current</div>
                                    <div class="text-2xl font-bold text-slate-800">${latestWeight ? latestWeight + ' kg' : '--'}</div>
                                </div>
                                <div class="bg-slate-50 rounded-2xl p-4 text-center">
                                    <div class="text-sm text-slate-500 mb-1">Target</div>
                                    <div class="text-2xl font-bold text-emerald-600">${goals.targetWeight} kg</div>
                                </div>
                                <div class="bg-slate-50 rounded-2xl p-4 text-center">
                                    <div class="text-sm text-slate-500 mb-1">Change</div>
                                    <div class="text-2xl font-bold ${weightTrend === 'down' ? 'text-emerald-600' : weightTrend === 'up' ? 'text-red-500' : 'text-slate-600'}">
                                        ${weightChange > 0 ? '+' : ''}${weightChange} kg
                                        ${weightTrend === 'down' ? '‚Üì' : weightTrend === 'up' ? '‚Üë' : '‚Üí'}
                                    </div>
                                </div>
                            </div>

                            <!-- Weight History -->
                            <div class="space-y-2">
                                <div class="text-sm font-semibold text-slate-600 mb-2">Recent Entries</div>
                                ${sortedWeights.length > 0 ? sortedWeights.slice(0, 7).map((entry, i) => `
                                    <div class="flex items-center justify-between py-2 px-3 rounded-lg ${i === 0 ? 'bg-emerald-50' : 'bg-slate-50'}">
                                        <span class="text-sm text-slate-600">${formatDateDisplay(entry.date)}</span>
                                        <span class="font-semibold ${i === 0 ? 'text-emerald-700' : 'text-slate-700'}">${entry.weight} kg</span>
                                    </div>
                                `).join('') : `
                                    <div class="text-center py-8 text-slate-400">
                                        <p>No weight entries yet</p>
                                        <p class="text-sm mt-1">Click "Log Weight" to start tracking</p>
                                    </div>
                                `}
                            </div>
                        </div>

                        <!-- Weekly Summary Card -->
                        <div class="bg-white rounded-3xl p-6 shadow-sm">
                            <h2 class="font-display text-xl font-semibold text-slate-800 mb-4">üìÖ This Week's Summary</h2>

                            <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                                <div class="bg-rose-50 rounded-2xl p-4 text-center">
                                    <div class="text-2xl mb-1">üçΩÔ∏è</div>
                                    <div class="text-xl font-bold text-rose-600">${weekStats.avgCalories}</div>
                                    <div class="text-xs text-rose-600/70">Avg Consumed</div>
                                </div>
                                <div class="bg-orange-50 rounded-2xl p-4 text-center">
                                    <div class="text-2xl mb-1">üî•</div>
                                    <div class="text-xl font-bold text-orange-600">${weekStats.avgCaloriesBurnt || 0}</div>
                                    <div class="text-xs text-orange-600/70">Avg Burnt</div>
                                </div>
                                <div class="bg-blue-50 rounded-2xl p-4 text-center">
                                    <div class="text-2xl mb-1">ü•©</div>
                                    <div class="text-xl font-bold text-blue-600">${weekStats.avgProtein}g</div>
                                    <div class="text-xs text-blue-600/70">Avg Protein</div>
                                </div>
                                <div class="bg-cyan-50 rounded-2xl p-4 text-center">
                                    <div class="text-2xl mb-1">üíß</div>
                                    <div class="text-xl font-bold text-cyan-600">${weekStats.avgWaterMl}ml</div>
                                    <div class="text-xs text-cyan-600/70">Avg Water</div>
                                </div>
                                <div class="bg-purple-50 rounded-2xl p-4 text-center">
                                    <div class="text-2xl mb-1">üí™</div>
                                    <div class="text-xl font-bold text-purple-600">${workoutCompletion}%</div>
                                    <div class="text-xs text-purple-600/70">Workouts Done</div>
                                </div>
                            </div>
                        </div>

                        <!-- Personal Records Card -->
                        <div class="bg-gradient-to-br from-orange-500 to-red-500 rounded-3xl p-6 shadow-xl text-white">
                            <h2 class="font-display text-xl font-semibold mb-4">üèÜ Personal Records</h2>
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                                ${(() => {
                                    const challenges = getAllChallengeExercises();
                                    if (challenges.length === 0) {
                                        return '<div class="col-span-full text-center py-4 text-white/80">No challenge exercises yet. Add challenges to your workouts!</div>';
                                    }
                                    return challenges.map(ch => {
                                        const pr = prLog[ch.name];
                                        return `
                                            <div class="bg-white/20 rounded-xl p-4">
                                                <div class="text-sm text-white/80 mb-1">${ch.name}</div>
                                                <div class="text-sm text-white/60 mb-2">(${ch.reps})</div>
                                                <div class="text-2xl font-bold">${pr ? (ch.prType === 'time' ? formatTime(pr.value) : pr.value + ' reps') : '‚Äî'}</div>
                                                ${pr ? `<div class="text-xs text-white/70 mt-1">${pr.date}</div>` : '<div class="text-xs text-white/60 mt-1">Not set</div>'}
                                            </div>
                                        `;
                                    }).join('');
                                })()}
                            </div>
                        </div>
                    </div>

                    <!-- Sidebar -->
                    <div class="space-y-5">
                        <!-- Goals Card -->
                        <div class="bg-white rounded-2xl p-5 shadow-sm">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="font-display text-lg font-semibold text-slate-800">üéØ Daily Goals</h3>
                                <button onclick="openGoalsModal()" class="text-blue-500 text-sm font-medium hover:text-blue-600">Edit</button>
                            </div>
                            <div class="space-y-3">
                                <div class="flex justify-between items-center py-2 border-b border-slate-100">
                                    <span class="text-slate-600">Calories</span>
                                    <span class="font-semibold text-slate-800">${goals.calories} kcal</span>
                                </div>
                                <div class="flex justify-between items-center py-2 border-b border-slate-100">
                                    <span class="text-slate-600">Protein</span>
                                    <span class="font-semibold text-slate-800">${goals.protein}g</span>
                                </div>
                                <div class="flex justify-between items-center py-2 border-b border-slate-100">
                                    <span class="text-slate-600">Carbs</span>
                                    <span class="font-semibold text-slate-800">${goals.carbs}g</span>
                                </div>
                                <div class="flex justify-between items-center py-2 border-b border-slate-100">
                                    <span class="text-slate-600">Fat</span>
                                    <span class="font-semibold text-slate-800">${goals.fat}g</span>
                                </div>
                                <div class="flex justify-between items-center py-2">
                                    <span class="text-slate-600">Target Weight</span>
                                    <span class="font-semibold text-emerald-600">${goals.targetWeight} kg</span>
                                </div>
                            </div>
                        </div>

                        <!-- Data Sync Card - Only shows if there are pending syncs or offline -->
                        ${pendingSyncs.length > 0 || isOffline ? `
                        <div class="bg-white rounded-2xl p-5 shadow-sm border-2 ${pendingSyncs.length > 0 ? 'border-orange-300' : 'border-slate-200'}">
                            <div class="flex items-center justify-between mb-3">
                                <h3 class="font-display text-lg font-semibold text-slate-800">‚òÅÔ∏è Sync Status</h3>
                                ${pendingSyncs.length > 0 ? `<span class="bg-orange-500 text-white text-xs font-bold px-2 py-1 rounded-full">${pendingSyncs.length} pending</span>` : ''}
                            </div>
                            <div class="text-sm text-slate-500 mb-4">
                                ${isOffline ? 'You are offline. Data will sync when connection is restored.' :
                                  pendingSyncs.length > 0 ? 'Some items failed to sync. Click below to retry.' :
                                  'All data synced successfully.'}
                            </div>
                            ${pendingSyncs.length > 0 ? `
                            <button onclick="processPendingSyncs()" class="w-full py-3 bg-orange-500 hover:bg-orange-600 text-white rounded-xl font-semibold transition-colors flex items-center justify-center gap-2">
                                <span>‚ü≥</span> Retry Sync (${pendingSyncs.length} items)
                            </button>
                            ` : ''}
                            <div id="syncStatusText" class="text-xs text-slate-400 mt-3 text-center"></div>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        // Helper function to get weekly stats - fetches from database
        let cachedWeeklyStats = { avgCalories: 0, avgProtein: 0, avgWaterMl: 0, avgCaloriesBurnt: 0 };

        async function fetchWeeklyStats() {
            try {
                const startDate = currentWeekStart.toISOString().split('T')[0];
                const result = await apiGet('getWeeklyStats', { startDate });
                if (result.success) {
                    cachedWeeklyStats = {
                        avgCalories: result.avgCalories || 0,
                        avgProtein: result.avgProtein || 0,
                        avgWaterMl: result.avgWaterMl || 0,
                        avgCaloriesBurnt: result.avgCaloriesBurnt || 0
                    };
                }
            } catch (error) {
                console.error('Failed to fetch weekly stats:', error);
            }
            return cachedWeeklyStats;
        }

        function getWeeklyStats() {
            // Return cached stats synchronously (for template rendering)
            return cachedWeeklyStats;
        }

        // Helper function to calculate workout completion
        function calculateWorkoutCompletion() {
            let completed = 0, total = 0;

            for (let i = 0; i < 7; i++) {
                const date = new Date(currentWeekStart);
                date.setDate(date.getDate() + i);
                const dateKey = date.toISOString().split('T')[0];

                const workout = getWorkoutForDate(dateKey);
                const workoutData = workoutDetails[workout.type];

                if (workoutData && workoutData.exercises) {
                    const exercises = workoutData.exercises.filter(e => !e.isRest && !e.isOptional);
                    total += exercises.length;

                    exercises.forEach((ex, idx) => {
                        if (exerciseChecks[`${dateKey}-${idx}`]) {
                            completed++;
                        }
                    });
                }
            }

            return total > 0 ? Math.round((completed / total) * 100) : 0;
        }

        // ==================== FOOD MODAL ====================
        let currentFoodModalTab = 'search';
        let comboFilter = 'all';

        function openFoodModal(mealType) {
            if (!isEditMode) {
                showToast('Unlock edit mode to add food', 'info');
                return;
            }
            currentMealType = mealType;
            comboFilter = 'all';
            currentFoodModalTab = 'search';
            document.getElementById('foodModal').classList.remove('hidden');
            document.getElementById('foodModal').classList.add('flex');
            document.getElementById('foodSearch').value = '';
            document.getElementById('foodSearch').focus();
            switchFoodModalTab('search');
            renderFoodResults(foodDatabase.slice(0, 20));
        }

        function switchFoodModalTab(tab) {
            currentFoodModalTab = tab;

            // Update tab button styles
            document.querySelectorAll('.food-modal-tab').forEach(btn => {
                if (btn.dataset.tab === tab) {
                    btn.classList.remove('bg-slate-100', 'text-slate-600');
                    btn.classList.add('bg-blue-500', 'text-white');
                } else {
                    btn.classList.add('bg-slate-100', 'text-slate-600');
                    btn.classList.remove('bg-blue-500', 'text-white');
                }
            });

            // Show/hide tab content
            const searchTab = document.getElementById('searchTabContent');
            const combosTab = document.getElementById('combosTabContent');

            if (tab === 'search') {
                searchTab.classList.remove('hidden');
                combosTab.classList.add('hidden');
                document.getElementById('foodSearch').focus();
            } else {
                searchTab.classList.add('hidden');
                combosTab.classList.remove('hidden');
                renderQuickCombos();
            }
        }

        function filterCombos(category) {
            comboFilter = category;

            // Update tab styles
            document.querySelectorAll('.combo-tab').forEach(tab => {
                if (tab.dataset.category === category) {
                    tab.classList.remove('bg-slate-100', 'text-slate-600');
                    tab.classList.add('bg-blue-500', 'text-white');
                } else {
                    tab.classList.add('bg-slate-100', 'text-slate-600');
                    tab.classList.remove('bg-blue-500', 'text-white');
                }
            });

            renderQuickCombos();
        }

        function getTagBadge(combo) {
            if (!combo.tag) return '';

            const tagStyles = {
                'Default': 'bg-blue-100 text-blue-700',
                'High': 'bg-amber-100 text-amber-700',
                'Highest': 'bg-purple-100 text-purple-700',
                'Light': 'bg-green-100 text-green-700',
                'Max Protein': 'bg-indigo-100 text-indigo-700',
                'Veg': 'bg-emerald-100 text-emerald-700',
                'Cheat': 'bg-red-100 text-red-700'
            };

            const damageIcons = { low: 'üü¢', medium: 'üü°', high: 'üî¥' };
            const damageText = combo.damageLevel ? ` ${damageIcons[combo.damageLevel]}` : '';

            return `<span class="text-[10px] px-1.5 py-0.5 rounded ${tagStyles[combo.tag] || 'bg-slate-100 text-slate-600'}">${combo.tag}${damageText}</span>`;
        }

        function renderQuickCombos() {
            const container = document.getElementById('quickCombos');

            // Filter by category
            let filteredCombos = comboFilter === 'all'
                ? savedMealCombos
                : savedMealCombos.filter(c => c.category === comboFilter);

            // Get combo background based on category
            const getComboBg = (combo) => {
                if (combo.category === 'cheat') return 'from-red-50 to-orange-50 border-red-200 hover:from-red-100 hover:to-orange-100';
                if (combo.tag === 'Highest' || combo.tag === 'Max Protein') return 'from-purple-50 to-indigo-50 border-purple-200 hover:from-purple-100 hover:to-indigo-100';
                if (combo.tag === 'High') return 'from-amber-50 to-yellow-50 border-amber-200 hover:from-amber-100 hover:to-yellow-100';
                if (combo.tag === 'Light') return 'from-green-50 to-emerald-50 border-green-200 hover:from-green-100 hover:to-emerald-100';
                return 'from-blue-50 to-indigo-50 border-blue-200 hover:from-blue-100 hover:to-indigo-100';
            };

            // Always show in grid layout with scroll support
            container.className = 'flex-1 overflow-y-auto p-4 grid grid-cols-2 gap-2 content-start';

            // Helper to get combo macros (handles legacy combos without all macros stored)
            const getComboMacros = (combo) => {
                if (combo.totalCarbs !== undefined) {
                    return { carbs: combo.totalCarbs, fat: combo.totalFat, fiber: combo.totalFiber || 0 };
                }
                // Calculate from items for legacy combos
                return combo.items.reduce((acc, item) => ({
                    carbs: acc.carbs + (item.carbs || 0),
                    fat: acc.fat + (item.fat || 0),
                    fiber: acc.fiber + (item.fiber || 0)
                }), { carbs: 0, fat: 0, fiber: 0 });
            };

            container.innerHTML = filteredCombos.map(combo => {
                const macros = getComboMacros(combo);
                return `
                <button onclick="showComboPreview(${parseInt(combo.id)})" class="p-3 bg-gradient-to-br ${getComboBg(combo)} border rounded-xl transition-all text-left hover:shadow-md">
                    <div class="flex items-start gap-2">
                        <span class="text-xl">${escapeHtml(combo.emoji)}</span>
                        <div class="flex-1 min-w-0">
                            <div class="flex flex-wrap items-center gap-1 mb-1">
                                <span class="text-xs font-semibold text-slate-700 leading-tight">${escapeHtml(combo.name)}</span>
                                ${getTagBadge(combo)}
                            </div>
                            <div class="text-[10px] font-medium text-rose-500">${parseInt(combo.totalCalories)} kcal</div>
                            <div class="flex flex-wrap gap-x-2 text-[10px]">
                                <span class="text-amber-600">${parseInt(combo.totalProtein)}g P</span>
                                <span class="text-blue-600">${Math.round(macros.carbs)}g C</span>
                                <span class="text-pink-500">${Math.round(macros.fat)}g F</span>
                            </div>
                        </div>
                    </div>
                </button>
            `}).join('');

            if (filteredCombos.length === 0) {
                container.innerHTML = `
                    <div class="col-span-2 text-center text-slate-400 py-8">
                        No combos in this category
                    </div>
                `;
            }
        }

        function showComboPreview(comboId) {
            const combo = savedMealCombos.find(c => c.id === comboId);
            if (!combo) return;

            // Switch to search tab to show the preview
            switchFoodModalTab('search');

            // Create preview modal content
            const itemsList = combo.items.map(item =>
                `<div class="flex justify-between text-sm py-1">
                    <span class="text-slate-600">${item.quantity} ${item.unit} ${item.foodName}</span>
                    <span class="text-slate-400">${item.calories} kcal</span>
                </div>`
            ).join('');

            // Update the food search results area to show combo preview
            const container = document.getElementById('foodSearchResults');
            container.innerHTML = `
                <div class="text-center mb-4">
                    <span class="text-4xl mb-2 block">${combo.emoji}</span>
                    <h3 class="font-semibold text-lg text-slate-800">${combo.name}</h3>
                    <p class="text-sm text-slate-500">Add all ${combo.items.length} items to your meal</p>
                </div>

                <div class="bg-slate-50 rounded-xl p-3 mb-4">
                    <div class="grid grid-cols-4 gap-2 text-center text-xs mb-3">
                        <div><div class="font-bold text-rose-500">${combo.totalCalories}</div><div class="text-slate-400">kcal</div></div>
                        <div><div class="font-bold text-amber-600">${combo.totalProtein}g</div><div class="text-slate-400">protein</div></div>
                        <div><div class="font-bold text-blue-600">${Math.round(combo.items.reduce((s, i) => s + i.carbs, 0))}g</div><div class="text-slate-400">carbs</div></div>
                        <div><div class="font-bold text-pink-500">${Math.round(combo.items.reduce((s, i) => s + i.fat, 0))}g</div><div class="text-slate-400">fat</div></div>
                    </div>
                    <div class="border-t border-slate-200 pt-2">
                        ${itemsList}
                    </div>
                </div>

                <div class="flex gap-2 mb-2">
                    <button onclick="switchFoodModalTab('combos')" class="flex-1 py-2.5 bg-slate-100 hover:bg-slate-200 text-slate-600 rounded-xl font-medium transition-all text-sm">
                        ‚Üê Back
                    </button>
                    <button onclick="editCombo(${combo.id})" class="py-2.5 px-4 bg-amber-100 hover:bg-amber-200 text-amber-700 rounded-xl font-medium transition-all text-sm edit-only">
                        ‚úèÔ∏è Edit
                    </button>
                    <button onclick="deleteCombo(${combo.id})" class="py-2.5 px-4 bg-red-100 hover:bg-red-200 text-red-600 rounded-xl font-medium transition-all text-sm edit-only">
                        üóëÔ∏è
                    </button>
                </div>
                <button onclick="addComboToMeal(${combo.id})" class="w-full py-2.5 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-xl font-semibold transition-all shadow-lg shadow-blue-500/30 text-sm edit-only">
                    + Add All Items
                </button>
            `;
        }

        async function addComboToMeal(comboId) {
            if (!isEditMode) {
                showToast('Unlock edit mode to add combo', 'info');
                return;
            }
            const combo = savedMealCombos.find(c => c.id === comboId);
            if (!combo) return;

            // Close modal and show saving indicator
            closeFoodModal();
            showApiStatus('saving', `Adding ${combo.items.length} items...`);

            let successCount = 0;
            let failedItems = [];

            // DATABASE-FIRST: Save each item to server first
            for (const item of combo.items) {
                const mealItem = {
                    date: selectedDate,
                    mealType: currentMealType,
                    foodId: item.foodId || 0,
                    foodName: item.foodName,
                    quantity: item.quantity,
                    unit: item.unit,
                    calories: item.calories,
                    protein: item.protein,
                    carbs: item.carbs,
                    fat: item.fat,
                    fiber: item.fiber || 0
                };

                const result = await apiPost('logMeal', mealItem);
                if (result.success && result.id) {
                    // Success - add to local state with database ID
                    mealItem.id = result.id;
                    if (!dailyMeals[currentMealType]) dailyMeals[currentMealType] = [];
                    dailyMeals[currentMealType].push(mealItem);
                    dailyTotals.calories += mealItem.calories;
                    dailyTotals.protein += mealItem.protein;
                    dailyTotals.carbs += mealItem.carbs;
                    dailyTotals.fat += mealItem.fat;
                    dailyTotals.fiber += mealItem.fiber;
                    successCount++;
                } else {
                    failedItems.push(item.foodName);
                }
            }

            // Update UI
            updateMacroDisplay();
            renderTabContent();

            // Show result
            if (failedItems.length === 0) {
                showApiStatus('success', `${successCount} items added!`);
            } else {
                showApiStatus('error', `Failed to add: ${failedItems.join(', ')}`);
                console.error('Combo add failed items:', failedItems);
            }
        }

        function closeFoodModal() {
            document.getElementById('foodModal').classList.add('hidden');
            document.getElementById('foodModal').classList.remove('flex');
        }

        function searchFoods(query) {
            let filtered = foodDatabase;

            if (query.trim()) {
                const q = query.toLowerCase();
                filtered = foodDatabase.filter(f =>
                    f.name.toLowerCase().includes(q)
                );
            }

            renderFoodResults(filtered.slice(0, 30));
        }

        function filterByCategory(category) {
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('bg-blue-100', 'text-blue-700');
                btn.classList.add('bg-slate-100', 'text-slate-600');
            });
            event.target.classList.remove('bg-slate-100', 'text-slate-600');
            event.target.classList.add('bg-blue-100', 'text-blue-700');

            let filtered = foodDatabase;
            if (category !== 'all') {
                filtered = foodDatabase.filter(f => f.category === category);
            }
            renderFoodResults(filtered.slice(0, 30));
        }

        function renderFoodResults(foods) {
            const container = document.getElementById('foodSearchResults');

            if (foods.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-slate-400 py-8">
                        No foods found. Try a different search or add a custom food.
                    </div>
                `;
                return;
            }

            container.innerHTML = foods.map(food => `
                <div class="food-item p-3 rounded-xl cursor-pointer transition-all border border-transparent hover:border-blue-200 hover:bg-blue-50/50" onclick="selectFood(${parseInt(food.id)})">
                    <div class="flex items-center justify-between mb-1.5">
                        <div>
                            <div class="font-medium text-slate-800">${escapeHtml(food.name)}</div>
                            <div class="text-xs text-slate-500">${escapeHtml(food.serving)} ${escapeHtml(food.unit)} ‚Ä¢ ${escapeHtml(food.category)}</div>
                        </div>
                        <div class="font-bold text-rose-500">${parseInt(food.calories)} kcal</div>
                    </div>
                    <div class="flex gap-3 text-xs">
                        <span class="text-amber-600 font-medium">${parseFloat(food.protein)}g P</span>
                        <span class="text-blue-600 font-medium">${parseFloat(food.carbs)}g C</span>
                        <span class="text-pink-500 font-medium">${parseFloat(food.fat)}g F</span>
                        <span class="text-emerald-600 font-medium">${parseFloat(food.fiber || 0)}g Fiber</span>
                    </div>
                </div>
            `).join('');
        }

        // ==================== QUANTITY MODAL ====================
        function selectFood(foodId) {
            selectedFood = foodDatabase.find(f => f.id === foodId);
            if (!selectedFood) return;

            closeFoodModal();

            document.getElementById('quantityModal').classList.remove('hidden');
            document.getElementById('quantityModal').classList.add('flex');

            document.getElementById('quantityFoodName').textContent = selectedFood.name;
            document.getElementById('quantityFoodMacros').textContent = `Per serving (${selectedFood.serving} ${selectedFood.unit}): ${selectedFood.calories} kcal ‚Ä¢ ${selectedFood.protein}g protein`;
            document.getElementById('quantityInput').value = 1;
            document.getElementById('quantityUnit').textContent = `serving(s) of ${selectedFood.serving} ${selectedFood.unit}`;

            updateQuantityPreview();
        }

        function closeQuantityModal() {
            document.getElementById('quantityModal').classList.add('hidden');
            document.getElementById('quantityModal').classList.remove('flex');
            selectedFood = null;
        }

        function adjustQuantity(delta) {
            const input = document.getElementById('quantityInput');
            let value = parseFloat(input.value) + delta;
            if (value < 0.5) value = 0.5;
            input.value = value;
            updateQuantityPreview();
        }

        function updateQuantityPreview() {
            const quantity = parseFloat(document.getElementById('quantityInput').value) || 1;
            if (!selectedFood) return;

            document.getElementById('qCal').textContent = Math.round(selectedFood.calories * quantity);
            document.getElementById('qProtein').textContent = Math.round(selectedFood.protein * quantity) + 'g';
            document.getElementById('qCarbs').textContent = Math.round(selectedFood.carbs * quantity) + 'g';
            document.getElementById('qFat').textContent = Math.round(selectedFood.fat * quantity) + 'g';
            document.getElementById('qFiber').textContent = Math.round(selectedFood.fiber * quantity) + 'g';
        }

        document.addEventListener('DOMContentLoaded', () => {
            const quantityInput = document.getElementById('quantityInput');
            if (quantityInput) {
                quantityInput.addEventListener('input', updateQuantityPreview);
            }
        });

        async function confirmAddFood() {
            if (!selectedFood) return;

            const quantity = parseFloat(document.getElementById('quantityInput').value) || 1;

            const mealItem = {
                date: selectedDate,
                mealType: currentMealType,
                foodId: selectedFood.id,
                foodName: selectedFood.name,
                quantity: quantity,
                unit: selectedFood.unit,
                calories: Math.round(selectedFood.calories * quantity),
                protein: Math.round(selectedFood.protein * quantity * 10) / 10,
                carbs: Math.round(selectedFood.carbs * quantity * 10) / 10,
                fat: Math.round(selectedFood.fat * quantity * 10) / 10,
                fiber: Math.round(selectedFood.fiber * quantity * 10) / 10
            };

            // Close modal and show saving indicator
            closeQuantityModal();
            showApiStatus('saving', 'Adding food...');

            // DATABASE-FIRST: Save to server first
            const result = await apiPost('logMeal', mealItem);

            if (result.success) {
                // Success - update local state with the database ID
                mealItem.id = result.id;

                if (!dailyMeals[currentMealType]) dailyMeals[currentMealType] = [];
                dailyMeals[currentMealType].push(mealItem);
                dailyTotals.calories += mealItem.calories;
                dailyTotals.protein += mealItem.protein;
                dailyTotals.carbs += mealItem.carbs;
                dailyTotals.fat += mealItem.fat;
                dailyTotals.fiber += mealItem.fiber;

                // Update UI
                updateMacroDisplay();
                renderTabContent();
                updateStreakDisplay();
                showApiStatus('success', 'Food added!');
            } else {
                // FAILED - Show clear error to user
                showApiStatus('error', result.error || 'Failed to add food. Please try again.');
                console.error('API Error:', result);
            }
        }

        // Sync to server with automatic retry
        async function syncToServerWithRetry(action, data, onSuccess = null, maxRetries = 3) {
            showSyncStatus('syncing');

            for (let attempt = 1; attempt <= maxRetries; attempt++) {
                try {
                    const result = await apiPost(action, data);
                    if (result.success) {
                        showSyncStatus('success');
                        if (onSuccess) onSuccess(result);
                        // Remove from pending if it was there
                        removePendingSync(action, data);
                        return result;
                    } else {
                        console.error(`Sync attempt ${attempt} failed:`, result.error);
                        if (attempt === maxRetries) {
                            // All retries failed, add to pending queue
                            addPendingSync(action, data);
                            showSyncStatus('error', 'Will retry when online');
                        }
                    }
                } catch (e) {
                    console.error(`Sync attempt ${attempt} error:`, e);
                    if (attempt === maxRetries) {
                        addPendingSync(action, data);
                        showSyncStatus('error', 'Will retry when online');
                    }
                }
                // Wait before retry (exponential backoff)
                if (attempt < maxRetries) {
                    await new Promise(r => setTimeout(r, 1000 * attempt));
                }
            }
            return { success: false };
        }

        // Add item to pending sync queue
        function addPendingSync(action, data) {
            const syncItem = { action, data, timestamp: Date.now() };
            // Avoid duplicates
            const exists = pendingSyncs.some(s =>
                s.action === action && JSON.stringify(s.data) === JSON.stringify(data)
            );
            if (!exists) {
                pendingSyncs.push(syncItem);
                localStorage.setItem('fitlife_pending_syncs', JSON.stringify(pendingSyncs));
                updatePendingSyncUI();
            }
        }

        // Remove item from pending sync queue
        function removePendingSync(action, data) {
            pendingSyncs = pendingSyncs.filter(s =>
                !(s.action === action && JSON.stringify(s.data) === JSON.stringify(data))
            );
            localStorage.setItem('fitlife_pending_syncs', JSON.stringify(pendingSyncs));
            updatePendingSyncUI();
        }

        // Mutex to prevent concurrent sync operations
        let isSyncInProgress = false;

        // Process pending syncs when back online
        async function processPendingSyncs() {
            // Prevent concurrent execution
            if (pendingSyncs.length === 0 || isSyncInProgress) return;

            isSyncInProgress = true;
            showSyncStatus('syncing');
            let synced = 0, failed = 0;
            const toProcess = [...pendingSyncs];

            for (const item of toProcess) {
                try {
                    const result = await apiPost(item.action, item.data);
                    if (result.success) {
                        removePendingSync(item.action, item.data);
                        synced++;

                        // If it was a logMeal, update the local item with the database ID
                        if (item.action === 'logMeal' && result.id) {
                            updateLocalMealId(item.data, result.id);
                        }
                    } else {
                        failed++;
                    }
                } catch (e) {
                    failed++;
                }
            }

            if (synced > 0) {
                // Reload data from server to ensure consistency
                await loadDailyData();
                renderTabContent();
            }

            if (failed === 0 && synced > 0) {
                showSyncStatus('success');
                showToast(`${synced} item(s) synced successfully`, 'success');
            } else if (failed > 0) {
                showSyncStatus('error', `${failed} items still pending`);
            }

            // Release the mutex
            isSyncInProgress = false;
        }

        // Update local meal with database ID after successful sync
        function updateLocalMealId(mealData, dbId) {
            const mealType = mealData.mealType;
            const items = dailyMeals[mealType];
            if (!items) return;

            // Find the matching item using ALL fields for exact identification
            // This prevents issues when same food is added multiple times
            for (const item of items) {
                if (item.foodName === mealData.foodName &&
                    item.date === mealData.date &&
                    item.calories === mealData.calories &&
                    item.protein === mealData.protein &&
                    item.quantity === mealData.quantity &&
                    !item.id) {
                    item.id = dbId;
                    break;
                }
            }

            // Save updated meals to localStorage with error handling
            safeLocalStorageSet(`fitlife_meals_${selectedDate}`, JSON.stringify({
                meals: dailyMeals,
                totals: dailyTotals
            }));
        }

        // Safe localStorage setter with quota handling
        function safeLocalStorageSet(key, value) {
            try {
                localStorage.setItem(key, value);
                return true;
            } catch (e) {
                if (e.name === 'QuotaExceededError') {
                    console.error('localStorage quota exceeded, clearing old data...');
                    // Clear meal data older than 7 days
                    const now = new Date();
                    const keys = Object.keys(localStorage);
                    for (const k of keys) {
                        if (k.startsWith('fitlife_meals_')) {
                            const dateStr = k.replace('fitlife_meals_', '');
                            const daysDiff = Math.floor((now - new Date(dateStr)) / (1000 * 60 * 60 * 24));
                            if (daysDiff > 7) {
                                localStorage.removeItem(k);
                            }
                        }
                    }
                    // Retry after cleanup
                    try {
                        localStorage.setItem(key, value);
                        return true;
                    } catch (retryError) {
                        console.error('Still failed after cleanup:', retryError);
                        showToast('Storage full - some data may not be saved', 'warning');
                        return false;
                    }
                }
                console.error('localStorage error:', e);
                return false;
            }
        }

        // Update UI to show pending syncs count
        function updatePendingSyncUI() {
            const badge = document.getElementById('pendingSyncBadge');
            if (badge) {
                if (pendingSyncs.length > 0) {
                    badge.textContent = pendingSyncs.length;
                    badge.classList.remove('hidden');
                } else {
                    badge.classList.add('hidden');
                }
            }
        }

        // Listen for online/offline events
        window.addEventListener('online', () => {
            console.log('Back online, processing pending syncs...');
            setOfflineMode(false);
            processPendingSyncs();
        });

        window.addEventListener('offline', () => {
            console.log('Gone offline');
            setOfflineMode(true);
        });

        // Periodic retry for pending syncs (every 30 seconds)
        setInterval(() => {
            if (!isOffline && pendingSyncs.length > 0) {
                console.log('Periodic sync retry...');
                processPendingSyncs();
            }
        }, 30000);

        // Show sync status toast
        function showSyncStatus(status, message = '') {
            // Remove existing toast
            const existingToast = document.getElementById('syncToast');
            if (existingToast) existingToast.remove();

            const toast = document.createElement('div');
            toast.id = 'syncToast';
            toast.className = 'fixed bottom-20 left-1/2 -translate-x-1/2 px-4 py-2 rounded-full text-sm font-medium shadow-lg z-50 transition-all';

            if (status === 'syncing') {
                toast.className += ' bg-blue-500 text-white';
                toast.innerHTML = '<span class="inline-block animate-spin mr-2">‚ü≥</span> Saving...';
            } else if (status === 'success') {
                toast.className += ' bg-green-500 text-white';
                toast.innerHTML = '‚úì Saved';
                setTimeout(() => toast.remove(), 2000);
            } else if (status === 'error') {
                toast.className += ' bg-red-500 text-white';
                toast.innerHTML = `‚úó ${message || 'Sync failed'} - saved locally`;
                setTimeout(() => toast.remove(), 4000);
            }

            document.body.appendChild(toast);
        }

        // Clear, visible API status indicator for database-first operations
        function showApiStatus(status, message) {
            // Remove existing status
            const existing = document.getElementById('apiStatusBanner');
            if (existing) existing.remove();

            const banner = document.createElement('div');
            banner.id = 'apiStatusBanner';
            banner.className = 'fixed top-4 left-1/2 -translate-x-1/2 px-6 py-3 rounded-xl shadow-2xl z-[100] flex items-center gap-3 text-base font-semibold max-w-md';

            if (status === 'saving') {
                banner.className += ' bg-blue-600 text-white';
                banner.innerHTML = `
                    <div class="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                    <span>${message}</span>
                `;
            } else if (status === 'success') {
                banner.className += ' bg-emerald-500 text-white';
                banner.innerHTML = `
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
                    </svg>
                    <span>${message}</span>
                `;
                setTimeout(() => banner.remove(), 2000);
            } else if (status === 'error') {
                banner.className += ' bg-red-500 text-white';
                banner.innerHTML = `
                    <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span>${message}</span>
                    <button onclick="this.parentElement.remove()" class="ml-2 text-white/80 hover:text-white">‚úï</button>
                `;
                // Keep error visible longer, user can dismiss
                setTimeout(() => banner.remove(), 8000);
            }

            document.body.appendChild(banner);
        }

        async function deleteFood(mealType, index) {
            if (!isEditMode) {
                showToast('Unlock edit mode to delete food', 'info');
                return;
            }
            const item = dailyMeals[mealType][index];
            if (!item) return;

            // Item must have been saved to database (has ID)
            if (!item.id) {
                showApiStatus('error', 'Cannot delete - item not saved to database');
                return;
            }

            // DATABASE-FIRST: Delete from server first
            showApiStatus('saving', 'Deleting...');
            const result = await apiPost('deleteMeal', { id: item.id });

            if (result.success) {
                // Success - now remove from local state
                dailyMeals[mealType].splice(index, 1);
                dailyTotals.calories -= item.calories;
                dailyTotals.protein -= item.protein;
                dailyTotals.carbs -= item.carbs;
                dailyTotals.fat -= item.fat;
                dailyTotals.fiber -= item.fiber;

                // Update UI
                updateMacroDisplay();
                renderTabContent();
                showApiStatus('success', 'Deleted!');
            } else {
                // FAILED - Show clear error
                showApiStatus('error', result.error || 'Failed to delete. Please try again.');
                console.error('Delete API Error:', result);
            }
        }

        // ==================== EDIT MEAL ITEM ====================
        let editingMealType = null;
        let editingMealIndex = null;
        let editingMealOriginal = null;

        function editMealItem(mealType, index) {
            if (!isEditMode) {
                showToast('Unlock edit mode to edit food', 'info');
                return;
            }
            const item = dailyMeals[mealType][index];
            if (!item) return;

            editingMealType = mealType;
            editingMealIndex = index;
            editingMealOriginal = { ...item };

            // Populate modal
            document.getElementById('editMealFoodName').textContent = item.foodName;
            document.getElementById('editMealQuantity').value = item.quantity;
            document.getElementById('editMealUnit').value = item.unit;

            // Calculate per-unit values
            updateEditMealPreview();

            // Show modal
            document.getElementById('editMealModal').classList.remove('hidden');
            document.getElementById('editMealModal').classList.add('flex');

            // Add event listener for quantity changes
            document.getElementById('editMealQuantity').oninput = updateEditMealPreview;
        }

        function closeEditMealModal() {
            document.getElementById('editMealModal').classList.add('hidden');
            document.getElementById('editMealModal').classList.remove('flex');
            editingMealType = null;
            editingMealIndex = null;
            editingMealOriginal = null;
        }

        function updateEditMealPreview() {
            const quantity = parseFloat(document.getElementById('editMealQuantity').value) || 1;
            const original = editingMealOriginal;
            if (!original) return;

            // Calculate per-unit macros from original item
            const perUnit = {
                calories: original.calories / original.quantity,
                protein: original.protein / original.quantity,
                carbs: original.carbs / original.quantity,
                fat: original.fat / original.quantity,
                fiber: (original.fiber || 0) / original.quantity
            };

            // Calculate new totals
            document.getElementById('editMealCal').textContent = Math.round(perUnit.calories * quantity);
            document.getElementById('editMealProtein').textContent = Math.round(perUnit.protein * quantity);
            document.getElementById('editMealCarbs').textContent = Math.round(perUnit.carbs * quantity);
            document.getElementById('editMealFat').textContent = Math.round(perUnit.fat * quantity);
            document.getElementById('editMealFiber').textContent = Math.round(perUnit.fiber * quantity);
        }

        async function saveMealEdit() {
            if (editingMealType === null || editingMealIndex === null) return;

            const newQuantity = parseFloat(document.getElementById('editMealQuantity').value) || 1;
            const newUnit = document.getElementById('editMealUnit').value.trim() || editingMealOriginal.unit;
            const item = dailyMeals[editingMealType][editingMealIndex];
            const original = editingMealOriginal;

            // Item must have been saved to database
            if (!item.id) {
                showApiStatus('error', 'Cannot edit - item not saved to database');
                closeEditMealModal();
                return;
            }

            // Calculate per-unit macros
            const perUnit = {
                calories: original.calories / original.quantity,
                protein: original.protein / original.quantity,
                carbs: original.carbs / original.quantity,
                fat: original.fat / original.quantity,
                fiber: (original.fiber || 0) / original.quantity
            };

            // Calculate new values
            const newValues = {
                quantity: newQuantity,
                unit: newUnit,
                calories: Math.round(perUnit.calories * newQuantity),
                protein: Math.round(perUnit.protein * newQuantity),
                carbs: Math.round(perUnit.carbs * newQuantity),
                fat: Math.round(perUnit.fat * newQuantity),
                fiber: Math.round(perUnit.fiber * newQuantity)
            };

            // Close modal and show saving indicator
            closeEditMealModal();
            showApiStatus('saving', 'Updating...');

            // DATABASE-FIRST: Update server first
            const result = await apiPost('updateMeal', {
                id: item.id,
                ...newValues
            });

            if (result.success) {
                // Success - update local state
                const oldCals = item.calories;
                const oldProtein = item.protein;
                const oldCarbs = item.carbs;
                const oldFat = item.fat;
                const oldFiber = item.fiber || 0;

                // Update item
                Object.assign(item, newValues);

                // Update totals
                dailyTotals.calories += (item.calories - oldCals);
                dailyTotals.protein += (item.protein - oldProtein);
                dailyTotals.carbs += (item.carbs - oldCarbs);
                dailyTotals.fat += (item.fat - oldFat);
                dailyTotals.fiber += (item.fiber - oldFiber);

                // Update UI
                updateMacroDisplay();
                renderTabContent();
                showApiStatus('success', 'Updated!');
            } else {
                // FAILED - Show clear error
                showApiStatus('error', result.error || 'Failed to update. Please try again.');
                console.error('Update API Error:', result);
            }
        }

        // ==================== CUSTOM FOOD ====================
        function openCustomFoodModal() {
            closeFoodModal();
            document.getElementById('customFoodModal').classList.remove('hidden');
            document.getElementById('customFoodModal').classList.add('flex');
        }

        function closeCustomFoodModal() {
            document.getElementById('customFoodModal').classList.add('hidden');
            document.getElementById('customFoodModal').classList.remove('flex');
        }

        async function saveCustomFood() {
            const name = document.getElementById('customName').value.trim();
            const calories = parseFloat(document.getElementById('customCalories').value) || 0;

            if (!name || !calories) {
                showApiStatus('error', 'Please enter at least a name and calories');
                return;
            }

            const customFood = {
                name: name,
                category: 'Custom',
                calories: calories,
                protein: parseFloat(document.getElementById('customProtein').value) || 0,
                carbs: parseFloat(document.getElementById('customCarbs').value) || 0,
                fat: parseFloat(document.getElementById('customFat').value) || 0,
                fiber: parseFloat(document.getElementById('customFiber').value) || 0,
                serving: parseFloat(document.getElementById('customServing').value) || 1,
                unit: document.getElementById('customUnit').value
            };

            // Close modal and show saving indicator
            closeCustomFoodModal();
            showApiStatus('saving', 'Creating custom food...');

            // DATABASE-FIRST: Save to server first
            const result = await apiPost('addCustomFood', { food: customFood });

            if (result.success) {
                // Success - add to local database with server-assigned ID
                customFood.id = result.id || (foodDatabase.length + 1000);
                foodDatabase.push(customFood);
                selectFood(customFood.id);
                showApiStatus('success', 'Custom food created!');
            } else {
                // FAILED - Show clear error
                showApiStatus('error', result.error || 'Failed to create custom food. Please try again.');
                console.error('Custom Food API Error:', result);
            }
        }

        // ==================== CREATE COMBO MODAL ====================
        let newComboItems = [];
        let newComboEmoji = 'üçΩÔ∏è';
        let editingComboId = null; // Track if editing an existing combo

        function openCreateComboModal() {
            // Reset form
            editingComboId = null;
            newComboItems = [];
            newComboEmoji = 'üçΩÔ∏è';
            document.getElementById('comboName').value = '';
            document.getElementById('comboCategory').value = 'breakfast';
            document.getElementById('comboTag').value = '';
            document.getElementById('selectedEmoji').textContent = 'üçΩÔ∏è';
            document.getElementById('comboFoodSearch').value = '';
            document.getElementById('comboFoodResults').innerHTML = '<div class="text-center text-slate-400 py-4 text-sm">Search for foods to add</div>';
            updateComboItemsList();
            updateComboTotals();

            // Update modal title
            document.getElementById('comboModalTitle').textContent = 'Create Meal Combo';

            // Close food modal if open
            closeFoodModal();

            document.getElementById('createComboModal').classList.remove('hidden');
            document.getElementById('createComboModal').classList.add('flex');
        }

        function closeCreateComboModal() {
            document.getElementById('createComboModal').classList.add('hidden');
            document.getElementById('createComboModal').classList.remove('flex');
            document.getElementById('emojiPicker').classList.add('hidden');
        }

        function editCombo(comboId) {
            if (!isEditMode) {
                showToast('Unlock edit mode to edit combo', 'info');
                return;
            }
            const combo = savedMealCombos.find(c => c.id === comboId);
            if (!combo) return;

            // Set editing mode
            editingComboId = comboId;

            // Populate form with combo data
            newComboEmoji = combo.emoji || 'üçΩÔ∏è';
            document.getElementById('comboName').value = combo.name;
            document.getElementById('comboCategory').value = combo.category || 'breakfast';
            document.getElementById('comboTag').value = combo.tag || '';
            document.getElementById('selectedEmoji').textContent = newComboEmoji;

            // Convert combo items to editable format (need to reverse the quantity multiplication)
            newComboItems = combo.items.map(item => {
                // Find original food to get per-unit values
                const food = foodDatabase.find(f => f.id === item.foodId);
                if (food) {
                    return {
                        foodId: item.foodId,
                        foodName: item.foodName,
                        quantity: item.quantity,
                        unit: item.unit,
                        serving: food.serving,
                        calories: food.calories,
                        protein: food.protein,
                        carbs: food.carbs,
                        fat: food.fat,
                        fiber: food.fiber || 0
                    };
                } else {
                    // For items without matching food, use stored values as-is
                    return {
                        foodId: item.foodId || 0,
                        foodName: item.foodName,
                        quantity: item.quantity,
                        unit: item.unit,
                        serving: 1,
                        calories: item.calories / item.quantity,
                        protein: item.protein / item.quantity,
                        carbs: item.carbs / item.quantity,
                        fat: item.fat / item.quantity,
                        fiber: (item.fiber || 0) / item.quantity
                    };
                }
            });

            // Update UI
            updateComboItemsList();
            updateComboTotals();

            // Update modal title
            document.getElementById('comboModalTitle').textContent = 'Edit Combo';

            // Close food modal and open combo modal
            closeFoodModal();
            document.getElementById('createComboModal').classList.remove('hidden');
            document.getElementById('createComboModal').classList.add('flex');
        }

        async function deleteCombo(comboId) {
            if (!isEditMode) {
                showToast('Unlock edit mode to delete combo', 'info');
                return;
            }
            const combo = savedMealCombos.find(c => c.id === comboId);
            if (!combo) return;

            if (!confirm(`Delete "${combo.name}" combo?`)) return;

            // DATABASE-FIRST: Delete from server first
            showApiStatus('saving', 'Deleting combo...');
            const result = await apiPost('deleteMealCombo', { id: comboId });

            if (result.success) {
                // Success - remove from local array
                const index = savedMealCombos.findIndex(c => c.id === comboId);
                if (index > -1) {
                    savedMealCombos.splice(index, 1);
                }

                // Close preview and re-render
                switchFoodModalTab('combos');
                renderQuickCombos();
                showApiStatus('success', 'Combo deleted!');
            } else {
                showApiStatus('error', result.error || 'Failed to delete combo');
                console.error('Delete Combo API Error:', result);
            }
        }

        function toggleEmojiPicker() {
            document.getElementById('emojiPicker').classList.toggle('hidden');
        }

        function selectComboEmoji(emoji) {
            newComboEmoji = emoji;
            document.getElementById('selectedEmoji').textContent = emoji;
            document.getElementById('emojiPicker').classList.add('hidden');
        }

        function searchFoodsForCombo(query) {
            const container = document.getElementById('comboFoodResults');

            if (!query || query.length < 2) {
                container.innerHTML = '<div class="text-center text-slate-400 py-4 text-sm">Search for foods to add</div>';
                return;
            }

            const results = foodDatabase.filter(f =>
                f.name.toLowerCase().includes(query.toLowerCase())
            ).slice(0, 8);

            if (results.length === 0) {
                container.innerHTML = '<div class="text-center text-slate-400 py-4 text-sm">No foods found</div>';
                return;
            }

            container.innerHTML = results.map(food => `
                <div class="flex items-center justify-between p-2 hover:bg-slate-50 cursor-pointer border-b border-slate-100 last:border-0" onclick="addFoodToCombo(${parseInt(food.id)})">
                    <div>
                        <div class="text-sm font-medium text-slate-700">${escapeHtml(food.name)}</div>
                        <div class="text-xs text-slate-400">${escapeHtml(food.serving)} ${escapeHtml(food.unit)}</div>
                    </div>
                    <div class="text-right">
                        <div class="text-xs font-medium text-rose-500">${parseInt(food.calories)} kcal</div>
                        <div class="text-xs text-slate-400">${parseFloat(food.protein)}g P</div>
                    </div>
                </div>
            `).join('');
        }

        function addFoodToCombo(foodId) {
            const food = foodDatabase.find(f => f.id === foodId);
            if (!food) return;

            // Check if already added
            const existing = newComboItems.find(item => item.foodId === foodId);
            if (existing) {
                existing.quantity += 1;
            } else {
                newComboItems.push({
                    foodId: food.id,
                    foodName: food.name,
                    quantity: 1,
                    unit: food.unit,
                    serving: food.serving,
                    calories: food.calories,
                    protein: food.protein,
                    carbs: food.carbs,
                    fat: food.fat,
                    fiber: food.fiber || 0
                });
            }

            updateComboItemsList();
            updateComboTotals();

            // Clear search
            document.getElementById('comboFoodSearch').value = '';
            document.getElementById('comboFoodResults').innerHTML = '<div class="text-center text-slate-400 py-4 text-sm">Search for foods to add</div>';
        }

        function removeComboItem(index) {
            newComboItems.splice(index, 1);
            updateComboItemsList();
            updateComboTotals();
        }

        function updateComboItemQty(index, delta) {
            newComboItems[index].quantity += delta;
            if (newComboItems[index].quantity < 0.5) {
                newComboItems.splice(index, 1);
            }
            updateComboItemsList();
            updateComboTotals();
        }

        function updateComboItemsList() {
            const container = document.getElementById('comboFoodsList');
            const countEl = document.getElementById('comboItemCount');

            countEl.textContent = `${newComboItems.length} item${newComboItems.length !== 1 ? 's' : ''}`;

            if (newComboItems.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-slate-400 py-4 text-sm border-2 border-dashed border-slate-200 rounded-xl">
                        Add foods using search above
                    </div>
                `;
                return;
            }

            container.innerHTML = newComboItems.map((item, index) => `
                <div class="flex items-center justify-between p-2 bg-slate-50 rounded-lg">
                    <div class="flex-1 min-w-0">
                        <div class="text-sm font-medium text-slate-700 truncate">${escapeHtml(item.foodName)}</div>
                        <div class="text-xs text-slate-400">${Math.round(item.calories * item.quantity)} kcal ‚Ä¢ ${Math.round(item.protein * item.quantity)}g P</div>
                    </div>
                    <div class="flex items-center gap-1 ml-2">
                        <button onclick="updateComboItemQty(${parseInt(index)}, -0.5)" class="w-6 h-6 rounded bg-slate-200 hover:bg-slate-300 text-slate-600 text-sm font-bold">-</button>
                        <span class="text-sm font-medium w-8 text-center">${parseFloat(item.quantity)}</span>
                        <button onclick="updateComboItemQty(${parseInt(index)}, 0.5)" class="w-6 h-6 rounded bg-slate-200 hover:bg-slate-300 text-slate-600 text-sm font-bold">+</button>
                        <button onclick="removeComboItem(${parseInt(index)})" class="w-6 h-6 rounded bg-red-100 hover:bg-red-200 text-red-600 text-sm ml-1">√ó</button>
                    </div>
                </div>
            `).join('');
        }

        function updateComboTotals() {
            const totals = newComboItems.reduce((acc, item) => ({
                calories: acc.calories + (item.calories * item.quantity),
                protein: acc.protein + (item.protein * item.quantity),
                carbs: acc.carbs + (item.carbs * item.quantity),
                fat: acc.fat + (item.fat * item.quantity),
                fiber: acc.fiber + ((item.fiber || 0) * item.quantity)
            }), { calories: 0, protein: 0, carbs: 0, fat: 0, fiber: 0 });

            document.getElementById('comboTotalCal').textContent = Math.round(totals.calories);
            document.getElementById('comboTotalProtein').textContent = Math.round(totals.protein) + 'g';
            document.getElementById('comboTotalCarbs').textContent = Math.round(totals.carbs) + 'g';
            document.getElementById('comboTotalFat').textContent = Math.round(totals.fat) + 'g';
            document.getElementById('comboTotalFiber').textContent = Math.round(totals.fiber) + 'g';
        }

        async function saveNewCombo() {
            const name = document.getElementById('comboName').value.trim();
            const category = document.getElementById('comboCategory').value;
            const tag = document.getElementById('comboTag').value || null;

            if (!name) {
                alert('Please enter a combo name');
                return;
            }

            if (newComboItems.length === 0) {
                alert('Please add at least one food to the combo');
                return;
            }

            // Calculate totals
            const totals = newComboItems.reduce((acc, item) => ({
                calories: acc.calories + (item.calories * item.quantity),
                protein: acc.protein + (item.protein * item.quantity),
                carbs: acc.carbs + (item.carbs * item.quantity),
                fat: acc.fat + (item.fat * item.quantity),
                fiber: acc.fiber + ((item.fiber || 0) * item.quantity)
            }), { calories: 0, protein: 0, carbs: 0, fat: 0, fiber: 0 });

            // Create combo object
            const comboData = {
                id: editingComboId || Date.now(), // Use existing ID if editing
                name: name,
                emoji: newComboEmoji,
                category: category,
                tag: tag,
                damageLevel: category === 'cheat' ? 'medium' : null,
                items: newComboItems.map(item => ({
                    foodId: item.foodId,
                    foodName: item.foodName,
                    quantity: item.quantity,
                    unit: item.unit,
                    calories: Math.round(item.calories * item.quantity),
                    protein: Math.round(item.protein * item.quantity),
                    carbs: Math.round(item.carbs * item.quantity),
                    fat: Math.round(item.fat * item.quantity),
                    fiber: Math.round((item.fiber || 0) * item.quantity)
                })),
                totalCalories: Math.round(totals.calories),
                totalProtein: Math.round(totals.protein),
                totalCarbs: Math.round(totals.carbs),
                totalFat: Math.round(totals.fat),
                totalFiber: Math.round(totals.fiber)
            };

            // Close modal and show saving indicator
            closeCreateComboModal();
            showApiStatus('saving', editingComboId ? 'Updating combo...' : 'Saving combo...');

            // DATABASE-FIRST: Save to server first
            const result = await apiPost('saveMealCombo', { combo: comboData });

            if (result.success) {
                // Success - update local state
                if (editingComboId) {
                    const index = savedMealCombos.findIndex(c => c.id === editingComboId);
                    if (index > -1) {
                        savedMealCombos[index] = comboData;
                    }
                } else {
                    // Use server-assigned ID if available
                    if (result.id) comboData.id = result.id;
                    savedMealCombos.push(comboData);
                }

                // Re-render combos
                renderQuickCombos();
                showApiStatus('success', editingComboId ? 'Combo updated!' : 'Combo saved!');
            } else {
                showApiStatus('error', result.error || 'Failed to save combo');
                console.error('Save Combo API Error:', result);
            }

            // Reset editing state
            editingComboId = null;
        }

        // Load custom combos from database (with localStorage fallback)
        async function loadCustomCombos() {
            try {
                // Try to load from database first
                const result = await apiGet('getMealCombos', {});
                if (result.success && result.combos && result.combos.length > 0) {
                    // Filter out default combos (keep only custom ones with id > 1000 or from DB)
                    const dbCombos = result.combos.filter(c => c.id > 0);
                    savedMealCombos.push(...dbCombos);
                    // Cache to localStorage for offline use
                    localStorage.setItem('fitlife_custom_combos', JSON.stringify(dbCombos));
                    return;
                }
            } catch (error) {
                console.warn('Failed to load combos from server, using localStorage fallback:', error);
            }

            // Fallback to localStorage if database unavailable
            const customCombos = JSON.parse(localStorage.getItem('fitlife_custom_combos')) || [];
            savedMealCombos.push(...customCombos);
        }

        // ==================== WEIGHT MODAL ====================
        function openWeightModal() {
            document.getElementById('weightModal').classList.remove('hidden');
            document.getElementById('weightModal').classList.add('flex');
            document.getElementById('weightDate').value = selectedDate;
            if (weightHistory.length > 0) {
                document.getElementById('weightInput').value = weightHistory[weightHistory.length - 1].weight;
            }
        }

        function closeWeightModal() {
            document.getElementById('weightModal').classList.add('hidden');
            document.getElementById('weightModal').classList.remove('flex');
        }

        async function saveWeight() {
            if (!isEditMode) {
                showToast('Unlock edit mode to log weight', 'info');
                return;
            }
            const weight = parseFloat(document.getElementById('weightInput').value);
            const date = document.getElementById('weightDate').value;

            if (!weight || !date) return;

            // Close modal and show saving indicator
            closeWeightModal();
            showApiStatus('saving', 'Logging weight...');

            // DATABASE-FIRST: Save to server first
            const result = await apiPost('logWeight', { date, weight });

            if (result.success) {
                // Success - update local state
                const existing = weightHistory.findIndex(w => w.date === date);
                if (existing >= 0) {
                    weightHistory[existing].weight = weight;
                } else {
                    weightHistory.push({ date, weight });
                    weightHistory.sort((a, b) => new Date(a.date) - new Date(b.date));
                }

                updateWeightDisplay();
                updateGoalsDisplay();
                showApiStatus('success', 'Weight logged!');
            } else {
                // FAILED - Show clear error
                showApiStatus('error', result.error || 'Failed to log weight. Please try again.');
                console.error('Weight API Error:', result);
            }
        }

        // ==================== GOALS MODAL ====================
        function openGoalsModal() {
            document.getElementById('goalsModal').classList.remove('hidden');
            document.getElementById('goalsModal').classList.add('flex');

            document.getElementById('goalCaloriesInput').value = goals.calories;
            document.getElementById('goalProteinInput').value = goals.protein;
            document.getElementById('goalCarbsInput').value = goals.carbs;
            document.getElementById('goalFatInput').value = goals.fat;
            document.getElementById('goalFiberInput').value = goals.fiber;
            document.getElementById('goalWeightInput').value = goals.targetWeight;
        }

        function closeGoalsModal() {
            document.getElementById('goalsModal').classList.add('hidden');
            document.getElementById('goalsModal').classList.remove('flex');
        }

        async function saveGoals() {
            if (!isEditMode) {
                showToast('Unlock edit mode to save goals', 'info');
                return;
            }

            const newGoals = {
                calories: parseInt(document.getElementById('goalCaloriesInput').value) || 1300,
                protein: parseInt(document.getElementById('goalProteinInput').value) || 80,
                carbs: parseInt(document.getElementById('goalCarbsInput').value) || 180,
                fat: parseInt(document.getElementById('goalFatInput').value) || 45,
                fiber: parseInt(document.getElementById('goalFiberInput').value) || 25,
                targetWeight: parseFloat(document.getElementById('goalWeightInput').value) || 65
            };

            // Close modal and show saving indicator
            closeGoalsModal();
            showApiStatus('saving', 'Saving goals...');

            // DATABASE-FIRST: Save to server first
            const result = await apiPost('updateGoals', { goals: newGoals });

            if (result.success) {
                // Success - update local state
                goals = newGoals;
                updateGoalsDisplay();
                updateMacroDisplay();
                showApiStatus('success', 'Goals saved!');
            } else {
                // FAILED - Show clear error
                showApiStatus('error', result.error || 'Failed to save goals. Please try again.');
                console.error('Goals API Error:', result);
            }
        }

        // ==================== EDIT MODE ====================
        function toggleEditMode() {
            if (isEditMode) {
                // Lock (exit edit mode)
                lockEditMode();
            } else {
                // Show password modal
                openPasswordModal();
            }
        }

        function openPasswordModal() {
            document.getElementById('passwordModal').classList.remove('hidden');
            document.getElementById('passwordModal').classList.add('flex');
            document.getElementById('editPasswordInput').value = '';
            document.getElementById('passwordError').classList.add('hidden');
            document.getElementById('editPasswordInput').focus();
        }

        function closePasswordModal() {
            document.getElementById('passwordModal').classList.add('hidden');
            document.getElementById('passwordModal').classList.remove('flex');
        }

        async function verifyEditPassword() {
            const password = document.getElementById('editPasswordInput').value;
            if (!password) return;

            try {
                const result = await apiPost('verifyEditPassword', { password });
                if (result.valid) {
                    isEditMode = true;
                    editToken = result.token || 'valid'; // Store token if provided
                    localStorage.setItem('fitlife_edit_mode', 'true');
                    // Use sessionStorage for token (cleared on browser close) with 4-hour expiry
                    sessionStorage.setItem('fitlife_edit_token', editToken);
                    sessionStorage.setItem('fitlife_edit_token_expiry', String(Date.now() + 4 * 60 * 60 * 1000));
                    closePasswordModal();
                    updateEditModeUI();
                    showToast('Edit mode unlocked!', 'success');
                } else {
                    document.getElementById('passwordError').classList.remove('hidden');
                    document.getElementById('editPasswordInput').select();
                }
            } catch (error) {
                console.error('Password verification error:', error);
                document.getElementById('passwordError').textContent = 'Connection error. Please try again.';
                document.getElementById('passwordError').classList.remove('hidden');
            }
        }

        function lockEditMode() {
            isEditMode = false;
            editToken = null;
            localStorage.removeItem('fitlife_edit_mode');
            sessionStorage.removeItem('fitlife_edit_token');
            sessionStorage.removeItem('fitlife_edit_token_expiry');
            updateEditModeUI();
            showToast('Edit mode locked', 'info');
        }

        function updateEditModeUI() {
            const toggle = document.getElementById('editModeToggle');
            const lockIcon = document.getElementById('editModeLockIcon');

            if (isEditMode) {
                // Unlocked state - green background, open lock icon
                toggle.classList.remove('bg-slate-100', 'hover:bg-slate-200', 'text-slate-500');
                toggle.classList.add('bg-emerald-500', 'hover:bg-emerald-600', 'text-white');
                lockIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 11V7a4 4 0 118 0m-4 8v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2z"></path>';
            } else {
                // Locked state - gray background, closed lock icon
                toggle.classList.add('bg-slate-100', 'hover:bg-slate-200', 'text-slate-500');
                toggle.classList.remove('bg-emerald-500', 'hover:bg-emerald-600', 'text-white');
                lockIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>';
            }

            // Show/hide edit-only elements
            document.querySelectorAll('.edit-only').forEach(el => {
                el.style.display = isEditMode ? '' : 'none';
            });

            // Enable/disable edit inputs
            document.querySelectorAll('.edit-input').forEach(el => {
                el.disabled = !isEditMode;
            });
        }

        // Change Password Modal Functions
        function openChangePasswordModal() {
            document.getElementById('changePasswordModal').classList.remove('hidden');
            document.getElementById('changePasswordModal').classList.add('flex');
            document.getElementById('currentPasswordInput').value = '';
            document.getElementById('newPasswordInput').value = '';
            document.getElementById('confirmPasswordInput').value = '';
            document.getElementById('changePasswordError').classList.add('hidden');
            document.getElementById('changePasswordSuccess').classList.add('hidden');
        }

        function closeChangePasswordModal() {
            document.getElementById('changePasswordModal').classList.add('hidden');
            document.getElementById('changePasswordModal').classList.remove('flex');
        }

        async function changePassword() {
            const currentPassword = document.getElementById('currentPasswordInput').value;
            const newPassword = document.getElementById('newPasswordInput').value;
            const confirmPassword = document.getElementById('confirmPasswordInput').value;

            // Validate
            if (!currentPassword || !newPassword || !confirmPassword) {
                showPasswordError('Please fill in all fields');
                return;
            }

            if (newPassword !== confirmPassword) {
                showPasswordError('New passwords do not match');
                return;
            }

            if (newPassword.length < 6) {
                showPasswordError('New password must be at least 6 characters');
                return;
            }

            try {
                const result = await apiPost('changeEditPassword', {
                    currentPassword,
                    newPassword
                });

                if (result.success) {
                    document.getElementById('changePasswordError').classList.add('hidden');
                    document.getElementById('changePasswordSuccess').classList.remove('hidden');
                    setTimeout(() => {
                        closeChangePasswordModal();
                    }, 1500);
                } else {
                    showPasswordError(result.error || 'Failed to change password');
                }
            } catch (error) {
                showPasswordError('Connection error. Please try again.');
            }
        }

        function showPasswordError(message) {
            const errorEl = document.getElementById('changePasswordError');
            errorEl.textContent = message;
            errorEl.classList.remove('hidden');
            document.getElementById('changePasswordSuccess').classList.add('hidden');
        }

        // Check edit mode validity on load
        async function checkEditModeOnLoad() {
            if (isEditMode && editToken) {
                // Verify token is still valid
                try {
                    const result = await apiPost('verifyEditPassword', { token: editToken });
                    if (!result.valid) {
                        // Token invalid, reset edit mode
                        isEditMode = false;
                        editToken = null;
                        localStorage.removeItem('fitlife_edit_mode');
                        sessionStorage.removeItem('fitlife_edit_token');
                        sessionStorage.removeItem('fitlife_edit_token_expiry');
                    }
                } catch (error) {
                    // Network error, keep local state
                    console.log('Could not verify edit mode, keeping local state');
                }
            }
            updateEditModeUI();
        }

        // ==================== WORKOUT EDITOR ====================
        let editingWorkoutType = null;
        let editingExercises = [];
        let editingExerciseIndex = null;

        async function openWorkoutEditor() {
            if (!isEditMode) {
                showToast('Unlock edit mode to edit workouts', 'info');
                return;
            }

            // Get current workout type
            const dayOfWeek = (new Date().getDay() + 6) % 7;
            editingWorkoutType = workoutSchedule[dayOfWeek]?.type || 'push';

            document.getElementById('workoutEditorTitle').textContent = `‚úèÔ∏è Edit ${workoutSchedule[dayOfWeek]?.name || 'Workout'}`;

            // Load exercises from database
            try {
                const result = await apiPost('getWorkoutExercises', { workoutType: editingWorkoutType });
                if (result.success && result.exercises) {
                    editingExercises = result.exercises;
                } else {
                    // Fall back to local workoutData
                    editingExercises = workoutDetails[editingWorkoutType]?.exercises?.map((ex, i) => ({
                        id: null,
                        exercise_order: i + 1,
                        name: ex.name,
                        sets: ex.sets,
                        reps: ex.reps,
                        rest: ex.rest,
                        notes: ex.notes,
                        calories: ex.calories,
                        is_challenge: ex.isChallenge ? 1 : 0,
                        pr_type: ex.prType,
                        pr_unit: ex.prUnit,
                        is_rest: ex.isRest ? 1 : 0,
                        is_optional: ex.isOptional ? 1 : 0
                    })) || [];
                }
            } catch (error) {
                console.error('Error loading exercises:', error);
                editingExercises = [];
            }

            renderExerciseEditorList();
            document.getElementById('workoutEditorModal').classList.remove('hidden');
            document.getElementById('workoutEditorModal').classList.add('flex');
        }

        function closeWorkoutEditor() {
            document.getElementById('workoutEditorModal').classList.add('hidden');
            document.getElementById('workoutEditorModal').classList.remove('flex');
            editingWorkoutType = null;
            editingExercises = [];
        }

        function renderExerciseEditorList() {
            const container = document.getElementById('exerciseEditorList');
            if (!editingExercises.length) {
                container.innerHTML = `
                    <div class="text-center py-8 text-slate-400">
                        <p>No exercises yet</p>
                        <p class="text-sm">Click "Add Exercise" to get started</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = editingExercises.map((ex, index) => `
                <div class="flex items-center gap-3 p-3 bg-slate-50 rounded-xl hover:bg-slate-100 transition-colors">
                    <div class="flex flex-col gap-1">
                        <button onclick="moveExercise(${index}, -1)" class="p-1 text-slate-400 hover:text-slate-600 ${index === 0 ? 'opacity-30 cursor-not-allowed' : ''}" ${index === 0 ? 'disabled' : ''}>
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path></svg>
                        </button>
                        <button onclick="moveExercise(${index}, 1)" class="p-1 text-slate-400 hover:text-slate-600 ${index === editingExercises.length - 1 ? 'opacity-30 cursor-not-allowed' : ''}" ${index === editingExercises.length - 1 ? 'disabled' : ''}>
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                    </div>
                    <div class="flex-1">
                        <div class="font-medium text-slate-800 ${ex.is_rest ? 'text-slate-500 italic' : ''}">${ex.name}</div>
                        <div class="text-sm text-slate-500">${ex.sets} √ó ${ex.reps} ${ex.rest !== '‚Äî' ? '‚Ä¢ Rest: ' + ex.rest : ''}</div>
                    </div>
                    <div class="flex gap-2">
                        ${ex.is_challenge ? '<span class="text-xs px-2 py-1 bg-orange-100 text-orange-600 rounded-full">Challenge</span>' : ''}
                        ${ex.is_optional ? '<span class="text-xs px-2 py-1 bg-green-100 text-green-600 rounded-full">Optional</span>' : ''}
                    </div>
                    <button onclick="editExercise(${index})" class="p-2 text-slate-400 hover:text-blue-500 transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                    </button>
                    <button onclick="deleteExerciseFromList(${index})" class="p-2 text-slate-400 hover:text-red-500 transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    </button>
                </div>
            `).join('');
        }

        function moveExercise(index, direction) {
            const newIndex = index + direction;
            if (newIndex < 0 || newIndex >= editingExercises.length) return;

            const temp = editingExercises[index];
            editingExercises[index] = editingExercises[newIndex];
            editingExercises[newIndex] = temp;

            // Update exercise_order
            editingExercises.forEach((ex, i) => ex.exercise_order = i + 1);

            renderExerciseEditorList();
        }

        // Track current exercise type in the form
        let currentExerciseType = 'strength';

        function setExerciseType(type) {
            currentExerciseType = type;
            const strengthBtn = document.getElementById('typeStrengthBtn');
            const cardioBtn = document.getElementById('typeCardioBtn');
            const strengthFields = document.getElementById('strengthFields');
            const cardioFields = document.getElementById('cardioFields');
            const restFieldContainer = document.getElementById('restFieldContainer');

            if (type === 'strength') {
                strengthBtn.className = 'flex-1 py-2 px-3 rounded-xl text-sm font-semibold transition-all bg-orange-500 text-white';
                cardioBtn.className = 'flex-1 py-2 px-3 rounded-xl text-sm font-semibold transition-all bg-slate-100 text-slate-600 hover:bg-slate-200';
                strengthFields.classList.remove('hidden');
                cardioFields.classList.add('hidden');
                restFieldContainer.classList.remove('hidden');
            } else {
                cardioBtn.className = 'flex-1 py-2 px-3 rounded-xl text-sm font-semibold transition-all bg-green-500 text-white';
                strengthBtn.className = 'flex-1 py-2 px-3 rounded-xl text-sm font-semibold transition-all bg-slate-100 text-slate-600 hover:bg-slate-200';
                strengthFields.classList.add('hidden');
                cardioFields.classList.remove('hidden');
                restFieldContainer.classList.add('hidden');
            }
        }

        function addNewExercise() {
            editingExerciseIndex = null;
            document.getElementById('exerciseEditTitle').textContent = 'Add Exercise';
            document.getElementById('exerciseNameInput').value = '';
            document.getElementById('exerciseSetsInput').value = '3';
            document.getElementById('exerciseRepsInput').value = '10-15';
            document.getElementById('exerciseDurationInput').value = '';
            document.getElementById('exerciseDistanceInput').value = '';
            document.getElementById('exerciseRestInput').value = '30s';
            document.getElementById('exerciseCaloriesInput').value = '30';
            document.getElementById('exerciseNotesInput').value = '';
            document.getElementById('exerciseIsChallengeInput').checked = false;
            document.getElementById('exerciseIsRestInput').checked = false;
            document.getElementById('exerciseIsOptionalInput').checked = false;
            document.getElementById('prTypeSection').classList.add('hidden');
            setExerciseType('strength');

            document.getElementById('exerciseEditModal').classList.remove('hidden');
            document.getElementById('exerciseEditModal').classList.add('flex');
        }

        function editExercise(index) {
            editingExerciseIndex = index;
            const ex = editingExercises[index];

            document.getElementById('exerciseEditTitle').textContent = 'Edit Exercise';
            document.getElementById('exerciseNameInput').value = ex.name || '';
            document.getElementById('exerciseCaloriesInput').value = ex.calories || '';
            document.getElementById('exerciseNotesInput').value = ex.notes || '';
            document.getElementById('exerciseIsChallengeInput').checked = ex.is_challenge == 1;
            document.getElementById('exerciseIsRestInput').checked = ex.is_rest == 1;
            document.getElementById('exerciseIsOptionalInput').checked = ex.is_optional == 1;

            // Detect if this is a cardio exercise (sets is '‚Äî' or reps contains 'min')
            const isCardio = ex.sets === '‚Äî' || ex.sets === '-' || (ex.reps && ex.reps.includes('min'));

            if (isCardio) {
                setExerciseType('cardio');
                document.getElementById('exerciseDurationInput').value = ex.reps || '';
                document.getElementById('exerciseDistanceInput').value = ex.distance || '';
                document.getElementById('exerciseSetsInput').value = '';
                document.getElementById('exerciseRepsInput').value = '';
            } else {
                setExerciseType('strength');
                document.getElementById('exerciseSetsInput').value = ex.sets || '';
                document.getElementById('exerciseRepsInput').value = ex.reps || '';
                document.getElementById('exerciseDurationInput').value = '';
                document.getElementById('exerciseDistanceInput').value = '';
            }
            document.getElementById('exerciseRestInput').value = ex.rest || '';

            if (ex.is_challenge == 1) {
                document.getElementById('prTypeSection').classList.remove('hidden');
                document.getElementById('exercisePrTypeInput').value = ex.pr_type || 'time';
            } else {
                document.getElementById('prTypeSection').classList.add('hidden');
            }

            document.getElementById('exerciseEditModal').classList.remove('hidden');
            document.getElementById('exerciseEditModal').classList.add('flex');
        }

        function closeExerciseEditModal() {
            document.getElementById('exerciseEditModal').classList.add('hidden');
            document.getElementById('exerciseEditModal').classList.remove('flex');
            editingExerciseIndex = null;
        }

        function saveExerciseEdit() {
            const name = document.getElementById('exerciseNameInput').value.trim();
            if (!name) {
                showToast('Please enter an exercise name', 'error');
                return;
            }

            const isChallenge = document.getElementById('exerciseIsChallengeInput').checked;
            const prType = isChallenge ? document.getElementById('exercisePrTypeInput').value : null;

            let sets, reps, rest, distance;

            if (currentExerciseType === 'cardio') {
                // Cardio exercise: use duration as reps, sets as '‚Äî'
                sets = '‚Äî';
                reps = document.getElementById('exerciseDurationInput').value || '20 min';
                rest = '‚Äî';
                distance = document.getElementById('exerciseDistanceInput').value || '';
            } else {
                // Strength exercise: use normal sets/reps
                sets = document.getElementById('exerciseSetsInput').value || '3';
                reps = document.getElementById('exerciseRepsInput').value || '10';
                rest = document.getElementById('exerciseRestInput').value || '30s';
                distance = '';
            }

            const exercise = {
                id: editingExerciseIndex !== null ? editingExercises[editingExerciseIndex].id : null,
                exercise_order: editingExerciseIndex !== null ? editingExercises[editingExerciseIndex].exercise_order : editingExercises.length + 1,
                name: name,
                sets: sets,
                reps: reps,
                rest: rest,
                distance: distance,
                notes: document.getElementById('exerciseNotesInput').value || '',
                calories: parseInt(document.getElementById('exerciseCaloriesInput').value) || 0,
                is_challenge: isChallenge ? 1 : 0,
                pr_type: prType,
                pr_unit: prType === 'time' ? 'seconds' : 'reps',
                is_rest: document.getElementById('exerciseIsRestInput').checked ? 1 : 0,
                is_optional: document.getElementById('exerciseIsOptionalInput').checked ? 1 : 0
            };

            if (editingExerciseIndex !== null) {
                editingExercises[editingExerciseIndex] = exercise;
            } else {
                editingExercises.push(exercise);
            }

            closeExerciseEditModal();
            renderExerciseEditorList();
        }

        function deleteExerciseFromList(index) {
            if (confirm('Delete this exercise?')) {
                editingExercises.splice(index, 1);
                editingExercises.forEach((ex, i) => ex.exercise_order = i + 1);
                renderExerciseEditorList();
            }
        }

        async function saveWorkoutChanges() {
            if (!editingWorkoutType || !editingExercises.length) {
                showToast('No exercises to save', 'error');
                return;
            }

            try {
                // Save all exercises (creates new, updates existing, deletes removed)
                const result = await apiPost('saveWorkout', {
                    workoutType: editingWorkoutType,
                    exercises: editingExercises
                });

                if (result.success) {
                    showToast('Workout saved successfully!', 'success');
                    closeWorkoutEditor();
                    // Reload workout data from server
                    await loadWorkoutData();
                    // Refresh workout display
                    renderTabContent();
                } else {
                    showToast(result.error || 'Failed to save workout', 'error');
                }
            } catch (error) {
                console.error('Error saving workout:', error);
                showToast('Connection error. Please try again.', 'error');
            }
        }

        // Toggle PR type section based on challenge checkbox
        document.addEventListener('DOMContentLoaded', () => {
            const challengeCheckbox = document.getElementById('exerciseIsChallengeInput');
            if (challengeCheckbox) {
                challengeCheckbox.addEventListener('change', function() {
                    document.getElementById('prTypeSection').classList.toggle('hidden', !this.checked);
                });
            }
        });

        // ==================== EXERCISE LIBRARY ====================
        let exerciseLibraryData = [];
        let exerciseLibraryCategories = [];
        let selectedLibraryExercise = null;
        let librarySearchTimeout = null;

        async function openExerciseLibrary() {
            document.getElementById('exerciseLibraryModal').classList.remove('hidden');
            document.getElementById('exerciseLibraryModal').classList.add('flex');
            document.getElementById('librarySearchInput').value = '';

            // Load categories and exercises
            await loadExerciseLibraryCategories();
            await loadExerciseLibrary();
        }

        function closeExerciseLibrary() {
            document.getElementById('exerciseLibraryModal').classList.add('hidden');
            document.getElementById('exerciseLibraryModal').classList.remove('flex');
        }

        async function loadExerciseLibraryCategories() {
            try {
                const result = await apiPost('getExerciseLibraryCategories', {});
                if (result.success && result.categories) {
                    exerciseLibraryCategories = result.categories;
                    const select = document.getElementById('libraryCategoryFilter');
                    select.innerHTML = '<option value="all">All Categories</option>' +
                        exerciseLibraryCategories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
                }
            } catch (error) {
                console.error('Error loading categories:', error);
            }
        }

        async function loadExerciseLibrary(category = 'all', search = '') {
            try {
                const result = await apiPost('getExerciseLibrary', { category, search });
                if (result.success && result.exercises) {
                    exerciseLibraryData = result.exercises;
                    renderExerciseLibraryList();
                }
            } catch (error) {
                console.error('Error loading exercise library:', error);
                document.getElementById('exerciseLibraryList').innerHTML = `
                    <div class="text-center py-8 text-red-400">
                        <p>Error loading exercises</p>
                    </div>
                `;
            }
        }

        function searchExerciseLibrary() {
            clearTimeout(librarySearchTimeout);
            librarySearchTimeout = setTimeout(() => {
                const search = document.getElementById('librarySearchInput').value.trim();
                const category = document.getElementById('libraryCategoryFilter').value;
                loadExerciseLibrary(category, search);
            }, 300);
        }

        function filterExerciseLibrary() {
            const search = document.getElementById('librarySearchInput').value.trim();
            const category = document.getElementById('libraryCategoryFilter').value;
            loadExerciseLibrary(category, search);
        }

        function renderExerciseLibraryList() {
            const container = document.getElementById('exerciseLibraryList');

            if (!exerciseLibraryData.length) {
                container.innerHTML = `
                    <div class="text-center py-8 text-slate-400">
                        <p>No exercises found</p>
                        <p class="text-sm">Try adjusting your search or filters</p>
                    </div>
                `;
                return;
            }

            // Group by category
            const grouped = {};
            exerciseLibraryData.forEach(ex => {
                if (!grouped[ex.category]) grouped[ex.category] = [];
                grouped[ex.category].push(ex);
            });

            const categoryColors = {
                'Chest': 'bg-red-100 text-red-600',
                'Back': 'bg-blue-100 text-blue-600',
                'Shoulders': 'bg-purple-100 text-purple-600',
                'Biceps': 'bg-pink-100 text-pink-600',
                'Triceps': 'bg-indigo-100 text-indigo-600',
                'Legs': 'bg-green-100 text-green-600',
                'Core': 'bg-orange-100 text-orange-600',
                'Cardio': 'bg-cyan-100 text-cyan-600',
                'Full Body': 'bg-amber-100 text-amber-600'
            };

            const difficultyColors = {
                'Beginner': 'bg-green-100 text-green-600',
                'Intermediate': 'bg-yellow-100 text-yellow-600',
                'Advanced': 'bg-red-100 text-red-600'
            };

            let html = '';
            for (const [category, exercises] of Object.entries(grouped)) {
                html += `<div class="mb-3">
                    <h4 class="text-sm font-semibold text-slate-500 mb-2">${category} (${exercises.length})</h4>
                    <div class="space-y-2">`;

                exercises.forEach(ex => {
                    const catColor = categoryColors[ex.category] || 'bg-slate-100 text-slate-600';
                    const diffColor = difficultyColors[ex.difficulty] || 'bg-slate-100 text-slate-600';

                    html += `
                        <div class="flex items-center gap-3 p-3 bg-slate-50 rounded-xl hover:bg-slate-100 transition-colors cursor-pointer" onclick="showExerciseDetail(${parseInt(ex.id)})">
                            <div class="flex-1">
                                <div class="font-medium text-slate-800">${escapeHtml(ex.name)}</div>
                                <div class="text-xs text-slate-500">${escapeHtml(ex.primaryMuscles || '')} ${ex.equipment ? '‚Ä¢ ' + escapeHtml(ex.equipment) : ''}</div>
                            </div>
                            <div class="flex gap-2 flex-wrap justify-end">
                                <span class="text-xs px-2 py-1 ${diffColor} rounded-full">${escapeHtml(ex.difficulty)}</span>
                            </div>
                            <button onclick="event.stopPropagation(); quickAddFromLibrary(${parseInt(ex.id)})" class="p-2 text-green-500 hover:text-green-600 hover:bg-green-50 rounded-lg transition-colors" title="Quick add">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                            </button>
                        </div>
                    `;
                });

                html += '</div></div>';
            }

            container.innerHTML = html;
        }

        function showExerciseDetail(exerciseId) {
            const ex = exerciseLibraryData.find(e => e.id === exerciseId);
            if (!ex) return;

            selectedLibraryExercise = ex;

            document.getElementById('exerciseDetailName').textContent = ex.name;
            document.getElementById('exerciseDetailCategory').textContent = ex.category;
            document.getElementById('exerciseDetailDifficulty').textContent = ex.difficulty;
            document.getElementById('exerciseDetailType').textContent = ex.type || 'Exercise';
            document.getElementById('exerciseDetailMuscles').textContent = ex.primaryMuscles || 'N/A';
            document.getElementById('exerciseDetailSecondary').textContent = ex.secondaryMuscles ? `Also works: ${ex.secondaryMuscles}` : '';
            document.getElementById('exerciseDetailEquipment').textContent = ex.equipment || 'None';
            document.getElementById('exerciseDetailSets').textContent = ex.setsRecommended || '3';
            document.getElementById('exerciseDetailReps').textContent = ex.repsRecommended || '10-12';
            document.getElementById('exerciseDetailRest').textContent = ex.restSeconds ? `${ex.restSeconds}s` : '60s';
            document.getElementById('exerciseDetailInstructions').textContent = ex.instructions || 'No instructions available';
            document.getElementById('exerciseDetailTips').textContent = ex.tips || 'No tips available';

            document.getElementById('exerciseDetailModal').classList.remove('hidden');
            document.getElementById('exerciseDetailModal').classList.add('flex');
        }

        function closeExerciseDetail() {
            document.getElementById('exerciseDetailModal').classList.add('hidden');
            document.getElementById('exerciseDetailModal').classList.remove('flex');
            selectedLibraryExercise = null;
        }

        function addExerciseFromLibrary() {
            if (!selectedLibraryExercise) return;

            const ex = selectedLibraryExercise;
            const caloriesPerExercise = Math.round((ex.caloriesPer30Min || 100) / 6); // Rough estimate per exercise

            const exercise = {
                id: null,
                exercise_order: editingExercises.length + 1,
                name: ex.name,
                sets: ex.setsRecommended || '3',
                reps: ex.repsRecommended || '10-12',
                rest: ex.restSeconds ? `${ex.restSeconds}s` : '60s',
                notes: ex.tips || '',
                calories: caloriesPerExercise,
                is_challenge: 0,
                pr_type: null,
                pr_unit: null,
                is_rest: 0,
                is_optional: 0
            };

            editingExercises.push(exercise);
            closeExerciseDetail();
            closeExerciseLibrary();
            renderExerciseEditorList();
            showToast(`Added "${ex.name}" to workout`, 'success');
        }

        function quickAddFromLibrary(exerciseId) {
            const ex = exerciseLibraryData.find(e => e.id === exerciseId);
            if (!ex) return;

            const caloriesPerExercise = Math.round((ex.caloriesPer30Min || 100) / 6);

            const exercise = {
                id: null,
                exercise_order: editingExercises.length + 1,
                name: ex.name,
                sets: ex.setsRecommended || '3',
                reps: ex.repsRecommended || '10-12',
                rest: ex.restSeconds ? `${ex.restSeconds}s` : '60s',
                notes: ex.tips || '',
                calories: caloriesPerExercise,
                is_challenge: 0,
                pr_type: null,
                pr_unit: null,
                is_rest: 0,
                is_optional: 0
            };

            editingExercises.push(exercise);
            renderExerciseEditorList();
            showToast(`Added "${ex.name}"`, 'success');
        }

        // ==================== WATER TRACKER ====================
        let waterCount = 0;

        // Adjust water with +/- buttons - DATABASE-FIRST
        async function adjustWater(delta) {
            if (!isEditMode) {
                showToast('Unlock edit mode to modify water intake', 'info');
                return;
            }

            const newCount = Math.max(0, Math.min(20, waterCount + delta)); // Cap at 0-20 glasses (5L)
            if (newCount === waterCount) return; // No change

            // DATABASE-FIRST: Save to server first
            try {
                const result = await apiPost('logWater', {
                    date: selectedDate,
                    increment: delta
                });

                if (result.success) {
                    // Success - update UI with server's confirmed value
                    waterCount = result.glasses;
                    updateWaterDisplay(true); // Animate the wave
                    updateStreakDisplay();
                } else {
                    // FAILED - Show clear error, don't update UI
                    showApiStatus('error', result.error || 'Failed to save water intake');
                }
            } catch (error) {
                console.error('Water save error:', error);
                showApiStatus('error', 'Failed to save water intake');
            }
        }

        function updateWaterDisplay(animate = false) {
            const ml = waterCount * 250;
            const pct = Math.min(100, (ml / 2000) * 100);

            // Update main water tracker section
            const waterDisplayEl = document.getElementById('waterDisplay');
            if (waterDisplayEl) {
                waterDisplayEl.textContent = ml;
            }

            // Update water waves (height controls how much water shows)
            const waterWaves = document.getElementById('waterWaves');
            if (waterWaves) {
                waterWaves.style.height = `${pct}%`;

                // Speed up waves briefly on change
                if (animate) {
                    waterWaves.classList.add('animating');
                    setTimeout(() => waterWaves.classList.remove('animating'), 500);
                }
            }

            // Update water ring in Today's Progress
            const waterCurrentMl = document.getElementById('waterCurrentMl');
            if (waterCurrentMl) {
                waterCurrentMl.textContent = ml;
            }

            const waterRing = document.getElementById('waterRing');
            if (waterRing) {
                const circumference = 220;
                const offset = circumference - (pct / 100) * circumference;
                waterRing.style.strokeDashoffset = offset;
            }
        }

        async function loadWater() {
            // Try to load from database first
            try {
                const result = await apiGet('getWater', { date: selectedDate });
                if (result.success && typeof result.glasses !== 'undefined') {
                    waterCount = result.glasses;
                    localStorage.setItem(`fitlife_water_${selectedDate}`, waterCount);
                    updateWaterDisplay();
                    return;
                }
            } catch (error) {
                console.log('Water API failed, falling back to localStorage');
            }
            // Fallback to localStorage
            waterCount = parseInt(localStorage.getItem(`fitlife_water_${selectedDate}`)) || 0;
            updateWaterDisplay();
        }

        // ==================== STREAK TRACKING ====================
        function hasActivityOnDate(dateStr) {
            // Check for meals
            const mealTypes = ['breakfast', 'lunch', 'dinner', 'snacks', 'preworkout', 'postworkout'];
            for (const mealType of mealTypes) {
                const meals = JSON.parse(localStorage.getItem(`fitlife_meals_${dateStr}_${mealType}`)) || [];
                if (meals.length > 0) return true;
            }

            // Check for water
            const water = parseInt(localStorage.getItem(`fitlife_water_${dateStr}`)) || 0;
            if (water > 0) return true;

            // Check for exercises
            const workout = getWorkoutForDate(dateStr);
            const workoutData = workoutDetails[workout.type];
            if (workoutData && workoutData.exercises) {
                for (let i = 0; i < workoutData.exercises.length; i++) {
                    if (exerciseChecks[`${dateStr}-${i}`]) return true;
                }
            }

            return false;
        }

        function calculateStreak() {
            let streak = 0;
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            // Start from today and go backwards
            for (let i = 0; i < 365; i++) { // Max 365 days check
                const checkDate = new Date(today);
                checkDate.setDate(checkDate.getDate() - i);
                const dateStr = checkDate.toISOString().split('T')[0];

                if (hasActivityOnDate(dateStr)) {
                    streak++;
                } else if (i > 0) {
                    // Break on first inactive day (but not today - user might not have logged yet)
                    break;
                }
            }

            return streak;
        }

        // Global streak variable that gets updated from database
        let currentStreak = 0;

        async function updateStreakDisplay() {
            try {
                // Fetch streak from database
                const result = await apiGet('getStreak', {});
                if (result.success) {
                    currentStreak = result.streak;
                }
            } catch (error) {
                // Fallback to local calculation if API fails
                currentStreak = calculateStreak();
            }

            const streakEl = document.getElementById('streakCount');
            if (streakEl) {
                streakEl.textContent = currentStreak;
            }
        }

        // ==================== EXERCISE TRACKING ====================
        async function toggleExercise(dateKey, index) {
            if (!isEditMode) {
                showToast('Unlock edit mode to track exercises', 'info');
                return;
            }
            const key = `${dateKey}-${index}`;
            const newValue = !exerciseChecks[key];

            // DATABASE-FIRST: Save to server first
            const result = await apiPost('logExercise', {
                date: dateKey,
                exerciseIndex: index,
                completed: newValue
            });

            if (result.success) {
                // Success - update local state
                exerciseChecks[key] = newValue;
                renderTabContent();
                updateStreakDisplay();
            } else {
                showApiStatus('error', result.error || 'Failed to save exercise');
                console.error('Exercise API Error:', result);
            }
        }

        // ==================== PR MODAL ====================
        function openPrModal(exerciseName, prType, prUnit, forceUpdate = false) {
            currentPrExercise = { name: exerciseName, type: prType, unit: prUnit, forceUpdate: forceUpdate };
            document.getElementById('prModal').classList.remove('hidden');
            document.getElementById('prModal').classList.add('flex');
            document.getElementById('prExerciseName').textContent = forceUpdate ? `Edit: ${exerciseName}` : exerciseName;
            document.getElementById('prLabel').textContent = prType === 'time' ? 'Time (seconds)' : 'Reps completed';
            document.getElementById('prInput').value = prLog[exerciseName]?.value || '';
            document.getElementById('prInput').placeholder = prType === 'time' ? '300' : '45';
        }

        function closePrModal() {
            document.getElementById('prModal').classList.add('hidden');
            document.getElementById('prModal').classList.remove('flex');
            currentPrExercise = null;
        }

        async function savePr() {
            if (!isEditMode) {
                showToast('Unlock edit mode to save PR', 'info');
                return;
            }
            if (!currentPrExercise) return;
            const value = parseInt(document.getElementById('prInput').value);

            if (!value) return;

            const prDate = new Date(selectedDate);
            const achievedDate = prDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            const existing = prLog[currentPrExercise.name];
            const isBetter = !existing ||
                (currentPrExercise.type === 'time' && value < existing.value) ||
                (currentPrExercise.type === 'reps' && value > existing.value);

            // Close modal and show saving indicator
            closePrModal();
            showApiStatus('saving', 'Saving PR...');

            // DATABASE-FIRST: Save to server first
            const result = await apiPost('logPR', {
                exerciseName: currentPrExercise.name,
                value: value,
                prType: currentPrExercise.type,
                achievedDate: achievedDate
            });

            if (result.success) {
                // Success - update local state
                const todayKey = `${selectedDate}-${currentPrExercise.name}`;
                dailyPrAttempts[todayKey] = {
                    value,
                    type: currentPrExercise.type
                };

                if (isBetter || currentPrExercise.forceUpdate) {
                    prLog[currentPrExercise.name] = {
                        value,
                        date: achievedDate,
                        type: currentPrExercise.type
                    };

                    // Celebrate new PR!
                    if (isBetter && typeof confetti !== 'undefined') {
                        confetti({ particleCount: 50, spread: 60, origin: { y: 0.7 } });
                    }
                    showApiStatus('success', 'New PR! üéâ');
                } else {
                    showApiStatus('success', 'Time logged!');
                }

                renderTabContent();
            } else {
                showApiStatus('error', result.error || 'Failed to save PR');
                console.error('PR API Error:', result);
            }
        }

        // ==================== LOAD EXERCISE & PR DATA ====================
        async function loadExerciseData() {
            try {
                // Load ALL exercise logs (last 60 days) from database
                const result = await apiGet('getAllExerciseLogs', {});
                if (result.success && result.exercises) {
                    // Replace with database data (database is source of truth)
                    exerciseChecks = result.exercises;
                    localStorage.setItem('fitlife_exercises', JSON.stringify(exerciseChecks));
                }
            } catch (error) {
                // Fallback to localStorage if offline
                const cached = localStorage.getItem('fitlife_exercises');
                if (cached) {
                    exerciseChecks = JSON.parse(cached);
                }
                console.warn('Failed to load exercise data, using cache:', error);
            }
        }

        async function loadPRData() {
            try {
                const result = await apiGet('getPRLog');
                if (result.success && result.prs) {
                    // Replace with database data (database is source of truth)
                    prLog = result.prs;
                    localStorage.setItem('fitlife_prs', JSON.stringify(prLog));
                }
            } catch (error) {
                // Fallback to localStorage if offline
                const cached = localStorage.getItem('fitlife_prs');
                if (cached) {
                    prLog = JSON.parse(cached);
                }
                console.warn('Failed to load PR data, using cache:', error);
            }
        }

        async function loadDayTypes() {
            try {
                const result = await apiGet('getDayTypes');
                if (result.success && result.dayTypes) {
                    // Replace with database data (database is source of truth)
                    dayTypes = result.dayTypes;
                    localStorage.setItem('fitlife_day_types', JSON.stringify(dayTypes));
                }
            } catch (error) {
                // Fallback to localStorage if offline
                const cached = localStorage.getItem('fitlife_day_types');
                if (cached) {
                    dayTypes = JSON.parse(cached);
                }
                console.warn('Failed to load day types, using cache:', error);
            }
        }

        // ==================== KEYBOARD NAVIGATION ====================
        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

            if (e.key === 'ArrowRight') {
                if (currentDayIndex < 6) {
                    selectDay(currentDayIndex + 1);
                }
            } else if (e.key === 'ArrowLeft') {
                if (currentDayIndex > 0) {
                    selectDay(currentDayIndex - 1);
                }
            }
        });

        // ==================== EMBEDDED FOOD DATA (FALLBACK) ====================
        function getEmbeddedFoodData() {
            return [
                { id: 1, name: 'Boiled Egg', category: 'Protein', calories: 78, protein: 6, carbs: 0.5, fat: 5, fiber: 0, serving: 1, unit: 'pc' },
                { id: 2, name: 'Chicken Breast (grilled)', category: 'Protein', calories: 165, protein: 31, carbs: 0, fat: 4, fiber: 0, serving: 100, unit: 'g' },
                { id: 3, name: 'Paneer', category: 'Protein', calories: 265, protein: 18, carbs: 4, fat: 20, fiber: 0, serving: 100, unit: 'g' },
                { id: 4, name: 'Moong Dal', category: 'Protein', calories: 105, protein: 7, carbs: 18, fat: 0.5, fiber: 3, serving: 1, unit: 'katori' },
                { id: 5, name: 'Rice (cooked)', category: 'Grains', calories: 130, protein: 3, carbs: 28, fat: 0.5, fiber: 0.5, serving: 100, unit: 'g' },
                { id: 6, name: 'Chapati', category: 'Grains', calories: 104, protein: 3, carbs: 18, fat: 3, fiber: 2, serving: 1, unit: 'pc' },
                { id: 7, name: 'Curd', category: 'Dairy', calories: 100, protein: 4, carbs: 8, fat: 6, fiber: 0, serving: 100, unit: 'g' },
                { id: 8, name: 'Milk', category: 'Dairy', calories: 120, protein: 6, carbs: 9, fat: 7, fiber: 0, serving: 200, unit: 'ml' },
                { id: 9, name: 'Protein Powder', category: 'Supplements', calories: 130, protein: 24, carbs: 3, fat: 2, fiber: 0, serving: 1, unit: 'scoop' },
                { id: 10, name: 'Almonds', category: 'Nuts', calories: 70, protein: 3, carbs: 2, fat: 6, fiber: 1, serving: 10, unit: 'pcs' },
                { id: 11, name: 'Banana', category: 'Fruits', calories: 105, protein: 1, carbs: 27, fat: 0, fiber: 3, serving: 1, unit: 'medium' },
                { id: 12, name: 'Poha', category: 'Grains', calories: 160, protein: 3, carbs: 30, fat: 3, fiber: 1, serving: 1, unit: 'katori' },
                { id: 13, name: 'Rajma', category: 'Protein', calories: 140, protein: 9, carbs: 24, fat: 1, fiber: 6, serving: 1, unit: 'katori' },
                { id: 14, name: 'Chole', category: 'Protein', calories: 150, protein: 8, carbs: 26, fat: 3, fiber: 7, serving: 1, unit: 'katori' },
                { id: 15, name: 'Aloo Sabzi', category: 'Vegetables', calories: 120, protein: 2, carbs: 18, fat: 5, fiber: 2, serving: 1, unit: 'katori' }
            ];
        }

        // ==================== INITIALIZATION ====================
        async function init() {
            // Update date displays immediately
            document.getElementById('todayDate').textContent = formatDateDisplay(new Date().toISOString().split('T')[0]);
            updateWeekDisplay();
            updateMotivationBanner();

            // Load cached data first for instant UI
            const cachedFoods = localStorage.getItem('fitlife_foods_cache');
            if (cachedFoods) {
                foodDatabase = JSON.parse(cachedFoods);
            } else {
                foodDatabase = getEmbeddedFoodData();
            }

            // Load custom combos from database (async, with localStorage fallback)
            await loadCustomCombos();

            const cachedGoals = localStorage.getItem('fitlife_goals');
            if (cachedGoals) {
                goals = JSON.parse(cachedGoals);
                updateGoalsDisplay();
            }

            const cachedWeight = localStorage.getItem('fitlife_weight');
            if (cachedWeight) {
                weightHistory = JSON.parse(cachedWeight);
                updateWeightDisplay();
            }

            // Load cached daily data
            const cachedDaily = localStorage.getItem(`fitlife_meals_${selectedDate}`);
            if (cachedDaily) {
                const data = JSON.parse(cachedDaily);
                dailyMeals = data.meals || { breakfast: [], lunch: [], dinner: [], snacks: [], postworkout: [] };
                dailyTotals = data.totals || { calories: 0, protein: 0, carbs: 0, fat: 0, fiber: 0 };
                updateMacroDisplay();
            }

            // Render UI immediately with cached data
            renderTabContent();
            loadWater();
            updateStreakDisplay();

            // Initialize edit mode UI
            updateEditModeUI();

            // Hide any loading banner
            document.getElementById('connectionBanner').classList.add('hidden');

            // Fetch fresh data from database in background
            Promise.all([
                loadFoodDatabase(),
                loadGoals(),
                loadWeightHistory(),
                loadDailyData(),
                loadExerciseData(),
                loadPRData(),
                loadDayTypes(),
                loadWorkoutData()
            ]).then(() => {
                renderDayNav();
                renderTabContent();
                loadWater();
                updateStreakDisplay();

                // Sync recovery: check for unsynced items and process pending syncs
                syncUnsyncedItems();
                if (pendingSyncs.length > 0) {
                    console.log(`Found ${pendingSyncs.length} pending syncs, processing...`);
                    processPendingSyncs();
                }
                updatePendingSyncUI();
            });
        }

        // Sync items that don't have a database ID (failed during initial save)
        async function syncUnsyncedItems() {
            let addedToQueue = 0;

            // Check all meal types for items without ID
            for (const mealType of Object.keys(dailyMeals)) {
                const items = dailyMeals[mealType];
                if (!items || !Array.isArray(items)) continue;

                for (const item of items) {
                    // If item has no ID and isn't already in pendingSyncs, add it
                    if (!item.id) {
                        const mealItem = {
                            date: item.date || selectedDate,
                            mealType: item.mealType || mealType,
                            foodId: item.foodId,
                            foodName: item.foodName,
                            quantity: item.quantity,
                            unit: item.unit,
                            calories: item.calories,
                            protein: item.protein,
                            carbs: item.carbs,
                            fat: item.fat,
                            fiber: item.fiber
                        };

                        // Check if not already in queue
                        const exists = pendingSyncs.some(s =>
                            s.action === 'logMeal' &&
                            s.data.foodName === mealItem.foodName &&
                            s.data.date === mealItem.date &&
                            s.data.mealType === mealItem.mealType
                        );

                        if (!exists) {
                            addPendingSync('logMeal', mealItem);
                            addedToQueue++;
                        }
                    }
                }
            }

            if (addedToQueue > 0) {
                console.log(`Added ${addedToQueue} unsynced items to queue`);
                showToast(`Found ${addedToQueue} unsynced item(s). Syncing...`, 'info');
            }
        }

        // Check if API URL is configured
        if (API_URL === 'YOUR_GOOGLE_APPS_SCRIPT_URL_HERE') {
            console.warn('Google Apps Script URL not configured. Running in offline mode.');
            setOfflineMode(true);
        }

        init();
    </script>
</body>
</html>
